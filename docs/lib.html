<!DOCTYPE html>

<html>
<head>
  <title>lib.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
<a href="tricks.html">tricks</a>
::   <a href="think.html">think</a> 
:: &copy;2022, <a href="mailto:timm@ieee.org">Tim Menzies</a>
<hr><img 
align=right width=250 src=heads2.png>
<a 
href="https://zenodo.org/badge/latestdoi/206205826"> <img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> <img 
src="https://img.shields.io/badge/platform-osx,linux-informational?logo=linux&logoColor=white&color=red"> <img 
src="https://img.shields.io/badge/purpose-se,ai-informational?logo=hyper&logoColor=white&color=orange"> <img 
src="https://img.shields.io/badge/language-lua-informational?logo=lua&logoColor=white&color=yellow"> <a
href="https://github.com/timm/l5/actions/workflows/tests.yml"><img src="https://github.com/timm/l5/actions/workflows/tests.yml/badge.svg"></a><br><a
href="https://github.com/timm/l5/blob/master/LICENSE.md#top"><img src="https://img.shields.io/badge/license-BSD2-informational?logo=adblock&logoColor=white&color=blueviolet"></a>
<br>

                  <h1>lib.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> lib={}

<span class="hljs-keyword">local</span> r = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.normal</span><span class="hljs-params">(mu,sd)</span></span> 
  mu, sd = (mu <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>), (sd <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)
  <span class="hljs-keyword">return</span> mu + sd*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">-2</span>*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(r()))*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">cos</span>(<span class="hljs-number">6.2831853</span>*r()) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.per</span><span class="hljs-params">(t,p)</span></span> <span class="hljs-keyword">return</span> t[ ((p <span class="hljs-keyword">or</span> <span class="hljs-number">.5</span>)*#t) // <span class="hljs-number">1</span> ] <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.norm</span><span class="hljs-params">(lo,hi,x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(hi-lo)&lt;<span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x-lo)/(hi-lo) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.ent</span><span class="hljs-params">(t, n)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> n <span class="hljs-keyword">then</span> n=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> n=n+v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> e=<span class="hljs-number">0</span>;         <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> e=e-v/n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(v/n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> e,n <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.sd</span><span class="hljs-params">(sorted, f)</span></span>
  f=f <span class="hljs-keyword">or</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> denom = <span class="hljs-number">2.564</span> <span class="hljs-comment">-- 2*(1.2 + 0.1*(0.9-0.88493)/(0.9032-0.88493))</span>
  <span class="hljs-keyword">return</span> (f(per(sorted, <span class="hljs-number">.9</span>)) - f(per(sorted,<span class="hljs-number">.1</span>)))/denom <span class="hljs-keyword">end</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.cosine</span><span class="hljs-params">(a,b,c)</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(<span class="hljs-number">1</span>, (a^<span class="hljs-number">2</span>+c^<span class="hljs-number">2</span>-b^<span class="hljs-number">2</span>)/(<span class="hljs-number">2</span>*c+<span class="hljs-number">1E-32</span>))) <span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.ish</span><span class="hljs-params">(x,y,z)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) &lt;= (z <span class="hljs-keyword">or</span> <span class="hljs-number">0.001</span>) <span class="hljs-keyword">end</span>

              
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.inc</span><span class="hljs-params">(f,a,n)</span></span>      f=f <span class="hljs-keyword">or</span>{};f[a]=(f[a] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) + (n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)    <span class="hljs-keyword">return</span> f <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.inc2</span><span class="hljs-params">(f,a,b,n)</span></span>   f=f <span class="hljs-keyword">or</span>{};f[a]=lib.inc(f[a]  <span class="hljs-keyword">or</span> {},b,n); <span class="hljs-keyword">return</span> f <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.inc3</span><span class="hljs-params">(f,a,b,c,n)</span></span> f=f <span class="hljs-keyword">or</span>{};f[a]=lib.inc2(f[a] <span class="hljs-keyword">or</span>{},b,c,n);<span class="hljs-keyword">return</span> f <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.has</span><span class="hljs-params">(f,a)</span></span>      <span class="hljs-keyword">return</span> f[a]                        <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.has2</span><span class="hljs-params">(f,a,b)</span></span>   <span class="hljs-keyword">return</span> f[a] <span class="hljs-keyword">and</span> lib.has( f[a],b)   <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.has3</span><span class="hljs-params">(f,a,b,c)</span></span> <span class="hljs-keyword">return</span> f[a] <span class="hljs-keyword">and</span> lib.has2(f[a],b,c) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>


lib.<span class="hljs-built_in">unpack</span> = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.push</span><span class="hljs-params">(t,x)</span></span> t[<span class="hljs-number">1</span> + #t] = x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.powerset</span><span class="hljs-params">(s)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span><span class="hljs-params">(s)</span></span>
    <span class="hljs-keyword">local</span> t = {{}}
    <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, #s <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">for</span> j = <span class="hljs-number">1</span>, #t <span class="hljs-keyword">do</span>
        t[#t+<span class="hljs-number">1</span>] = {s[i], lib.<span class="hljs-built_in">unpack</span>(t[j])} <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> lib.<span class="hljs-built_in">sort</span>(fun(s), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> #a &lt; #b <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.merge</span><span class="hljs-params">(b4, merge)</span></span>
  <span class="hljs-keyword">local</span> j,n,tmp = <span class="hljs-number">1</span>,#b4,{}
  <span class="hljs-keyword">while</span> j&lt;=n <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> a, b = b4[j], b4[j+<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> b <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">local</span> c = merge(a, b) <span class="hljs-comment">-- returns nil if merge fails</span>
      <span class="hljs-keyword">if</span> c <span class="hljs-keyword">then</span>
        a,j = c,j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    tmp[#tmp+<span class="hljs-number">1</span>] = a
    j = j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> #tmp==#b4 <span class="hljs-keyword">and</span> tmp <span class="hljs-keyword">or</span> lib.merge(tmp,merge) <span class="hljs-keyword">end</span>



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.map</span><span class="hljs-params">(t, f, u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.collect</span><span class="hljs-params">(t,f,u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[k]=f(k,v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.copy</span><span class="hljs-params">(t,   u)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[lib.copy(k)] = lib.copy(v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.sort</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.upx</span><span class="hljs-params">(a,b)</span></span>   <span class="hljs-keyword">return</span> a.x &lt; b.x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.up1</span><span class="hljs-params">(a,b)</span></span>   <span class="hljs-keyword">return</span> a[<span class="hljs-number">1</span>] &lt; b[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.down1</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[<span class="hljs-number">1</span>] &gt; b[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.slots</span><span class="hljs-params">(t, u)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">public</span><span class="hljs-params">(k)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) ~= <span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">end</span>
  u={};<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> public(k) <span class="hljs-keyword">then</span> u[<span class="hljs-number">1</span>+#u]=k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> lib.<span class="hljs-built_in">sort</span>(u) <span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.settings</span><span class="hljs-params">(help)</span></span>
  <span class="hljs-keyword">local</span> d,used = {},{}
  help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n  ([-]([^%s]+))[%s]+(-[^%s]+)[^\n]*%s([^%s]+)&quot;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>e.g.    “  -bins -b  max.number of bins       = 16”
parses to ((-)(bins)) (-b) max number of bins = (16)
i.e.    (long (key)) (short)                   (x)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(long,key,short,x)</span></span>
      <span class="hljs-built_in">assert</span>(<span class="hljs-keyword">not</span> used[short], <span class="hljs-string">&quot;repeated short flag [&quot;</span>..short..<span class="hljs-string">&quot;]&quot;</span>)
      used[short]=short
      <span class="hljs-keyword">for</span> n,flag <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> 
        <span class="hljs-keyword">if</span> flag==short <span class="hljs-keyword">or</span> flag==long <span class="hljs-keyword">then</span>
          x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
      d[key] = lib.coerce(x) <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">if</span> d.help <span class="hljs-keyword">then</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(<span class="hljs-built_in">print</span>(help)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> d <span class="hljs-keyword">end</span>

lib.go = {_fails=<span class="hljs-number">0</span>}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.ok</span><span class="hljs-params">(test,msg)</span></span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>, test <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;PASS &quot;</span><span class="hljs-keyword">or</span> <span class="hljs-string">&quot;FAIL &quot;</span>,msg <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>) 
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> test <span class="hljs-keyword">then</span> 
    lib.go._fails= lib.go._fails+<span class="hljs-number">1</span> 
    <span class="hljs-keyword">if</span> the <span class="hljs-keyword">and</span> the.<span class="hljs-built_in">dump</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">assert</span>(test,msg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.main</span><span class="hljs-params">(the,go,b4,           resets,todos)</span></span>
  todos = the.todo == <span class="hljs-string">&quot;all&quot;</span> <span class="hljs-keyword">and</span> slots(go) <span class="hljs-keyword">or</span> {the.todo}
  resets={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(the) <span class="hljs-keyword">do</span> resets[k]=v <span class="hljs-keyword">end</span>
  go._fails = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(todos) <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed <span class="hljs-keyword">or</span> <span class="hljs-number">10019</span>)
    <span class="hljs-keyword">if</span> go[todo] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span>..todo); go[todo]() <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(resets) <span class="hljs-keyword">do</span> the[k]=v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> b4 <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(go._fails) <span class="hljs-keyword">end</span> 

                     
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.any</span><span class="hljs-params">(a,lo,hi)</span></span> 
  lo,hi = lo <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>, hi <span class="hljs-keyword">or</span> #a; <span class="hljs-keyword">return</span> a[ (lo+(hi-lo)*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>())//<span class="hljs-number">1</span> ] <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.many</span><span class="hljs-params">(a,n,lo,hi,  u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> j=<span class="hljs-number">1</span>,n <span class="hljs-keyword">do</span> lib.push(u, lib.any(a,lo,hi)) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.slice</span><span class="hljs-params">(a,lo,hi,    u)</span></span>
  u,lo,hi = {},lo <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>,hi <span class="hljs-keyword">or</span> #a; <span class="hljs-keyword">for</span> j=lo,hi <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=a[j] <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.words</span><span class="hljs-params">(s,sep,   t)</span></span>
  sep=<span class="hljs-string">&quot;([^&quot;</span> .. (sep <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;,&quot;</span>)  .. <span class="hljs-string">&quot;]+)&quot;</span>
  t={}; <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> s:<span class="hljs-built_in">gmatch</span>(sep) <span class="hljs-keyword">do</span> t[<span class="hljs-number">1</span>+#t] = y <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.coerces</span><span class="hljs-params">(s)</span></span> 
  <span class="hljs-keyword">return</span> lib.map(lib.words(s), lib.coerce) <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.coerce</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(x) ~= <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.items</span><span class="hljs-params">(src,f)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file</span><span class="hljs-params">(f)</span></span>
    src,f = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(src),(f <span class="hljs-keyword">or</span> lib.coerces)
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> x=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
             <span class="hljs-keyword">if</span> x <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> f(x) <span class="hljs-keyword">else</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(src) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tbl</span><span class="hljs-params">(   x)</span></span>
    x,f = <span class="hljs-number">0</span>, f <span class="hljs-keyword">or</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> z <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">if</span> x&lt; #src <span class="hljs-keyword">then</span> x=x+<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> f(src[x]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">if</span> src <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(src) == <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">and</span> file(f) <span class="hljs-keyword">or</span> tbl() <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>


lib.fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.oo</span><span class="hljs-params">(t, slots)</span></span> <span class="hljs-built_in">print</span>(lib.o(t,slots)) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.o</span><span class="hljs-params">(t,slots,   seen, u)</span></span>  
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t)~=<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  seen = seen <span class="hljs-keyword">or</span> {}
  <span class="hljs-keyword">if</span> seen[t] <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;...&quot;</span> <span class="hljs-keyword">end</span>
  seen[t] = t
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show1</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> lib.o(x, <span class="hljs-literal">nil</span>, seen) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show2</span><span class="hljs-params">(k)</span></span> <span class="hljs-keyword">return</span> lib.fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,k, lib.o(t[k], <span class="hljs-literal">nil</span>, seen)) <span class="hljs-keyword">end</span>
  u = #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> lib.map(t,show1) <span class="hljs-keyword">or</span> lib.map(slots <span class="hljs-keyword">or</span> lib.slots(t),show2)
  <span class="hljs-keyword">return</span> (t._is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>).. <span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(u,<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.dent</span><span class="hljs-params">(t,  seen,pre)</span></span>  
  pre,seen = pre <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, seen <span class="hljs-keyword">or</span> {}
  <span class="hljs-keyword">if</span> seen[t] <span class="hljs-keyword">then</span> t= <span class="hljs-string">&quot;...&quot;</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t)~=<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">print</span>(pre .. <span class="hljs-built_in">tostring</span>(t)) <span class="hljs-keyword">end</span>
  seen[t]=t
  <span class="hljs-keyword">for</span> key,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(lib.slots(t)) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> v = t[k]
    <span class="hljs-built_in">io</span>.<span class="hljs-built_in">write</span>(lib.fmt(<span class="hljs-string">&quot;%s:%s%s&quot;</span>,pre,k, <span class="hljs-built_in">type</span>(v)==<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;\n&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot; &quot;</span>))
    <span class="hljs-keyword">if</span>   <span class="hljs-built_in">type</span>(v)==<span class="hljs-string">&quot;table&quot;</span> 
    <span class="hljs-keyword">then</span> lib.dent(v,seen,<span class="hljs-string">&quot;|  &quot;</span>..pre) 
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">print</span>(v) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.rnds</span><span class="hljs-params">(t,f)</span></span> 
  <span class="hljs-keyword">return</span> lib.map(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> lib.rnd(x,f) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.rnd</span><span class="hljs-params">(x,f)</span></span> 
  <span class="hljs-keyword">return</span> lib.fmt(<span class="hljs-built_in">type</span>(x)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> (x~=x//<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> f <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;%5.2f&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;%s&quot;</span>,x) <span class="hljs-keyword">end</span>


<span class="hljs-keyword">local</span> _id=<span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.id</span><span class="hljs-params">()</span></span> _id=_id+<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> _id <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.class</span><span class="hljs-params">(name,base)</span></span>
  <span class="hljs-keyword">local</span> klass, base_ctor = {}
  <span class="hljs-keyword">if</span> base <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(base) <span class="hljs-keyword">do</span> klass[k] = v <span class="hljs-keyword">end</span>
    klass._base = base
    base_ctor   = <span class="hljs-built_in">rawget</span>(base,<span class="hljs-string">&#x27;new&#x27;</span>) <span class="hljs-keyword">end</span>
  klass.<span class="hljs-built_in">__index</span> = klass
  klass._is     = name
  klass._class  = klass
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(klass,{
    <span class="hljs-built_in">__call</span> = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(klass,...)</span></span>
      <span class="hljs-keyword">local</span> obj = <span class="hljs-built_in">setmetatable</span>({},klass)
      <span class="hljs-keyword">if</span>     <span class="hljs-built_in">rawget</span>(klass,<span class="hljs-string">&#x27;new&#x27;</span>) 
      <span class="hljs-keyword">then</span>   klass.super = base_ctor
             <span class="hljs-keyword">local</span> res = klass.new(obj,...) 
             <span class="hljs-keyword">if</span> res <span class="hljs-keyword">then</span> obj = <span class="hljs-built_in">setmetatable</span>(res,klass) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">elseif</span> base_ctor <span class="hljs-keyword">then</span> base_ctor(obj,...) <span class="hljs-keyword">end</span> 
      <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">end</span> }) <span class="hljs-keyword">end</span>

lib.Obj = lib.class(<span class="hljs-string">&quot;Obj&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.Obj:show</span><span class="hljs-params">(  t)</span></span>
  t={}
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)~=<span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">then</span> t[<span class="hljs-number">1</span>+#t]=k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> lib.<span class="hljs-built_in">sort</span>(t) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lib.Obj:__tostring</span><span class="hljs-params">(  u)</span></span> <span class="hljs-keyword">return</span> lib.o(<span class="hljs-built_in">self</span>,<span class="hljs-built_in">self</span>:show()) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>u={}; for _,k in pairs(self:show()) do u[1+#u]=lib.fmt(“:%s %s”,k,self[k]) end
 return self._is ..”{“..table.concat(u,” “)..”}” end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">return</span> lib</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
