<!DOCTYPE html>

<html>
<head>
  <title>shortr.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>shortr.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p><span id="forkongithub"><a href="https://github.com/timm/shortr">Fork me on GitHub</a></span>
<a
href="https://github.com/timm/shortr/actions/workflows/tests.yml"><img 
src="https://github.com/timm/shortr/actions/workflows/tests.yml/badge.svg"></a><br><a 
href="https://zenodo.org/badge/latestdoi/206205826">
<img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a></p>
<p>Do I understand “it”?
Can I code “it” succinctly? Using simple tools and a minimal set of data 
structure and algorithms? Does “it” do the minimum work  (so”it” runs fast)?
 Can I explain “it” to you, quickly and successfully? And does “it” generalize
(so “it” is not a one-off hack)?<p>Let’s check. Please review my code.<br>This is  a multi-objective semi-supervised explanation tool,
all in under 400 lines of code
 (most of which is background stuff that could be used for other learners).    </p>
<p><code>awk &#39;!/^(--|[ \t]*$)/{n++} END{print n&quot; lines&quot;}&#39; *.lua</code><br>=&gt; 367 lines</p>
<p>Share and enjoy!<hr>  </p>
<p><strong>Mother Teresa:</strong><br><img width=175 align=left src=cup.png> 
“The more you have, the more you are occupied.
The less you have, the more free you are.”<p>
<strong>Ken Thompson:</strong><br>“One of my most productive days was throwing 
away 1,000 lines of code.”<p>
<strong>William of Occam:</strong><br>“It is vain to do with more what can be done with less.”  <p>
<strong>Donald Knuth:</strong><br>“It is much more rewarding to do more with less.” <p>
<strong>Leonardo da Vinci:</strong><br>“Simplicity is the ultimate sophistication.”<p>
<strong>Edsger Dijkstra:</strong><br>“Simplicity is prerequisite for reliability.”<p>
<strong>Dieter Ram:</strong><br>“Less, but better.”<p>
<strong>timm:</strong><br>“plz, less”<p>
 Role models  (whose code challenges me to write less, but better):<br><a href="https://www.youtube.com/watch?v=o9pEzgHorH0">Jack Diederich</a> 
| <a href="https://boingboing.net/2017/06/30/next-level-regexp.html">Hilary Mason</a>
| <a href="https://www.oreilly.com/library/view/beautiful-code/9780596510046/ch01.html">Brian Kernighan</a><br>  <a href="http://norvig.com/lispy.html">Peter Norvig</a>
| <a href="https://github.com/joelgrus/data-science-from-scratch">Joel Grus</a>
| <a href="http://www.paulgraham.com/onlisp.html">Paul Graham</a></p>
<p>   

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> help= <span class="hljs-string">[[

SHORTR: semi-supervised multi-objective optimization
(c) 2022 Tim Menzies &lt;timm@ieee.org&gt; BSD2 license

Explore N points via  O(log2(N)) evaluations. Generate a
human-readable summary of that space.  In pass1, find and
eval  two distant points using multi-objective criteria.
Everything nearest the  worst is pruned and we recurse on
the rest.  This algorithm is only approximate so, in pass2,
we do it all again, starting with the better items seen in
pass1.  Explain the final results by  a decision tree that
recursively discretizes numerics via their ability to
distinguish the best/worst things found in pass2.

USAGE:
  lua shortr.lua [OPTIONS]

OPTIONS:
  -F  --Few    only keep a &quot;Few&quot; numbers  =  256
  -S  --small  small leaf size            =  .5
  -b  --Bins   max number of bins         =  16
  -k  --k      handle rare classes        =   1
  -m  --m      handle rare attributes     =   2
  -p  --p      distance coefficient       =   2
  -w  --wait   wait before classifying    =  10

OPTIONS (other):
  -f  --file   file           =  ../../data/auto93.csv
  -g  --go     start-up goal  =  nothing
  -h  --help   show help      =  false
  -s  --seed   seed           =  10019]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h2 id="names">Names</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> _ = <span class="hljs-built_in">require</span><span class="hljs-string">&quot;lib&quot;</span>
<span class="hljs-keyword">local</span> argmax,big                     = _.argmax,_.big
<span class="hljs-keyword">local</span> cli,csv,demos,klass,normpdf    = _.cli,_.csv,_.demos,_.klass, _.normpdf
<span class="hljs-keyword">local</span> oo,push,rand,<span class="hljs-built_in">read</span>,rnd,same,str = _.oo,_.push,_.rand,_.<span class="hljs-built_in">read</span>,_.rnd,_same,_.str</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p><code>THE</code> settings is parsed from <code>help</code> 
string lines that contain two dashes&nbsp;”<code>--</code>“.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> THE={}
help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot; [-][-]([^%s]+)[^\n]*%s([^%s]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key,x)</span></span> THE[key] = <span class="hljs-built_in">read</span>(x) <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h3 id="our-classes">Our classes</h3>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <ul>
<li>ROWS use COLS to make either NUMs or SYMs.  </li>
<li>ROWS holds data in ROWs, and summarizes columns in NUMs and SYMs.  </li>
<li>There are two helper classes:<ul>
<li>NUMs use SOMEs to keep up to <code>THE.Few</code> nums per columns.   </li>
<li>RANGE objects track what <code>y</code> was seen from <code>xlo</code> to <code>xhi</code>.</li>
</ul>
</li>
<li>NB is a bayes classifier built from these sub-routunes.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> ROWS, COLS, NUM, SYM = klass<span class="hljs-string">&quot;ROWS&quot;</span>,  klass<span class="hljs-string">&quot;COLS&quot;</span>,  klass<span class="hljs-string">&quot;NUM&quot;</span>, klass<span class="hljs-string">&quot;SYM&quot;</span>
<span class="hljs-keyword">local</span> ROW = klass<span class="hljs-string">&quot;ROW&quot;</span>
<span class="hljs-keyword">local</span> SOME,RANGE = klass<span class="hljs-string">&quot;SOME&quot;</span>, klass<span class="hljs-string">&quot;RANGE&quot;</span>
<span class="hljs-keyword">local</span> NB = klass<span class="hljs-string">&quot;NB&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h2 id="class-cols">class COLS</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>The system uses COLS to make lists of NUMs or SYMs.</p>
<p> Independent and dependent columns are stored in <code>xs</code> or <code>ys</code> lists.<p>
This code reads data from csv files or lists of tables.
The first row of data is a list of column names. </p>
<p>Those can contain some special symbols.
For example, we want to ignore columns whose name ends with “<code>:</code>“.
Also, number columns start with an upper case letter.
Further, dependent variables end in “<code>!</code>“, “<code>+</code>“, or “<code>-</code>“ 
for klasses or goals to be minimized or maximized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span>  is={}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.use</span><span class="hljs-params">(x)</span></span>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.num</span><span class="hljs-params">(x)</span></span>      <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.goal</span><span class="hljs-params">(x)</span></span>     <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.klass</span><span class="hljs-params">(x)</span></span>    <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span>     <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.minimize</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span>     <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>For example, <code>COLS</code> would read line1 of the following data, skipping column #2, making
NUMerics out of columns #1,#2, and a SYMbolic out of columni #4. Further,
any goal columns (in this case, “<code>Lbs-</code>“)  get stored in a <code>ys</code> list
and all other columns are stored in <code>xs</code>.</p>
<pre><code>Clndrs,  Hp:,  Lbs-,  origin
<span class="hljs-number">8</span>,       <span class="hljs-number">193</span>,  <span class="hljs-number">4732</span>,  <span class="hljs-number">1</span>
<span class="hljs-number">8</span>,       <span class="hljs-number">215</span>,  <span class="hljs-number">4615</span>,  <span class="hljs-number">1</span>
<span class="hljs-number">8</span>,       <span class="hljs-number">200</span>,  <span class="hljs-number">4376</span>,  <span class="hljs-number">1</span>
...
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p><strong>COLS(  <code>t</code>  :[string] )</strong><br>constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS.new</span><span class="hljs-params">(i,t,     new)</span></span>
  i.xs, i.ys, i.names = {},{},t
  <span class="hljs-keyword">for</span> at,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
    new = (is.num(txt) <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)()
    new.txt,  new.at = txt, at
    new.usep, new.w  = is.use(txt), (is.minimize(txt) <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> new.usep  <span class="hljs-keyword">then</span> 
      <span class="hljs-keyword">if</span> is.klass(new.txt) <span class="hljs-keyword">then</span> i.klass=new <span class="hljs-keyword">end</span>
      push(is.goal(new.txt) <span class="hljs-keyword">and</span> i.ys <span class="hljs-keyword">or</span> i.xs, new) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><strong>.add(  <code>t</code>  :ROW  )  :ROW</strong><br>update column summaries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS.add</span><span class="hljs-params">(i,t)</span></span>
  <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{i.xs,i.ys} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> col:add(t.cells[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h2 id="class-sym">class SYM</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Summarize a stream of symbols, maintaining the <code>mode</code> and frequencies counts
of symbols seen so far.</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><strong>SYM()</strong><br>constructor.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.new</span><span class="hljs-params">(i)</span></span>  i.n,i.syms,i.most,i.mode = <span class="hljs-number">0</span>,{},<span class="hljs-number">0</span>,<span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p> <strong>.add(  <code>v</code>  :any,  ?<code>inc</code>=1   )</strong><br>add <code>v</code>, <code>inc</code> number of times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.add</span><span class="hljs-params">(i,v,inc)</span></span>
  <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> v <span class="hljs-keyword">end</span>
  inc=inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  i.n = i.n + inc
  i.syms[v] = inc + (i.syms[v] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
  <span class="hljs-keyword">if</span> i.syms[v] &gt; i.most <span class="hljs-keyword">then</span> i.most,i.mode = i.syms[v],v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p> <strong>.bin(  <code>x</code>  :any  )  :any</strong><br>discrediting a symbol just returns that symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.bin</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p><strong>.like(  <code>x</code>  :any  )  :number</strong><br>report likelihood.   </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.like</span><span class="hljs-params">(i,x,prior)</span></span> <span class="hljs-keyword">return</span> ((i.syms[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)+THE.m*prior)/(i.n+THE.m) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p> <strong>.merge(  <code>j</code>  :SYM  )  :SYM</strong><br>Return a SYM that combines self and <code>j</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.merge</span><span class="hljs-params">(i,j,      k)</span></span>
  <span class="hljs-keyword">local</span> k = SYM(i.at, i.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p><strong>.mid()  :any</strong><br>return the  most commonly seen symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.mid</span><span class="hljs-params">(i,...)</span></span>  <span class="hljs-keyword">return</span> i.mode <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h2 id="class-some">class SOME</h2>
<p>NUMs use SOMEs to store at most <code>THE.Few</code> samples per numeric columns. </p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p><strong>SOME()</strong><br>constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.new</span><span class="hljs-params">(i)</span></span> i.n,i.t,i.ok = <span class="hljs-number">0</span>,{},<span class="hljs-literal">true</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p><strong>.add(  <code>x</code>:any  )</strong><br>
Technically, this is a reservoir sampler; i.e. given a small cache,
sample at an equal (but low) probability across  a much larger  space.
Note one trick: If we full, make space by replacing anything at all.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.add</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.n = i.n + <span class="hljs-number">1</span> 
  <span class="hljs-keyword">if</span>     #i.t   &lt; THE.Few     <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; push(i.t,x)  
  <span class="hljs-keyword">elseif</span> rand() &lt; THE.Few/i.n <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; i.t[rand(#i.t)]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p><strong>.all()  :table</strong><br>If we ask for <code>.all()</code>, then make sure they are sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.all</span><span class="hljs-params">(i)</span></span> i.t=i.ok <span class="hljs-keyword">and</span> i.t <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(i.t); i.ok=<span class="hljs-literal">true</span>; <span class="hljs-keyword">return</span> i.t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h2 id="class-num">class NUM</h2>
<p>Summarize a stream of numbers, maintaining its <code>lo</code>, <code>hi</code>, <code>mu</code> (mean).</p>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p><strong>NUM()</strong><br>constructor.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.new</span><span class="hljs-params">(i)</span></span> i.n,i.mu,i.m2,i.w,i.lo,i.hi,i.some=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,big,-big,SOME() <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p> <strong>.add(  <code>v</code>  :number  )</strong><br>add <code>v</code> to the summary, updating <code>mu,sd,lo,hi</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.add</span><span class="hljs-params">(i, v)</span></span>
  <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> v <span class="hljs-keyword">end</span>
  i.some:add(v)
  i.n  = i.n + <span class="hljs-number">1</span>
  <span class="hljs-keyword">local</span> d    = v - i.mu
  i.mu = i.mu + d/i.n
  i.m2 = i.m2 + d*(v - i.mu)
  i.sd = i.n&lt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (i.m2/(i.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span> 
  i.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(v, i.lo) 
  i.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(v, i.hi) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p> <strong>.bin(  <code>x</code>  :number  )  :number</strong><br>return x, rounded into <code>THE.bins</code> values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.bin</span><span class="hljs-params">(x)</span></span> 
  b=(i.hi - i.lo)/THE.bins; <span class="hljs-keyword">return</span> i.lo==i.hi <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">.5</span>)*b <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p><strong>.like(  <code>x</code>  :number  )  :number</strong><br>return likelihood.   </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.like</span><span class="hljs-params">(i,x,...)</span></span> <span class="hljs-keyword">return</span> normpdf(x, i.mu, i.sd) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p> <strong>.merge(  <code>j</code>  :NUM  )  :NUM</strong><br>Return a NUM that combines self and <code>j</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.merge</span><span class="hljs-params">(i,j,      k)</span></span>
  <span class="hljs-keyword">local</span> k = NUM(i.at, i.txt)
  <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.some.t) <span class="hljs-keyword">do</span> k:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.some.t) <span class="hljs-keyword">do</span> k:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p><strong>.mid(  ?<code>p</code>=2  )  :number</strong><br>report rounded middle.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.mid</span><span class="hljs-params">(i,p)</span></span> <span class="hljs-keyword">return</span> rnd(i.mu,p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <h2 id="class-row">class ROW</h2>
<p>Store data from one record. Track if we ever use this ROW’s dependent variables.
Hold a pointer back to a ROWS (so we can access attribute positions and
weightings).</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <p><strong>ROW(  <code>of</code>  :ROWS,  <code>cells</code>   :table)</strong><br>constructor.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.new</span><span class="hljs-params">(i,of,cells)</span></span> i.of,i.cells,i.evaled  = of,cells,<span class="hljs-literal">false</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p><strong>.klass()</strong><br>Return the klass variable of this ROW.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.klass</span><span class="hljs-params">(i)</span></span>    <span class="hljs-keyword">return</span> i.cells[i.of.cols.klass.at] <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><strong>.within(  <code>range</code>  :RANGE  )   :boolean</strong><br>True if ROW is in <code>range</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.within</span><span class="hljs-params">(i,range)</span></span>
   <span class="hljs-keyword">local</span> lo, hi, at = range.xlo, range.xhi, range.ys.at
   <span class="hljs-keyword">local</span> v = i.cells[at]
   <span class="hljs-keyword">return</span>  v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> (lo==hi <span class="hljs-keyword">and</span> v==lo) <span class="hljs-keyword">or</span> (lo&lt;v <span class="hljs-keyword">and</span> v&lt;=hi) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h2 id="class-rows">class ROWS</h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p>Store some ROWs. Keep a summary of the columns inside <code>cols</code>. Keep the
dependent and independent summaries seepage in <code>cols.ys</code> and <code>cols.xs</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p><strong>ROWS(  <code>t</code>  :[string]  )</strong><br>constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.new</span><span class="hljs-params">(i,t)</span></span> i.cols=COLS(t); i.rows={} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p><strong>.add(  <code>t</code>  :(table|ROW)  )  :ROW</strong><br>update with a table or ROW.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.add</span><span class="hljs-params">(i,t)</span></span> <span class="hljs-keyword">return</span> push(i.rows, i.cols:add(t.cells <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> ROW(i,t))) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p><strong>.mid(  <code>cols</code>  :[NUM|SYM],  <code>p</code>=2  )  :table</strong><br>returns <code>mid</code>s of some columns; round numerics to <code>p</code> decimal places.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.mid</span><span class="hljs-params">(i, cols, p,     t)</span></span>
  t={};<span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols <span class="hljs-keyword">or</span> i.cols.ys) <span class="hljs-keyword">do</span> t[col.txt]=col:mid(p) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p><strong>.clone(  ?<code>data</code>  :(table|[ROW])  )  :ROWS</strong><br>copy this structure, maybe add data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.clone</span><span class="hljs-params">(i,data,  j)</span></span> 
  j= ROWS(i.cols.names);<span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(data <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> j:add(row) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p><strong>.like(  <code>row</code>  :ROWS,  <code>nklasses</code>  :int;  <code>nrows</code>  :int  )  :number</strong><br>how likely is it that <code>row</code> could live here?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.like</span><span class="hljs-params">(i,row, nklasses, nrows,    prior,like,inc,x)</span></span>
  prior = (#i.rows + THE.k) / (nrows + THE.k * nklasses)
  like  = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(prior)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.xs) <span class="hljs-keyword">do</span>
    x = row.cells[col.at] 
    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">and</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      inc  = col:like(x,prior)
      like = like + <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(inc) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> like <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p><strong>doRows(  ?<code>src</code>  :(string|table),  <code>fun</code>  :function( table|ROW )   )</strong><br>helper function for reading from tables or files. Case arg1 of …<br>… <em>table</em>  : call  function for all items in table.<br>… <em>string</em> :  call function on all rows from a file.<br>… <em>nil</em>    :  call function of all rows from standard input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doRows</span><span class="hljs-params">(src, fun)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span>  _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> fun(t) <span class="hljs-keyword">end</span>
                         <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span>   t <span class="hljs-keyword">in</span> csv(src)   <span class="hljs-keyword">do</span> fun(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <h2 id="decision-or-regression-tree">Decision (or Regression) Tree</h2>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p><strong>.tree(  <code>listOrRows</code>  :[[ROW]] )  :ROW</strong><br>return root of decision or regression tree;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.tree</span><span class="hljs-params">(i, listOrRows)</span></span>
  <span class="hljs-keyword">local</span> ylabels = {}
  <span class="hljs-keyword">for</span> label,rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(listOfRows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span> ylabels[ push(all,row).id ] = label <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i:treeGrow(i.cols.xs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> ylabels[row.id] <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <p><strong>.treeGrow(  <code>xcols</code>  :[NUM|SYM],  <code>y</code>  :function  )  :ROW</strong><br>return root of decision or regression tree;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.treeGrow</span><span class="hljs-params">(i,xcols,y,         gaurd,stop)</span></span>
  rows.gaurd = gaurd
  stop = stop <span class="hljs-keyword">or</span> (#i.rows)^THE.small
  rows.kids = {}
  <span class="hljs-keyword">if</span> #i.rows &gt;= <span class="hljs-number">2</span>*stop <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">local</span> ranges= map(xcols,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col)</span></span> <span class="hljs-keyword">return</span> RANGE.make(i.rows,col,SYM,y) <span class="hljs-keyword">end</span>)
    <span class="hljs-keyword">for</span> j,range <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(ranges, lt<span class="hljs-string">&quot;div&quot;</span>)[<span class="hljs-number">1</span>].ranges) <span class="hljs-keyword">do</span> 
      <span class="hljs-keyword">local</span> kid= i:clone()
      <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.rows) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> row:within(range) <span class="hljs-keyword">then</span> kid:add(row); <span class="hljs-keyword">break</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
      <span class="hljs-keyword">if</span> #kid.rows &lt; #i.rows <span class="hljs-keyword">then</span>
        i.kids[j] = kid:treeGrow(xcols, y, range, stop) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <p><strong>.show(  <code>pre</code>  :string,   ?<code>show</code>  :function)</strong><br>pretty print;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.show</span><span class="hljs-params">(i,pre,show,        show0)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show0</span><span class="hljs-params">(i)</span></span> <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;%s%s%s&quot;</span> , pre, i.gaurd, #i.rows)) <span class="hljs-keyword">end</span>
  pre = pre <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  (show <span class="hljs-keyword">or</span> show0)(i)
  <span class="hljs-keyword">for</span> _,kid <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.kids <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> kid:show(pre..<span class="hljs-string">&quot;|.. &quot;</span>, show) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <h2 id="class-nb">class NB</h2>
<p>(0) Use row1 to initial our <code>overall</code> knowledge of all rows.<br>After that (1) add row to <code>overall</code> and (2) ROWS about this row’s klass.<br>(3) After <code>wait</code> rows, classify row BEFORE updating training knowledge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.new</span><span class="hljs-params">(i,src,report,             row)</span></span>
  i.overall, i.dict, i.list  = <span class="hljs-literal">nil</span>, {}, {}
  doRows(src, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row,   k)</span></span> 
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.overall <span class="hljs-keyword">then</span> i.overall = ROWS(row) <span class="hljs-keyword">else</span> <span class="hljs-comment">-- (0) eat row1</span>
      row = i.overall:add(row)                       <span class="hljs-comment">-- add to overall </span>
      <span class="hljs-keyword">if</span> #i.overall.rows &gt; THE.wait <span class="hljs-keyword">then</span> report(row:klass(), i:guess(row)) <span class="hljs-keyword">end</span>
      i:train(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>                      <span class="hljs-comment">-- add tp rows&#x27;s klass</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.train</span><span class="hljs-params">(i,row,      k)</span></span> 
  k = row:klass()
  i.dict[k] = i.dict[k] <span class="hljs-keyword">or</span> push(i.list,i.overall:clone()) <span class="hljs-comment">-- klass is known</span>
  i.dict[k].txt = k                            <span class="hljs-comment">-- each klass knows its name</span>
  i.dict[k]:add(row) <span class="hljs-keyword">end</span>                       <span class="hljs-comment">-- update klass with row</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.guess</span><span class="hljs-params">(i,row)</span></span> 
    <span class="hljs-keyword">return</span> argmax(i.dict, 
      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(klass)</span></span> <span class="hljs-keyword">return</span> klass:like(row,#i.list,#i.overall.rows) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <h2 id="class-range">class RANGE</h2>
<p> RANGE objects track what <code>y</code> was seen from <code>xlo</code> to <code>xhi</code>. </p>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <p><strong>RANGE(  <code>xlo</code>  :number,  <code>xhi</code>  :number,  <code>yes</code>  :(NUM|SYM)  )</strong><br>constructor;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.new</span><span class="hljs-params">(i, xlo, xhi, ys)</span></span> i.xlo,i.xhi,i.ys,i.rows = xlo,xhi,ys,{} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <p><strong>RANGE(  <code>x</code>  :number,  <code>y</code>  :number  )</strong><br>extend range to cover <code>x</code>;<br>and add <code>y</code> to the y-values seen so far.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.add</span><span class="hljs-params">(i,x,y)</span></span>
  <span class="hljs-keyword">if</span> x &lt; i.xlo <span class="hljs-keyword">then</span> i.xlo = x <span class="hljs-keyword">end</span> <span class="hljs-comment">-- works for string or num</span>
  <span class="hljs-keyword">if</span> x &gt; i.xhi <span class="hljs-keyword">then</span> i.xhi = x <span class="hljs-keyword">end</span> <span class="hljs-comment">-- works for string or num</span>
  i.ys:add(y) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p><strong>.__tostring()  :string</strong><br>pretty print;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.__tostring</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x, lo, hi = i.ys.txt, i.xlo, i.xhi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt; %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s &lt;= %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <p><strong>.merge(  <code>i</code>  :RANGE,  <code>j</code>  :RANGE,  <code>min</code>  :integer)  :(RANGE|nil)</strong><br>Merge ranges that are too small (less than <code>min</code>), or are more complex
than their combination. Return nil otherwise. Note: should only be applied
to <em>adjacent</em> ranges.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.merge</span><span class="hljs-params">(i,j,min)</span></span>
  <span class="hljs-keyword">local</span> lo,hi       = i.xlo, j.xhi
  <span class="hljs-keyword">local</span> y1, y2, y12 = i.ys, j.ys, i.ys:merge(j.ys)
  <span class="hljs-keyword">local</span> n1, n2, n12 = y1.n, y2.n, y12.n
  <span class="hljs-keyword">if</span> n1&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> n2&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> y12:div() &lt;= (n1*y1:div() + n2*y2:div()) / n12 <span class="hljs-keyword">then</span> 
    <span class="hljs-keyword">return</span> RANGE(lo, hi, y12)  <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              <h2 id="discretization-making-ranges">Discretization (making ranges)</h2>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <p><strong>RANGE.make(  <code>rows</code>  :[ROW],  <code>xcol</code>  :(NUM|SYM),<br><code>yclass</code>:KLASS,  <code>y</code>  :function  )  :table</strong><br>Class method. Returns a list <code>{ranges={RANGE},  div=number}</code> that scores each range.<br>Numeric ranges are first divided into groups of size <code>(hi-lo)/THE.bins</code> 
then subsequently, adjacent ranges are merged (see <code>_merges</code>). 
Finally, each range is score by the weighted sum of its diversity.</p>
<p><em>Low-level detail:</em> About the idiom:<br><code>dict[pos]=dict[pos] or push(list,RANGE(...))</code><br>The <code>map</code> and <code>sort</code> functions used in this code
do funny things when sorting associative arrays
with discontinuous keys. 
To have something that can reliably sorted, while at the same time, have a fast way to access one item,
this code maintains<br>(1) a “fast-find” index (<code>dict</code>)<br>(2) something with continuous indexes (<code>list</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> _merges, _xpand
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.make</span><span class="hljs-params">(rows,xcol,yklass,y)</span></span>
  <span class="hljs-keyword">local</span> n,list, dict = <span class="hljs-number">0</span>,{}, {}
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> v = row.cells[xcol.at]
    <span class="hljs-keyword">if</span> v ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      n = n + <span class="hljs-number">1</span>
      <span class="hljs-keyword">local</span> pos = xcol:bin(v)
      dict[pos] = dict[pos] <span class="hljs-keyword">or</span> push(list, RANGE(v,v, yklass(xcol.at, xcol.txt)))
      dict[pos]:add(v, y(row)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  list = <span class="hljs-built_in">sort</span>(list, lt<span class="hljs-string">&quot;xlo&quot;</span>)
  list = xcol.is==<span class="hljs-string">&quot;NUM&quot;</span> <span class="hljs-keyword">and</span> _xpand(_merges(list, n^THE.<span class="hljs-built_in">min</span>)) <span class="hljs-keyword">or</span> list
  <span class="hljs-keyword">return</span> {ranges= list,
          div   = sum(list,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> z.ys:div()*z.ys.n/n <span class="hljs-keyword">end</span>)} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-63">&#x00a7;</a>
              </div>
              <p><strong>_merge( <code>b4</code>  :[RANGE],   <code>min</code>:number  )  :[RANGE]</strong><br>Try to merge adjacent ranges. If successful, then loop looking for other merges.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_merges</span><span class="hljs-params">(b4, min)</span></span>
  <span class="hljs-keyword">local</span> j,now = <span class="hljs-number">1</span>,{}
  <span class="hljs-keyword">while</span> j &lt;= #b4 <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">local</span> merged
    <span class="hljs-keyword">if</span> j&lt;#b4 <span class="hljs-keyword">then</span> merged = b4[j]:merge(b4[j+<span class="hljs-number">1</span>], <span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span>
    now[#now+<span class="hljs-number">1</span>] = merged <span class="hljs-keyword">and</span> merged <span class="hljs-keyword">or</span> b4[j] 
    j           = j + (merged <span class="hljs-keyword">and</span> <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">end</span><span class="hljs-comment">-- skip to next and next if we found a merge</span>
  <span class="hljs-keyword">return</span>  #now == #b4 <span class="hljs-keyword">and</span> now <span class="hljs-keyword">or</span> _merges(now,<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span> <span class="hljs-comment">-- hunt for more merges</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-64">&#x00a7;</a>
              </div>
              <p><strong>_xpand(  <code>ranges</code>  :[RANGE]  )  :[RANGE]</strong><br>Expand the ranges to cover everything from minus to plus infinity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpand</span><span class="hljs-params">(ranges)</span></span>
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#ranges <span class="hljs-keyword">do</span> ranges[j].xlo = ranges[j<span class="hljs-number">-1</span>].xhi <span class="hljs-keyword">end</span>
  ranges[<span class="hljs-number">1</span>].xlo, ranges[#t].xhi = -big, big
  <span class="hljs-keyword">return</span> ranges <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-65">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-66">&#x00a7;</a>
              </div>
              <h2 id="tests">Tests</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> no,go = {},{}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>); <span class="hljs-built_in">print</span>(THE); <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(THE.p)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> THE.p==<span class="hljs-number">2</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.argmax</span><span class="hljs-params">(  t,fun)</span></span>
  fun=<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> -x <span class="hljs-keyword">end</span>
  t={<span class="hljs-number">50</span>,<span class="hljs-number">40</span>,<span class="hljs-number">0</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span> == argmax(t,fun) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.num</span><span class="hljs-params">(n)</span></span> n=NUM(); <span class="hljs-keyword">for</span> x=<span class="hljs-number">1</span>,<span class="hljs-number">100</span> <span class="hljs-keyword">do</span> n:add(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> n.mu==<span class="hljs-number">50.5</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.sym</span><span class="hljs-params">(s)</span></span> 
  s=SYM(); <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>} <span class="hljs-keyword">do</span> s:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s.mode==<span class="hljs-string">&quot;a&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.csv</span><span class="hljs-params">(    n,s)</span></span> 
  n,s=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(THE.file)  <span class="hljs-keyword">do</span> n=n+<span class="hljs-number">1</span>; <span class="hljs-keyword">if</span> n&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> s=s+row[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> rnd(s/n,<span class="hljs-number">3</span>) == <span class="hljs-number">5.441</span>  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.rows</span><span class="hljs-params">(    rows)</span></span>
  doRows(THE.file,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">if</span> rows <span class="hljs-keyword">then</span> rows:add(t)  <span class="hljs-keyword">else</span> rows=ROWS(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) 
  <span class="hljs-keyword">return</span> rnd(rows.cols.ys[<span class="hljs-number">1</span>].sd,<span class="hljs-number">0</span>)==<span class="hljs-number">847</span> <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_classify</span><span class="hljs-params">(file)</span></span> 
  <span class="hljs-keyword">local</span> Abcd=<span class="hljs-built_in">require</span><span class="hljs-string">&quot;abcd&quot;</span>
  <span class="hljs-keyword">local</span> abcd=Abcd()
  NB(file, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(got,want)</span></span> abcd:add(got,want) <span class="hljs-keyword">end</span>)
  abcd:pretty(abcd:report())
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.soybean</span><span class="hljs-params">()</span></span>  <span class="hljs-keyword">return</span> _classify(<span class="hljs-string">&quot;../../data/soybean.csv&quot;</span>) <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.diabetes</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> _classify(<span class="hljs-string">&quot;../../data/diabetes.csv&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-67">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-68">&#x00a7;</a>
              </div>
              <h2 id="start">Start</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>    <span class="hljs-built_in">pcall</span>(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">then</span>  <span class="hljs-keyword">return</span> {doRows=doRows,ROW=ROW, ROWS=ROWS, NUM=NUM, SYM=SYM, THE=THE,lib=lib} 
<span class="hljs-keyword">else</span>  THE = cli(THE,help)
      demos(THE,go) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
