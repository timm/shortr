<!DOCTYPE html>

<html>
<head>
  <title>saw2.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>saw2.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
<img 
align=right width=250 src=heads2.png>
<a 
href="https://zenodo.org/badge/latestdoi/206205826"> <img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> <img 
src="https://img.shields.io/badge/platform-osx,linux-informational?logo=linux&logoColor=white&color=red"> <img 
src="https://img.shields.io/badge/purpose-se,ai-informational?logo=hyper&logoColor=white&color=orange"> <img 
src="https://img.shields.io/badge/language-lua-informational?logo=lua&logoColor=white&color=yellow"> <a
href="https://github.com/timm/l5/actions/workflows/tests.yml"><img src="https://github.com/timm/l5/actions/workflows/tests.yml/badge.svg"></a><br><a
href="https://github.com/timm/l5/blob/master/LICENSE.md#top"><img src="https://img.shields.io/badge/license-BSD2-informational?logo=adblock&logoColor=white&color=blueviolet"></a>
<br>
&copy;2022, <a href="mailto:timm@ieee.org">Tim Menzies</a>
<br clear=all>
<ul>
<li>After <em>N</em> samples, we can find an event of probability <em>P</em> with confidence<br><em>C=1-(1-P) <sup>N</sup></em>. Rearranged, this means that  <em>N=log(1-C)/log(1-P)</em>.
<li>
Now suppose some order predict can sort examples into a linear list, with  <em>p</em> best examples.
Then with confidence  <em>C</em>, after  <em>N=log2(log(1-C)/log(1-P))</em> random probes,
we can find the best  <em>P</em> percent of those examples.
<li>
Statisticians tell us that it is hard to distinguish items that are less that .2*&sigma;</em> apart. 
Therefore,  for items across &pm;4&sigma;</em> has a top region of size  <em>P=.35/8=4.%</em> that is indistinguishable from the top item.
<li> This
means that
at confidence  <em>C=0.99</em>, <em>N=7</em>  random samples should be enough to find that best region.
<li>
Is that true? Well, lets find out. Let load some items, sort them using the Zitzler predicate, and label the top 4.4% as "best!"
(this is our ground truth).  Then lets pick 3 items at random, sort them (using Zitzler), and analyze all items
by their likelihood of being "best?" (nearest the top item) or "rest?" (not "best?"). After that, then loop over
evaluated the most likely item, sort all the evaluated, and re-analyze all items as likely to be "best?" or "rest?".
<li> How long before we have rules that can identify the "best!"?
</ul>
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4,help = {},<span class="hljs-string">[[ 
SAW2: best or rest multi-objective optimization.
(c) 2022 Tim Menzies, timm@ieee.org
&quot;I think the highest and lowest points are the important ones. 
 Anything else is just...in between.&quot; ~ Jim Morrison

USAGE: lua saw2.lua [OPTIONS]
 
OPTIONS:
  -b  --bins  max bins                 = 16
  -s  --seed  random number seed       = 10019
  -S  --some  number of nums to keep   = 256
  -p  --p     distance coeffecient     = 2


OPTIONS (other):
  -f  --file  where to find data       = ../etc/data/auto93.csv
  -h  --help  show help                = false
  -r  --rnd   rounding rules           = %5.2f
  -g  --go    start up action          = nothing

Usage of the works is permitted provided that this instrument is
retained with the works, so that any entity that uses the works is
notified of this instrument. DISCLAIMER:THE WORKS ARE WITHOUT WARRANTY. ]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="coding-conventions">Coding Conventions</h2>
<ul>
<li><em>Separate policy from mechanism:</em>
All “magic parameters” that control code behavior should be part
of that help text. Allow for <code>-h</code> on the command line to print
help.  Parse that string to set the options.</li>
<li><em>Encapsulation:</em> Use polymorphism but no inheritance (simpler
debugging). Use UPPERCASE for class names. All classes get a <code>new</code> constructor.</li>
<li><em>Dialogue independence</em>: Isolate and separate operating system interaction.</li>
<li><em>Test-driven development</em>: The <code>go</code> functions store tests.
Tests should be silent unless they –   fail. ~tests can be
disabled by renaming from <code>go.fun</code> to <code>no.fun</code>. Tests should
return <code>true</code> if the test passes.  On exit, return number of
failed tests.</li>
<li><em>Less is more:</em> Code 80 chars wide, or less.  Functions in 1 line,
if you can. Indent with two spaces. Divide code into 120 line (or
less) pages.  Use <code>i</code> instead of <code>self</code>. Use <code>_</code> to denote the
last created class/ Use <code>__</code> for anonymous variable.s Minimize
use of local (exception: define all functions as local at top of
file).</li>
</ul>
<h2 id="about-the-learning">About the Learning</h2>
<ul>
<li>Beware missing values (marked in “?”) and avoid them</li>
<li>Where possible all learning should be  incremental.</li>
<li>XXX tables very sueful</li>
<li>XXX table have cols. cols are num, syms. ranges</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h2 id="namespace">Namespace</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> the={}
<span class="hljs-keyword">local</span> _,big,clone,csv,demos,discretize,dist,eg,entropy,fmt,gap,like,lt
<span class="hljs-keyword">local</span> map,merged,mid,mode,mu,norm,num,o,obj,oo,pdf,per,push
<span class="hljs-keyword">local</span> rand,range,rangeB4,rnd,rnds,rowB4,slice,<span class="hljs-built_in">sort</span>,some,same,sd,string2thing,sym,these
<span class="hljs-keyword">local</span> NUM,SYM,RANGE,EGS,COLS,ROW
<span class="hljs-keyword">for</span> k,__ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=k <span class="hljs-keyword">end</span> <span class="hljs-comment">-- At end, use `b4` to find rogue vars.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <h2 id="utils">Utils</h2>
<p>Misc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>big=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
rand=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
fmt=<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
same = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Sorting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span>    <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(#t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> map(t,same), f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lt</span><span class="hljs-params">(x)</span></span>        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &lt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Query and update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f, u)</span></span>  u={};<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span>    t[<span class="hljs-number">1</span>+#t]=x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slice</span><span class="hljs-params">(t,i,j,k,     u)</span></span> 
  i,j = i <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>,j <span class="hljs-keyword">or</span> #t
  k   = (k <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)
  k   = (j - i)/n
  u={}; <span class="hljs-keyword">for</span> n=i,j,k <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = t[n] <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>“Strings 2 things” coercion. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">string2thing</span><span class="hljs-params">(x)</span></span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(csvfile)</span></span> 
  file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(csvfile)
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line, row)</span></span> 
    line=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line <span class="hljs-keyword">then</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(csvfile) <span class="hljs-keyword">else</span>
      row={}; <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> line:<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span> push(row,string2thing(x)) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>“Things 2 strings” coercion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oo</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">print</span>(o(t)) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,    u)</span></span>
  <span class="hljs-keyword">if</span> #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(map(t,<span class="hljs-built_in">tostring</span>),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">else</span>
    u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,k,v) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> (t.is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(<span class="hljs-built_in">sort</span>(u),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnds</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-keyword">return</span> map(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> rnd(x,f) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(x,f)</span></span> 
  <span class="hljs-keyword">return</span> fmt(<span class="hljs-built_in">type</span>(x)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> (x~=x//<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> f <span class="hljs-keyword">or</span> the.rnd) <span class="hljs-keyword">or</span><span class="hljs-string">&quot;%s&quot;</span>,x) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Polymorphic objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(name,    t,new)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(kl,...)</span></span> 
    <span class="hljs-keyword">local</span> x=<span class="hljs-built_in">setmetatable</span>({},kl); kl.new(x,...); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> 
  t = {<span class="hljs-built_in">__tostring</span>=o, is=name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>}; t.<span class="hljs-built_in">__index</span>=t
  _ = t
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(t, {<span class="hljs-built_in">__call</span>=new}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <h2 id="objects">Objects</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h3 id="num">NUM</h3>
<ul>
<li>For a stream of <code>add</code>itions, incrementally maintain <code>mu,sd</code>. </li>
<li><code>Norm</code>alize data for distance and discretization calcs (see <code>dist</code> and <code>bin</code>).</li>
<li>Comment on <code>like</code>lihood that something belongs to this distribution.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>NUM=obj<span class="hljs-string">&quot;NUM&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,at,txt)</span></span> 
  i.at=at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>; i.txt=txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>; i.lo,i.hi=big, -big
  i.n,i.mu,i.m2,i.sd = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>;  i.w=(txt <span class="hljs-keyword">or</span><span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x,   d)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.n  = i.n + <span class="hljs-number">1</span>
  d    = x - i.mu
  i.mu = i.mu + d/i.n
  i.m2 = i.m2 + d*(x - i.mu)
  i.sd = (i.m2&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> i.n&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> ((i.m2/(i.n - <span class="hljs-number">1</span>))^<span class="hljs-number">0.5</span>) 
  i.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(i.lo,x)
  i.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(i.hi,x) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.bin</span><span class="hljs-params">(i,x,n,  b)</span></span> b=(i.hi-i.lo)/n; <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">0.5</span>)*b <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i)</span></span> <span class="hljs-keyword">return</span> i.mu <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.norm</span><span class="hljs-params">(i,x)</span></span> <span class="hljs-keyword">return</span> i.hi-i.lo&lt;<span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x-i.lo)/(i.hi-i.lo+<span class="hljs-number">1</span>/big)<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.dist</span><span class="hljs-params">(i, x,y)</span></span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span>            <span class="hljs-keyword">then</span> y = i:norm(y); x = y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span>            <span class="hljs-keyword">then</span> x = i:norm(x); y = x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span> x,y = i:norm(x), i:norm(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x - y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.like</span><span class="hljs-params">(i,x,__,       e)</span></span>
  <span class="hljs-keyword">return</span> (x &lt; i.mu - <span class="hljs-number">4</span>*i.sd <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> x &gt; i.mu + <span class="hljs-number">4</span>*i.sd <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span>
    <span class="hljs-number">2.7183</span>^(-(x - i.mu)^<span class="hljs-number">2</span> / (z + <span class="hljs-number">2</span>*i.sd^<span class="hljs-number">2</span>))/(z + (<span class="hljs-built_in">math</span>.<span class="hljs-built_in">pi</span>*<span class="hljs-number">2</span>*i.sd^<span class="hljs-number">2</span>)^<span class="hljs-number">.5</span>)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <h3 id="sym">SYM</h3>
<ul>
<li>For a stream of <code>add</code>itions, incrementally maintain count of <code>all</code> symbols.</li>
<li>Using that info, report <code>dist</code>, mode (<code>mid</code>) symbol, and entropy
(<code>div</code>) of this distribution.  </li>
<li>Comment on <code>like</code>lihood that something belongs to this distribution.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>SYM=obj<span class="hljs-string">&quot;SYM&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,at,txt)</span></span> i.at=at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>; i.txt=txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>; i.n,i.all = <span class="hljs-number">0</span>,{} <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x,n)</span></span> 
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.n=i.n+<span class="hljs-number">1</span>; i.all[x] = (n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) + (i.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.dist</span><span class="hljs-params">(i,x,y)</span></span> <span class="hljs-keyword">return</span> (a==b <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i)</span></span>
  m=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> y,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> n&gt;m <span class="hljs-keyword">then</span> m,x=n,y <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.div</span><span class="hljs-params">(i,   n,e)</span></span>
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> k,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> e=e-n/i.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/i.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> ;<span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.like</span><span class="hljs-params">(i,x,prior)</span></span> <span class="hljs-keyword">return</span> ((c.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) + the.m*prior)/(c.n+the.m) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h3 id="range">RANGE</h3>
<ul>
<li>For a stream of <code>add</code>itions, incrementally maintain counts of <code>x</code> and <code>y</code>.</li>
<li>Summarize <code>x</code> as the <code>lo,hi</code> seen so far and summarize <code>y</code> in <code>SYM</code> counts 
in <code>y.all</code> (and get counts there using <code>of</code>).</li>
<li>Support range sorting (<code>__lt</code>) and printing (<code>__tostring</code>).</li>
<li>Check if this range’s <code>x</code> values <code>select</code>s for a particular row.</li>
<li><code>Merge</code> adjacent ranges if the entropy of the whole is less than the parts.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>RANGE=obj<span class="hljs-string">&quot;RANGE&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,col,lo,hi,y)</span></span> 
  i.cols, i.x, i.y = col, ({lo=lo <span class="hljs-keyword">or</span> big, hi=hi <span class="hljs-keyword">or</span> -big}), (y <span class="hljs-keyword">or</span>  SYM()) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x,y)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.x.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(i.x.lo,x)
  i.x.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(i.x.hi,x)
  i.y:add(x,y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__lt</span><span class="hljs-params">(i,j)</span></span> <span class="hljs-keyword">return</span> i.col.at == j.col.at <span class="hljs-keyword">and</span> i.x.lo &lt; j.x.lo <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.of</span><span class="hljs-params">(i,x)</span></span>   <span class="hljs-keyword">return</span> i.y.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.selects</span><span class="hljs-params">(i,t,     x)</span></span>
  t = t.cells <span class="hljs-keyword">and</span> t.cells <span class="hljs-keyword">or</span> t
  x = t[i.at]
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> (i.x.lo==i.x.hi <span class="hljs-keyword">and</span> i.x.lo==x) <span class="hljs-keyword">or</span> (i.x.lo&lt;=x <span class="hljs-keyword">and</span> x&lt;i.x.hi)<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__tostring</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x, lo, hi = i.txt, i.x.lo, i.x.hi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt;= %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s &lt; %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.merge</span><span class="hljs-params">(i,j,n0,    k)</span></span>
  <span class="hljs-keyword">if</span> i.at == j.at <span class="hljs-keyword">then</span>
    k = SYM(i.y.at, i.y.txt)
    i,j = i.y, j.y
    <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> sym(k,x,n) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.all) <span class="hljs-keyword">do</span> sym(k,x,n) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> i.y.n&lt;(n0 <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> j.y.n&lt;(n0 <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (ent(i)*i.n+ent(j)*j.n)/k.n &gt; ent(k) 
    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> RANGE(i.col, i.lo, j.hi, k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h3 id="row">ROW</h3>
<ul>
<li>Using knowledge of the <code>base</code> geometry of the data, support distance calcs
i  (<code>__sub</code> and <code>around</code>) as well as multi-objective ranking (<code>__lt</code>).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>ROW=obj<span class="hljs-string">&quot;ROW&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,eg, cells)</span></span> i.base,i.cells = eg,cells <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__lt</span><span class="hljs-params">(i,j,     s1,s2,e,y,a,b)</span></span>
  y = i.base.cols.y
  s1, s2, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">for</span> __,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(y) <span class="hljs-keyword">do</span>
     a  = col:norm(i.cells[col.at])
     b  = col:norm(j.cells[col.at])
     s1 = s1 - e^(col.w * (a - b) / #y)
     s2 = s2 - e^(col.w * (b - a) / #y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#y &lt; s2/#y <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__sub</span><span class="hljs-params">(i,j)</span></span>
  <span class="hljs-keyword">for</span> __,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.base.cols.x) <span class="hljs-keyword">do</span>
    a,b = i.cells[col.at], j.cells[col.at]
    inc = a==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> b==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> col:dist(a,b) 
    d   = d + inc^the.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d / (#i.base.cols.x)) ^ (<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.around</span><span class="hljs-params">(i,rows)</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(map(rows <span class="hljs-keyword">or</span> i.base.rows, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(j)</span></span> <span class="hljs-keyword">return</span> {dist=i-j,row=j} <span class="hljs-keyword">end</span>), 
              lt<span class="hljs-string">&quot;dist&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h3 id="cols">COLS</h3>
<ul>
<li>Factory for converting column <code>names</code> to <code>NUM</code>s ad <code>SYM</code>s. </li>
<li>Store all columns in – <code>all</code>, and for all columns we are not skipping, 
store the independent and dependent columns distributions in <code>x</code> and <code>y</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>COLS=obj<span class="hljs-string">&quot;COLS&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,names,     head,row,col)</span></span>
  i.names=names; i.all={}; i.y={}; i.x={}
  <span class="hljs-keyword">for</span> at,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(names) <span class="hljs-keyword">do</span>
    col       = push(i.all, (txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(at, txt))
    col.goalp = txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span> 
      <span class="hljs-keyword">if</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span> <span class="hljs-keyword">then</span> i.klass=col <span class="hljs-keyword">end</span>
      push(col.goalp <span class="hljs-keyword">and</span> i.y <span class="hljs-keyword">or</span> i.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <h3 id="egs">EGS</h3>
<ul>
<li>For a stream of <code>add</code>itions, incrementally store rows, summarized in <code>cols</code>.</li>
<li>When <code>add</code>ing, build new rows for new data. Otherwise reuse rows across 
multiple sets of examples.</li>
<li>Supporting <code>copy</code>ing of this structure, without or without rows of data.</li>
<li>Report how much this set of examples <code>like</code> a new row.   </li>
<li>Discretize columns as <code>ranges</code> that distinguish two sets of rows 
(merging irrelevant distinctions).</li>
<li>Summarize the <code>mid</code>point of these examples.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>EGS=obj<span class="hljs-string">&quot;EGS&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,names)</span></span> i.rows,i.cols = {}, COLS(names) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.load</span><span class="hljs-params">(f,   i)</span></span>
  <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(the.file) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> i <span class="hljs-keyword">then</span> i:add(row) <span class="hljs-keyword">else</span> i=EGS(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,row,    cells)</span></span> 
  cells = push(i.rows, row.cells <span class="hljs-keyword">and</span> row <span class="hljs-keyword">or</span> ROW(i,row)).cells
  <span class="hljs-keyword">for</span> n,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.all) <span class="hljs-keyword">do</span> col:add(cells[n]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i,cols)</span></span> 
  <span class="hljs-keyword">return</span> map(cols <span class="hljs-keyword">or</span> i.cols.y, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span> <span class="hljs-keyword">return</span> c:mid() <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.copy</span><span class="hljs-params">(i,rows,  j)</span></span>
  j=EGS(i.cols.names); <span class="hljs-keyword">for</span> __,r <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> j:add(r) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.like</span><span class="hljs-params">(i,t,overall, nHypotheses,      c)</span></span>
  prior = (#i.rows + the.k) / (overall + the.k * nHypotheses)
  like  = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(prior)
  <span class="hljs-keyword">for</span> at,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
    c=i.cols.all.at[at]
    <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> c.goalp <span class="hljs-keyword">then</span>
      like = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(col:like(x)) + like <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> like <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> _merge, _xpand, _ranges
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.ranges</span><span class="hljs-params">(i,one,two,   t)</span></span>
  t={}; <span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.x) <span class="hljs-keyword">do</span> t[c.at]=_ranges(c,one,two) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_ranges</span><span class="hljs-params">(col,yes,no,    out,x,d)</span></span>
  out = {}
  <span class="hljs-keyword">for</span> _,what <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{{rows=yes, klass=<span class="hljs-literal">true</span>}, {rows=no, klass=<span class="hljs-literal">false</span>}} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(what.rows) <span class="hljs-keyword">do</span> x = row.cells[col.at]; <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      d = col:discretize(x,the.bins)
      out[d] = out[d] <span class="hljs-keyword">or</span> RANGE{col,x,x}
      out[d]:add(x, what.klass) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> _xpand(_merge(<span class="hljs-built_in">sort</span>(out)))  <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_merge</span><span class="hljs-params">(b4,        a,b,c,j,n,tmp)</span></span>
  j,n,tmp = <span class="hljs-number">1</span>,#b4,{}
  <span class="hljs-keyword">while</span> j&lt;=n <span class="hljs-keyword">do</span> 
    a, b = b4[j], b4[j+<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> b <span class="hljs-keyword">then</span> c = a:merged(b); <span class="hljs-keyword">if</span> c <span class="hljs-keyword">then</span> a,j = c,j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    tmp[#tmp+<span class="hljs-number">1</span>] = a
    j = j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> #tmp==#b4 <span class="hljs-keyword">and</span> tmp <span class="hljs-keyword">or</span> _merge(tmp) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpand</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#t <span class="hljs-keyword">do</span> t[j].lo=t[j<span class="hljs-number">-1</span>].hi <span class="hljs-keyword">end</span>; t[<span class="hljs-number">1</span>].lo, t[#t].hi= -big,big;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <h2 id="demos">DEMOS</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> go,no={},{}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Convert help string to a table. Check command line for any updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">these</span><span class="hljs-params">(f1,f2,k,x)</span></span>
  <span class="hljs-keyword">for</span> n,flag <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> flag==f1 <span class="hljs-keyword">or</span> flag==f2 <span class="hljs-keyword">then</span>
    x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  the[k] = string2thing(x) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Run the demos, resetting settings and random number see before each.
Return number of failures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">demos</span><span class="hljs-params">(    fails,names,defaults,status)</span></span>
  fails=<span class="hljs-number">0</span>     <span class="hljs-comment">-- this code will return number of failures</span>
  names, defaults = {},{}
  <span class="hljs-keyword">for</span> k,f <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(go) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(f)==<span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> push(names,k) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(the) <span class="hljs-keyword">do</span> defaults[k]=v <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> go[the.go] <span class="hljs-keyword">then</span> names={the.go} <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> __,one <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(names))  <span class="hljs-keyword">do</span>           <span class="hljs-comment">-- for all we want to do</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(defaults) <span class="hljs-keyword">do</span> the[k]=v <span class="hljs-keyword">end</span>   <span class="hljs-comment">-- set settings to defaults</span>
    <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed <span class="hljs-keyword">or</span> <span class="hljs-number">10019</span>)           <span class="hljs-comment">-- reset random number seed</span>
    <span class="hljs-built_in">io</span>.<span class="hljs-built_in">stderr</span>:<span class="hljs-built_in">write</span>(<span class="hljs-string">&quot;.&quot;</span>)
    <span class="hljs-built_in">status</span> = go[one]()                           <span class="hljs-comment">-- run demo</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">status</span> ~= <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-- Error&quot;</span>,one,<span class="hljs-built_in">status</span>) 
      fails = fails + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>                  <span class="hljs-comment">-- update fails</span>
  <span class="hljs-keyword">return</span> fails <span class="hljs-keyword">end</span>                               <span class="hljs-comment">-- return total failure count</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Simple stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span>     <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(the.bins)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.sort</span><span class="hljs-params">(  t)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>==<span class="hljs-built_in">sort</span>({<span class="hljs-number">100</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">10</span>,<span class="hljs-number">0</span>})[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.num</span><span class="hljs-params">(     n,mu,sd)</span></span> 
  n, mu, sd = NUM(), <span class="hljs-number">10</span>, <span class="hljs-number">1</span>
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10</span>^<span class="hljs-number">4</span> <span class="hljs-keyword">do</span>
    n:add(mu+sd*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">-2</span>*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(rand()))*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">cos</span>(<span class="hljs-number">2</span>*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">pi</span>*rand())) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(n.mu - mu) &lt; <span class="hljs-number">0.05</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(n.sd - sd) &lt; <span class="hljs-number">0.5</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Can we read rows off the disk?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.rows</span><span class="hljs-params">( n,m)</span></span>
  m,n=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(the.file) <span class="hljs-keyword">do</span> m=m+<span class="hljs-number">1</span>; n=n+#row; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> n/m==<span class="hljs-number">8</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>Can we turn a list of names into columns?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.cols</span><span class="hljs-params">(  i)</span></span>
  i=COLS{<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;Age&quot;</span>,<span class="hljs-string">&quot;ShoeSize-&quot;</span>}
  <span class="hljs-keyword">return</span> i.y[<span class="hljs-number">1</span>].w == <span class="hljs-number">-1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Can we read data, summazized as columns?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.egs</span><span class="hljs-params">(  it)</span></span>
  it = EGS.<span class="hljs-built_in">load</span>(the.file); <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(<span class="hljs-number">2970</span> - it.cols.y[<span class="hljs-number">1</span>].mu) &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>Can we discretize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.ranges</span><span class="hljs-params">(  it,n,a,b)</span></span>
  it = EGS.<span class="hljs-built_in">load</span>(the.file)
  <span class="hljs-built_in">print</span>(oo(rnds(it:mid())))
  it.rows = <span class="hljs-built_in">sort</span>(it.rows)
  n = (#it.rows)^<span class="hljs-number">.5</span>  
  a,b = slice(it.rows,<span class="hljs-number">1</span>,n), slice(it.rows,n+<span class="hljs-number">1</span>,#it.rows,<span class="hljs-number">3</span>*n)
  <span class="hljs-built_in">print</span>(o(rnds(it:copy(a):mid())), o(rnds(it:copy(b):mid())))</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>oo(a:mid())
oo(b:mid())</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(<span class="hljs-number">2970</span> - it.cols.y[<span class="hljs-number">1</span>].mu) &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <h2 id="main">Main</h2>
<ul>
<li>Parse help text for flags and defaults, check CLI for updates. </li>
<li>Maybe print the help (with some pretty colors). </li>
<li>Run the demos. </li>
<li>Check for rogue vars.</li>
<li>Exit, reporting number of failures.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n  ([-][^%s]+)[%s]+([-][-]([^%s]+))[^\n]*%s([^%s]+)&quot;</span>,these)
<span class="hljs-keyword">if</span> the.help <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">print</span>(help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;%u%u+&quot;</span>, <span class="hljs-string">&quot;\27[31m%1\27[0m&quot;</span>)
            :<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;(%s)([-][-]?[^%s]+)(%s)&quot;</span>,<span class="hljs-string">&quot;%1\27[33m%2\27[0m%3&quot;</span>),<span class="hljs-string">&quot;&quot;</span>)
<span class="hljs-keyword">else</span> 
  <span class="hljs-keyword">local</span> fails = demos()
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span>  <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(fails) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
