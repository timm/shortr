<!DOCTYPE html>

<html>
<head>
  <title>tweak.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
<a href="tricks.html">tricks</a>
::   <a href="think.html">think</a> 
:: &copy;2022, <a href="mailto:timm@ieee.org">Tim Menzies</a>
<hr><img 
align=right width=250 src=heads2.png>
<a 
href="https://zenodo.org/badge/latestdoi/206205826"> <img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> <img 
src="https://img.shields.io/badge/platform-osx,linux-informational?logo=linux&logoColor=white&color=red"> <img 
src="https://img.shields.io/badge/purpose-se,ai-informational?logo=hyper&logoColor=white&color=orange"> <img 
src="https://img.shields.io/badge/language-lua-informational?logo=lua&logoColor=white&color=yellow"> <a
href="https://github.com/timm/l5/actions/workflows/tests.yml"><img src="https://github.com/timm/l5/actions/workflows/tests.yml/badge.svg"></a><br><a
href="https://github.com/timm/l5/blob/master/LICENSE.md#top"><img src="https://img.shields.io/badge/license-BSD2-informational?logo=adblock&logoColor=white&color=blueviolet"></a>
<br>

                  <h1>tweak.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>vim: filetype=lua ts=2 sw=2 et:
(c) 2022, Tim Menzies,  <a href="mailto:&#116;&#x69;&#109;&#109;&#64;&#105;&#101;&#x65;&#x65;&#x2e;&#x6f;&#114;&#x67;">&#116;&#x69;&#109;&#109;&#64;&#105;&#101;&#x65;&#x65;&#x2e;&#x6f;&#114;&#x67;</a>, opensource.org/licenses/Fair
Usage of the works is permitted provided that this instrument is retained
with the works, so that any entity that uses the works is notified of this
instrument.  DISCLAIMER: THE WORKS ARE WITHOUT WARRANTY.
    __                                     __<br>   /\ __                                 /\ \<br>   \ \ ,<em>\   __  __  __     __      _     \ \ /‘\<br>    \ \ /  /\ /\ /\ \  /‘<strong><code>\  /&#39;__</code>\   \ \ , &lt;<br>     \ \ _ \ \ _/ _/ /\  <strong>/ /\ \L._  \ \ \`\<br>      \ _<em>\ \ _<strong>x</strong></em>/‘\ _<strong><em>\ _</em>/._\  \ _\ _<br>       /</strong>/  /__//</strong>/   /____/ /</strong>//</em>/   /<em>//</em>/</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">local</span> help= <span class="hljs-string">[[
tweak: tries three weak learners for multi-objective optimization
(c) 2022, Tim Menzies,  timm@ieee.org, opensource.org/licenses/Fair

learner1: n times, discard half the data furthest from best 
learner2: classify data according to presence of survivors of learner1
learner3: run learner1 on best &quot;best&quot; found by learner2

USAGE:
  alias twk=&quot;lua tweak.lua &quot;
  twk [OPTIONS]

OPTIONS:
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>boot    -b  size of bootstrap           = 512
cohen   -c  cohen                       = .35
conf    -C  statistical confidence      = 0.05
cliffs  -l  cliff’s delta               = 0.147
K       -K  manage low class counts     = 1
M       -M  manage low evidence counts  = 2
far     -F  how far to go for far       = .95
p       -p  coefficient on distance     = 2
seed    -S  seed                        = 10019
some    -s  sample size for distances   = 512
stop    -T  how far to go for far       = 20
min     -m  size of min space           = .5
best    -B  best percent                = .05</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
OPTIONS (other):</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>dump    -d  dump stack+exit on error    = false
file    -f  file name                   = ../etc/data/auto93.csv
help    -h  show help                   = false
rnd     -r  rounding numbers            = %5.3f
go      -g  start up action             = nothing]] –[[</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
ABOUT THE CODE:
- Settings generated from <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-built_in">string</span>
  - Settings can be updated from the strings seed <span class="hljs-keyword">in</span> flags
  - Settings stored <span class="hljs-keyword">in</span> the global <span class="hljs-string">&quot;the&quot;</span>

- Layout code <span class="hljs-keyword">in</span> chunks of size <span class="hljs-number">120</span> <span class="hljs-built_in">lines</span> (<span class="hljs-built_in">max</span>), broken by line-feed
  - Chunk1=header; Chunk2=utils; Chunk3=objects; Chunk(last)=demos+start-up
- Layout <span class="hljs-built_in">lines</span> <span class="hljs-number">80</span> chars side (<span class="hljs-built_in">max</span>)
  - So use <span class="hljs-number">2</span> spaces <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;tab&quot;</span>
- Do functions as one-liners (<span class="hljs-keyword">if</span> possible)
- In order to define code <span class="hljs-keyword">in</span> any order:
  - Near the top, define all <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">and</span> <span class="hljs-title">Object</span> <span class="hljs-title">names</span> <span class="hljs-title">as</span> &quot;<span class="hljs-title">local</span>&quot;
- <span class="hljs-title">Otherwise</span>, <span class="hljs-title">don</span>&#x27;<span class="hljs-title">t</span> <span class="hljs-title">use</span> <span class="hljs-title">the</span> &quot;<span class="hljs-title">local</span>&quot; <span class="hljs-title">keyword</span> <span class="hljs-params">(too ugly)</span></span>

- Minimize use of map (hard to <span class="hljs-built_in">debug</span>)
- Object names are short <span class="hljs-keyword">and</span> UPPER CASE
- Private object slots (that should <span class="hljs-keyword">not</span> be printed) start with <span class="hljs-string">&quot;_&quot;</span>.
- Constructors need <span class="hljs-keyword">not</span> <span class="hljs-keyword">return</span> constructed instance.
- No inheritance (hard to <span class="hljs-built_in">debug</span>)
- For code with many parameters, pass <span class="hljs-keyword">in</span> a dictionary with named fields.

- Tests  <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;go&quot;</span> <span class="hljs-built_in">table</span> at <span class="hljs-keyword">end</span>. Reset settings to defaults after each.
- Tests check <span class="hljs-keyword">for</span> <span class="hljs-built_in">error</span> conditions using <span class="hljs-string">&quot;ok&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-string">&quot;assert&quot;</span>.
- Command line <span class="hljs-string">&quot;-d -go x&quot;</span> crashed <span class="hljs-keyword">if</span> test <span class="hljs-string">&quot;x&quot;</span> fails, shows stack <span class="hljs-built_in">dump</span>.
- Command line <span class="hljs-string">&quot;-go x&quot;</span> calls test <span class="hljs-string">&quot;go.x()&quot;</span>
- Command line <span class="hljs-string">&quot;-go all&quot;</span> calls all tests.
- Command line <span class="hljs-string">&quot;-h&quot;</span> shows help
- Command line <span class="hljs-string">&quot;-S N&quot;</span> sets <span class="hljs-built_in">random</span> seed (so <span class="hljs-string">&quot;-S $RANDOM&quot;</span> is <span class="hljs-string">&quot;full&quot;</span> <span class="hljs-built_in">random</span>)

- <span class="hljs-number">2</span>nd last line: look <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;rogue&quot;</span> globals (there should be none)
- Last line: <span class="hljs-built_in">exit</span> to operating system with number of failures seen <span class="hljs-keyword">in</span> tests

ABOUT THE CLASSES:
- <span class="hljs-string">&quot;mean&quot;</span>,<span class="hljs-string">&quot;mode&quot;</span> are generalized to <span class="hljs-string">&quot;mid&quot;</span> (i.e. <span class="hljs-string">&quot;mid-point&quot;</span>)
- <span class="hljs-string">&quot;standard deviation&quot;</span>,<span class="hljs-string">&quot;entropy&quot;</span> are generalized  to <span class="hljs-string">&quot;div&quot;</span> (i.e. <span class="hljs-string">&quot;diversity&quot;</span>)

- BIN holds the class labels seen between <span class="hljs-string">&quot;lo&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;hi&quot;</span>.
- EGS (examples) hold many ROWs, summarized <span class="hljs-keyword">in</span> SYMbolic <span class="hljs-keyword">or</span> NUMeric  columns. 
- COLS is a factory <span class="hljs-keyword">for</span> turning column names into NUMs <span class="hljs-keyword">or</span> SYMs.
  - Numeric names start with <span class="hljs-built_in">upper</span> case
  - Goal names ending with <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>+ get weights <span class="hljs-number">-1</span>,<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> minimize,maximize
  - Non-numeric class names <span class="hljs-keyword">end</span> with <span class="hljs-string">&quot;!&quot;</span>
  - Columns to be skipped have a name ending with <span class="hljs-string">&quot;:&quot;</span>
  - Non-skipped columns are divided into COLS.y <span class="hljs-keyword">and</span> COLS.x (<span class="hljs-keyword">for</span> goal <span class="hljs-keyword">and</span> other)
- <span class="hljs-string">&quot;mid&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;div&quot;</span> <span class="hljs-keyword">for</span> EGS are computed recursively by <span class="hljs-string">&quot;mid,div&quot;</span> <span class="hljs-keyword">in</span> NUMs,SYMs
- distances between two rows is computed recursively via <span class="hljs-string">&quot;dist&quot;</span> <span class="hljs-keyword">in</span> NUMs,SYMs

- ROW1 before ROW2 (i.e. ROW1&lt;ROW2) <span class="hljs-keyword">if</span> its goals dominate (using [CDOM])
- ROWs are recursively separated <span class="hljs-keyword">and</span> clustered by [FASTMAP] <span class="hljs-built_in">random</span> projections
- The distance between two ROWs (i.e. ROW1-ROW2) uses [AHA].
- To save space, ROWs are made once but can be passed around different EGS.
- ROWs have a <span class="hljs-string">&quot;_data&quot;</span> pointer where it gets <span class="hljs-string">&quot;lo,hi&quot;</span> info needed <span class="hljs-keyword">for</span> distances.
  - For consistency, <span class="hljs-string">&quot;_data&quot;</span> is set to the first EGS that holds that row.

REFERENCES:
- [AHA]    : Aha       : doi.org/<span class="hljs-number">10.1007</span>/BF00153759
- [CDOM]   : Zitzler   : doi.org/<span class="hljs-number">10.1145</span>/<span class="hljs-number">1830483.1830578</span>
- [FASTMAP]: Faloutsos : doi.org/<span class="hljs-number">10.1145</span>/<span class="hljs-number">568271.223812</span>      <span class="hljs-comment">--]]</span>

<span class="hljs-keyword">local</span> the,any,cells,copy,csv,fmt,fu,lt,many,map,normal = {}
<span class="hljs-keyword">local</span> o,obj,ok,oo,per,push,R,rnd,rnds,shuffle,<span class="hljs-built_in">sort</span>,slice,stats,string2thing
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">string2thing</span><span class="hljs-params">(x)</span></span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>

help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n  ([-][-]([^%s]+))[%s]+(-[^%s]+)[^\n]*%s([^%s]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f1,k,f2,x)</span></span>
  <span class="hljs-keyword">for</span> n,flag <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> flag==f1 <span class="hljs-keyword">or</span> flag==f2 <span class="hljs-keyword">then</span>
    x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  the[k] = string2thing(x) <span class="hljs-keyword">end</span>) 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(src)</span></span>
  src = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(src)
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line, row)</span></span> 
    line=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line <span class="hljs-keyword">then</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(src) <span class="hljs-keyword">else</span>
      row={}; <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> line:<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span> row[<span class="hljs-number">1</span>+#row]=string2thing(x) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(t,    j)</span></span>
  <span class="hljs-keyword">for</span> i = #t, <span class="hljs-number">2</span>, <span class="hljs-number">-1</span> <span class="hljs-keyword">do</span>
    j=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>(i); t[i], t[j] = t[j], t[i]; <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

R = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fu</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>   <span class="hljs-keyword">return</span> a[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lt</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &lt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normal</span><span class="hljs-params">(mu,sd)</span></span> 
  <span class="hljs-keyword">return</span> mu + sd*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">-2</span>*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(R()))*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">cos</span>(<span class="hljs-number">2</span>*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">pi</span>*R()) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">any</span><span class="hljs-params">(a, i)</span></span>    i=R()*#a//<span class="hljs-number">1</span>; i=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(i,#a)); <span class="hljs-keyword">return</span> a[i] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">many</span><span class="hljs-params">(a,n, u)</span></span> u={}; <span class="hljs-keyword">for</span> j=<span class="hljs-number">1</span>,n <span class="hljs-keyword">do</span>        u[<span class="hljs-number">1</span>+#u]= any(a) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f, u)</span></span>  u={}; <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(v) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">per</span><span class="hljs-params">(t,p, i)</span></span>  i=(p <span class="hljs-keyword">or</span><span class="hljs-number">.5</span>)*#t//<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> t[<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(#t,i))] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span>    t[<span class="hljs-number">1</span>+#t]=x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span>    <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f) <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slice</span><span class="hljs-params">(t,i,j,   u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> k=(i <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>), (j <span class="hljs-keyword">or</span> #t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = t[k] <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span><span class="hljs-params">(t,   u)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
  u={};<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[copy(k)]=copy(v) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(u,<span class="hljs-built_in">getmetatable</span>(t)) <span class="hljs-keyword">end</span>

fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oo</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">print</span>(o(t)) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,    u,one,hide,sorted)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(t) ~= <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(t) <span class="hljs-keyword">end</span>
  sorted = #t&gt;<span class="hljs-number">0</span> <span class="hljs-comment">-- true when array&#x27;s indexes are 1,2...#t</span>
  hide= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">tostring</span>(k):<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) == <span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">end</span>
  one = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span></span> <span class="hljs-keyword">return</span> sorted <span class="hljs-keyword">and</span> <span class="hljs-built_in">tostring</span>(v) <span class="hljs-keyword">or</span> fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,k,v) <span class="hljs-keyword">end</span>
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hide(k) <span class="hljs-keyword">then</span> u[<span class="hljs-number">1</span>+#u] = one(k,v) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (t.is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(sorted <span class="hljs-keyword">and</span> u <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(u),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnds</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-keyword">return</span> map(t, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> rnd(x,f) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(x,f)</span></span> 
  <span class="hljs-keyword">return</span> fmt(<span class="hljs-built_in">type</span>(x)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> (x~=x//<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> f <span class="hljs-keyword">or</span> the.rnd) <span class="hljs-keyword">or</span><span class="hljs-string">&quot;%s&quot;</span>,x) <span class="hljs-keyword">end</span>


<span class="hljs-keyword">local</span> _id=<span class="hljs-number">0</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">id</span><span class="hljs-params">()</span></span> _id=_id+<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> _id <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(name,    t,new)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(kl,...)</span></span> 
   <span class="hljs-keyword">local</span> x=<span class="hljs-built_in">setmetatable</span>({id=id()},kl); kl.new(x,...); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> 
  t = {<span class="hljs-built_in">__tostring</span>=o, is=name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>}; t.<span class="hljs-built_in">__index</span>=t
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(t, {<span class="hljs-built_in">__call</span>=new}) <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> SOME,SYM,BIN,NUM,COLS = obj<span class="hljs-string">&quot;SOME&quot;</span>,obj<span class="hljs-string">&quot;SYM&quot;</span>,obj<span class="hljs-string">&quot;BIN&quot;</span>,obj<span class="hljs-string">&quot;NUM&quot;</span>,obj<span class="hljs-string">&quot;COLS&quot;</span>
<span class="hljs-keyword">local</span> ROW,EGS,GO            = obj<span class="hljs-string">&quot;ROW&quot;</span>, obj<span class="hljs-string">&quot;EGS&quot;</span>, obj<span class="hljs-string">&quot;GO&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME:new</span><span class="hljs-params">()</span></span> <span class="hljs-built_in">self</span>.kept, <span class="hljs-built_in">self</span>.ok, <span class="hljs-built_in">self</span>.n = {}, <span class="hljs-literal">false</span>,<span class="hljs-number">0</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME:add</span><span class="hljs-params">(x,     a)</span></span> 
  <span class="hljs-built_in">self</span>.n, a = <span class="hljs-number">1</span> + <span class="hljs-built_in">self</span>.n, <span class="hljs-built_in">self</span>.kept
  <span class="hljs-keyword">if</span>     #a  &lt; the.some        <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">false</span>; push(a,x)  
  <span class="hljs-keyword">elseif</span> R() &lt; the.some/<span class="hljs-built_in">self</span>.n <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">false</span>; a[R(#a)]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME:has</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.ok <span class="hljs-keyword">then</span> <span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.kept) <span class="hljs-keyword">end</span>;<span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">true</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.kept <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:new</span><span class="hljs-params">(pos,s)</span></span> 
  <span class="hljs-built_in">self</span>.pos, <span class="hljs-built_in">self</span>.txt= pos <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span> 
  <span class="hljs-built_in">self</span>.n, <span class="hljs-built_in">self</span>.has, <span class="hljs-built_in">self</span>.most, <span class="hljs-built_in">self</span>.mode = <span class="hljs-number">0</span>,{},<span class="hljs-number">0</span>,<span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:sub</span><span class="hljs-params">(x,inc)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:add(x, -(inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)) <span class="hljs-keyword">end</span>     
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:add</span><span class="hljs-params">(x,inc)</span></span>    
  <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
    inc = inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + inc
    <span class="hljs-built_in">self</span>.has[x] = (<span class="hljs-built_in">self</span>.has[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) + inc
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.has[x] &gt; <span class="hljs-built_in">self</span>.most <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.most,<span class="hljs-built_in">self</span>.mode = <span class="hljs-built_in">self</span>.has[x],x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mode <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:div</span><span class="hljs-params">(   e)</span></span> 
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,m <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.has) <span class="hljs-keyword">do</span>
         <span class="hljs-keyword">if</span> m&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> e = e-m/<span class="hljs-built_in">self</span>.n * <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(m/<span class="hljs-built_in">self</span>.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:__add</span><span class="hljs-params">(other,    out)</span></span>
  out = SYM(<span class="hljs-built_in">self</span>.pos,<span class="hljs-built_in">self</span>.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.has) <span class="hljs-keyword">do</span> out:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(other.has) <span class="hljs-keyword">do</span> out:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:dist</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:bins</span><span class="hljs-params">(rows,     out,known,x)</span></span>
  out,known = {},{}
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
    x = row.cells[<span class="hljs-built_in">self</span>.pos]
    <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      known[x] = known[x] <span class="hljs-keyword">or</span> push(out, BIN({txt=<span class="hljs-built_in">self</span>.txt,  pos=<span class="hljs-built_in">self</span>.pos,
                                                lo=x ,hi=x, ys=SYM()})) 
      known[x].ys:add(row.klass) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:new</span><span class="hljs-params">(pos,s)</span></span> 
  <span class="hljs-built_in">self</span>.pos, <span class="hljs-built_in">self</span>.txt, <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi = pos <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>,<span class="hljs-number">1E32</span>, <span class="hljs-number">-1E32</span>
  <span class="hljs-built_in">self</span>.n, <span class="hljs-built_in">self</span>.some = <span class="hljs-number">0</span>,SOME()
  <span class="hljs-built_in">self</span>.mu, <span class="hljs-built_in">self</span>.m2, <span class="hljs-built_in">self</span>.sd = <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
  <span class="hljs-built_in">self</span>.w = <span class="hljs-built_in">self</span>.txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:add</span><span class="hljs-params">(x,   _,d)</span></span> 
  <span class="hljs-keyword">if</span> x ~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">self</span>.some:add(x)
    <span class="hljs-built_in">self</span>.n  = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
    <span class="hljs-built_in">self</span>.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(x, <span class="hljs-built_in">self</span>.lo)
    <span class="hljs-built_in">self</span>.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(x, <span class="hljs-built_in">self</span>.hi) 
    d       = x - <span class="hljs-built_in">self</span>.mu
    <span class="hljs-built_in">self</span>.mu = <span class="hljs-built_in">self</span>.mu + d/<span class="hljs-built_in">self</span>.n
    <span class="hljs-built_in">self</span>.m2 = <span class="hljs-built_in">self</span>.m2 + d*(x - <span class="hljs-built_in">self</span>.mu)
    <span class="hljs-built_in">self</span>.sd = (<span class="hljs-built_in">self</span>.n&lt;<span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.m2&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (<span class="hljs-built_in">self</span>.m2/(<span class="hljs-built_in">self</span>.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>does the has() sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> per(<span class="hljs-built_in">self</span>.some:has(),<span class="hljs-number">.5</span>)  <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:div</span><span class="hljs-params">(  a)</span></span>
  a=<span class="hljs-built_in">self</span>.some:has()
  <span class="hljs-keyword">return</span> #a&lt;=<span class="hljs-number">10</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.sd <span class="hljs-keyword">or</span> (per(a,<span class="hljs-number">.9</span>)-per(a,<span class="hljs-number">.1</span>))/<span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:same</span><span class="hljs-params">(x,y)</span></span> 
  <span class="hljs-built_in">print</span>(<span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y), <span class="hljs-built_in">self</span>:div()*the.cohen)
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) &lt; <span class="hljs-built_in">self</span>:div()*the.cohen <span class="hljs-keyword">end</span>
  
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:merge</span><span class="hljs-params">(other,    out)</span></span>
  out = NUM(<span class="hljs-built_in">self</span>.pos,<span class="hljs-built_in">self</span>.txt)
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.some.kept)  <span class="hljs-keyword">do</span> out:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(other.some.kept) <span class="hljs-keyword">do</span> out:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:norm</span><span class="hljs-params">(x,   lo,hi)</span></span>
  lo,hi= <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span> hi-lo &lt; <span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x - lo)/(hi - lo) <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:dist</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span>            <span class="hljs-keyword">then</span> y = <span class="hljs-built_in">self</span>:norm(y); x = y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span>            <span class="hljs-keyword">then</span> x = <span class="hljs-built_in">self</span>:norm(x); y = x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span> x,y = <span class="hljs-built_in">self</span>:norm(x), <span class="hljs-built_in">self</span>:norm(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x - y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:bins</span><span class="hljs-params">(rows,      xy,div,xys,epsilon,small,b4,out)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xy</span><span class="hljs-params">(row, x)</span></span> 
    x=row.cells[<span class="hljs-built_in">self</span>.pos]; <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> {x=x,y=row.klass} <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">div</span><span class="hljs-params">(lo,hi,        x,y,cut,lhs,rhs,tmp,best,overall)</span></span>
    lhs, rhs, overall = SYM(), SYM(), SYM()
    <span class="hljs-keyword">for</span> i=lo,hi <span class="hljs-keyword">do</span> overall:add( rhs:add(xys[i].y) ) <span class="hljs-keyword">end</span>
    best = rhs:div()
    <span class="hljs-keyword">for</span> i=lo,hi <span class="hljs-keyword">do</span>
      x, y = xys[i].x, xys[i].y
      lhs:add( rhs:<span class="hljs-built_in">sub</span>( y) )
      <span class="hljs-keyword">if</span> lhs.n &gt; small <span class="hljs-keyword">and</span> rhs.n &gt; small <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> x ~= xys[i+<span class="hljs-number">1</span>].x <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">if</span> x - xys[lo].x &gt; epsilon <span class="hljs-keyword">and</span> xys[hi].x - x &gt; epsilon <span class="hljs-keyword">then</span>
            tmp = (lhs.n*lhs:div() + rhs.n*rhs:div())  / (lhs.n + rhs.n)
            <span class="hljs-keyword">if</span> tmp &lt; best <span class="hljs-keyword">then</span>
              best,cut = tmp,i <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span>   cut 
    <span class="hljs-keyword">then</span> div(lo,    cut)
         div(cut+<span class="hljs-number">1</span>, hi)
    <span class="hljs-keyword">else</span> b4= push(out, BIN({txt=<span class="hljs-built_in">self</span>.txt, pos=<span class="hljs-built_in">self</span>.pos, lo=b4, 
                               hi=xys[hi].x, ys=overall})).hi <span class="hljs-keyword">end</span> 
  xys     = <span class="hljs-built_in">sort</span>(map(rows,xy), lt<span class="hljs-string">&quot;x&quot;</span>)
  b4,out  = -<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>, {}
  epsilon = (per(xys,<span class="hljs-number">.9</span>).x - per(xys,<span class="hljs-number">.1</span>).x) / <span class="hljs-number">2.56</span>*the.cohen
  small   = (#xys)^the.<span class="hljs-built_in">min</span>
  div(<span class="hljs-number">1</span>, #xys) 
  out[#out].hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:new</span><span class="hljs-params">(names,       it,num,sym,col)</span></span>
  <span class="hljs-built_in">self</span>.names, <span class="hljs-built_in">self</span>.x, <span class="hljs-built_in">self</span>.y, <span class="hljs-built_in">self</span>.all = names, {},{},{}
  <span class="hljs-keyword">for</span> pos,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(names) <span class="hljs-keyword">do</span> 
    col = push(<span class="hljs-built_in">self</span>.all, (txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(pos,txt))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.klass = col <span class="hljs-keyword">end</span>
      push(txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[-+!]$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.y <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:new</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-built_in">self</span>.pos, <span class="hljs-built_in">self</span>.txt  = t.pos, t.txt
  <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi, <span class="hljs-built_in">self</span>.ys = t.lo, t.hi, t.ys <span class="hljs-keyword">or</span> SYM() <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:__tostring</span><span class="hljs-params">()</span></span>
  <span class="hljs-keyword">local</span> x,lo,hi,big = <span class="hljs-built_in">self</span>.txt, <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi, <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt;= %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s &lt; %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:select</span><span class="hljs-params">(t)</span></span>
  t = t.cells <span class="hljs-keyword">and</span> t.cells <span class="hljs-keyword">or</span> t
  <span class="hljs-keyword">local</span> x, lo, hi = t[<span class="hljs-built_in">self</span>.pos], <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> lo == hi <span class="hljs-keyword">and</span> lo == x <span class="hljs-keyword">or</span> lo &lt;= x <span class="hljs-keyword">and</span> x &lt; hi <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:of</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.ys.has[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW:new</span><span class="hljs-params">(data,t)</span></span>
  <span class="hljs-built_in">self</span>._data,<span class="hljs-built_in">self</span>.cells, <span class="hljs-built_in">self</span>.evaluated,<span class="hljs-built_in">self</span>.rank,<span class="hljs-built_in">self</span>.klass = data,t,<span class="hljs-literal">false</span>,<span class="hljs-number">0</span>, <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW:__sub</span><span class="hljs-params">(other,    cols,d,inc)</span></span>
  d, cols = <span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>._data.cols.x
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span>
    inc = col:dist(<span class="hljs-built_in">self</span>.cells[col.pos], other.cells[col.pos]) 
    d   = d + inc^the.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d / #cols) ^ (<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW:__lt</span><span class="hljs-params">(other,   s1,s2,e,y,a,b)</span></span>
  y= <span class="hljs-built_in">self</span>._data.cols.y
  s1, s2, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(y) <span class="hljs-keyword">do</span>
     a = col:norm(<span class="hljs-built_in">self</span>.cells[col.pos])
     b = col:norm(other.cells[col.pos])
     s1= s1 - e^(col.w * (a - b) / #y)
     s2= s2 - e^(col.w * (b - a) / #y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#y &lt; s2/#y  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW:around</span><span class="hljs-params">(rows,   rowGap)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rowGap</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> {row=row, gap=<span class="hljs-built_in">self</span> - row} <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(map(rows <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.data.rows, rowGap), lt<span class="hljs-string">&quot;gap&quot;</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW:far</span><span class="hljs-params">(rows)</span></span> <span class="hljs-keyword">return</span> per(<span class="hljs-built_in">self</span>:around(rows), the.far).row <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:new</span><span class="hljs-params">()</span></span>   <span class="hljs-built_in">self</span>.rows,<span class="hljs-built_in">self</span>.cols = {},<span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:load</span><span class="hljs-params">(f)</span></span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> csv(f) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(t) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:mid</span><span class="hljs-params">(t)</span></span>  <span class="hljs-keyword">return</span> map(t <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span><span class="hljs-keyword">return</span> c:mid()<span class="hljs-keyword">end</span>)<span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:div</span><span class="hljs-params">(t)</span></span>  <span class="hljs-keyword">return</span> map(t <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span><span class="hljs-keyword">return</span> c:div()<span class="hljs-keyword">end</span>)<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:ranks</span><span class="hljs-params">(      any, all,first,now,n)</span></span>
  <span class="hljs-keyword">for</span> i,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.rows)) <span class="hljs-keyword">do</span> row.rank = (<span class="hljs-number">100</span>*i/#<span class="hljs-built_in">self</span>.rows)//<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:evaluated</span><span class="hljs-params">(rows,  n)</span></span>
  n=<span class="hljs-number">0</span>;<span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.rows) <span class="hljs-keyword">do</span> n=n+(row.evaluated <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)<span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> n <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:add</span><span class="hljs-params">(t)</span></span>
  <span class="hljs-keyword">if</span>   <span class="hljs-built_in">self</span>.cols 
  <span class="hljs-keyword">then</span> t = push(<span class="hljs-built_in">self</span>.rows, t.cells <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> ROW(<span class="hljs-built_in">self</span>,t)).cells
       <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.cols.all) <span class="hljs-keyword">do</span> col:add(t[col.pos]) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span> <span class="hljs-built_in">self</span>.cols = COLS(t) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:clone</span><span class="hljs-params">(rows, out)</span></span>
  out=EGS():add(<span class="hljs-built_in">self</span>.cols.names)
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> out:add(row) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:sway</span><span class="hljs-params">(rows,x,stop,rest,           rxs,some,y,c,best,mid)</span></span>
  rows = rows <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.rows
  stop = stop <span class="hljs-keyword">or</span> <span class="hljs-number">2</span>*the.best*#rows
  rest = rest <span class="hljs-keyword">or</span> {}
  <span class="hljs-keyword">if</span> #rows &lt;= stop <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows,rest,x <span class="hljs-keyword">end</span>
  some = many(rows,the.some)
  x    = x <span class="hljs-keyword">or</span> any(some):far(some)
  y    =      x:far(some)
  <span class="hljs-keyword">if</span> y &lt; x <span class="hljs-keyword">then</span> x,y = y,x <span class="hljs-keyword">end</span>
  c    = x - y
  x.evaluated = <span class="hljs-literal">true</span>
  y.evaluated = <span class="hljs-literal">true</span>
  rxs = map(rows,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span> <span class="hljs-keyword">return</span> {r=r, x=((r-x)^<span class="hljs-number">2</span>+c^<span class="hljs-number">2</span>-(r-y)^<span class="hljs-number">2</span>)/(<span class="hljs-number">2</span>*c)} <span class="hljs-keyword">end</span>) 
  best= {} <span class="hljs-comment">-- things cloest to x or y, respectively</span>
  <span class="hljs-keyword">for</span> i,rx <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(rxs, lt<span class="hljs-string">&quot;x&quot;</span>)) <span class="hljs-keyword">do</span> 
    push(i&lt;=#rows*<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> best <span class="hljs-keyword">or</span> rest, rx.r) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:sway(best,x,stop,rest)  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EGS:rbins</span><span class="hljs-params">(rows,B,R,how,   v,bins,best,bests)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">v</span><span class="hljs-params">(bin,  b,r)</span></span>
    b = bin:of(<span class="hljs-literal">true</span>)  / (B+<span class="hljs-number">0.0001</span>)
    r = bin:of(<span class="hljs-literal">false</span>) / (R+<span class="hljs-number">0.0001</span>)
    <span class="hljs-keyword">return</span> b^<span class="hljs-number">2</span>/(b+r) <span class="hljs-keyword">end</span>
  how = how <span class="hljs-keyword">or</span> {}
  bins = {}
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.cols.x) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,bin <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col:bins(rows)) <span class="hljs-keyword">do</span> push(bins,bin) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  best = <span class="hljs-built_in">sort</span>(bins,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> v(a) &gt; v(b) <span class="hljs-keyword">end</span>)[<span class="hljs-number">1</span>]
  bests= map(rows,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">if</span> best:<span class="hljs-built_in">select</span>(row) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) 
  <span class="hljs-keyword">if</span>  #bests &lt; #rows 
  <span class="hljs-keyword">then</span> push(how,best)
       <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:rbins(bests,B,R,how ) 
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span>  rows,how <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ok</span><span class="hljs-params">(test,msg)</span></span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>, test <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;PASS &quot;</span><span class="hljs-keyword">or</span> <span class="hljs-string">&quot;FAIL &quot;</span>, msg <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> test <span class="hljs-keyword">then</span>
    GO.fails= GO.fails+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> the.<span class="hljs-built_in">dump</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">assert</span>(test,msg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO:new</span><span class="hljs-params">(todo,    b4,go)</span></span>
  b4={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(the) <span class="hljs-keyword">do</span> b4[k]=v <span class="hljs-keyword">end</span>
  go={}; <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(GO) <span class="hljs-keyword">do</span>
           <span class="hljs-keyword">if</span> k~=<span class="hljs-string">&quot;new&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(GO[k])==<span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> go[<span class="hljs-number">1</span>+#go]=k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  GO.fails = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(todo==<span class="hljs-string">&quot;all&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">sort</span>(go) <span class="hljs-keyword">or</span> {todo}) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(b4) <span class="hljs-keyword">do</span> the[k]=v <span class="hljs-keyword">end</span> 
    <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed)
    <span class="hljs-keyword">if</span> GO[x] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(x); GO[x]() <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.rogue</span><span class="hljs-params">( t)</span></span>
  t={}; <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{ <span class="hljs-string">&quot;_G&quot;</span>, <span class="hljs-string">&quot;_VERSION&quot;</span>, <span class="hljs-string">&quot;arg&quot;</span>, <span class="hljs-string">&quot;assert&quot;</span>, <span class="hljs-string">&quot;collectgarbage&quot;</span>,
  <span class="hljs-string">&quot;coroutine&quot;</span>, <span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-string">&quot;dofile&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;getmetatable&quot;</span>, <span class="hljs-string">&quot;io&quot;</span>, <span class="hljs-string">&quot;ipairs&quot;</span>,
  <span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-string">&quot;loadfile&quot;</span>, <span class="hljs-string">&quot;math&quot;</span>, <span class="hljs-string">&quot;next&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;package&quot;</span>, <span class="hljs-string">&quot;pairs&quot;</span>, <span class="hljs-string">&quot;pcall&quot;</span>,
  <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;rawequal&quot;</span>, <span class="hljs-string">&quot;rawget&quot;</span>, <span class="hljs-string">&quot;rawlen&quot;</span>, <span class="hljs-string">&quot;rawset&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;select&quot;</span>,
  <span class="hljs-string">&quot;setmetatable&quot;</span>, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-string">&quot;table&quot;</span>, <span class="hljs-string">&quot;tonumber&quot;</span>, <span class="hljs-string">&quot;tostring&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;utf8&quot;</span>,
  <span class="hljs-string">&quot;warn&quot;</span>, <span class="hljs-string">&quot;xpcall&quot;</span>} <span class="hljs-keyword">do</span> t[k]=<span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k, <span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.the</span><span class="hljs-params">()</span></span> oo(the) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.eg</span><span class="hljs-params">( n,out)</span></span>   
  out =<span class="hljs-literal">true</span>
  n=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(the.file) <span class="hljs-keyword">do</span> 
         n=n+<span class="hljs-number">1</span>; out=out <span class="hljs-keyword">and</span> #row==<span class="hljs-number">8</span>
                <span class="hljs-keyword">if</span> n&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> out=out <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(row[<span class="hljs-number">1</span>])==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  ok(out <span class="hljs-keyword">and</span> n==<span class="hljs-number">399</span>); <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.some</span><span class="hljs-params">( s)</span></span>
  s=SOME(); <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">10</span>^<span class="hljs-number">6</span> <span class="hljs-keyword">do</span> s:add(R(<span class="hljs-number">100</span>)) <span class="hljs-keyword">end</span>
  oo(s:has()) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.num</span><span class="hljs-params">(  n,s,t)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sd</span><span class="hljs-params">(t,  n,d,m,m2)</span></span>
    n,m,m2=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>;<span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> n=n+<span class="hljs-number">1</span>; d=x-m; m=m+d/n; m2=m2+d*(x-m) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> (m2/n)^<span class="hljs-number">0.5</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">5</span> <span class="hljs-keyword">do</span>; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>)
    s=<span class="hljs-number">2</span>; <span class="hljs-keyword">for</span> r=<span class="hljs-number">1</span>,<span class="hljs-number">6</span> <span class="hljs-keyword">do</span>
      s=s*<span class="hljs-number">4</span>
      t={}
      n=NUM(); <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,s <span class="hljs-keyword">do</span> push(t, n:add(normal(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>))) <span class="hljs-keyword">end</span>
      <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;%7.0f %6.2f %6.2f %6.2f&quot;</span>,s,n:mid(),n:div(),sd(t))) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.rows</span><span class="hljs-params">( egs)</span></span> 
  egs=EGS():<span class="hljs-built_in">load</span>(the.file) 
  map(egs.cols.x,oo); <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>); 
  map(egs.cols.y,oo) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.dist</span><span class="hljs-params">( egs,    a,b,c,out)</span></span>
  egs  = EGS():<span class="hljs-built_in">load</span>(the.file)
  out = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">100</span> <span class="hljs-keyword">do</span>
    a,b,c = any(egs.rows), any(egs.rows), any(egs.rows)
    out   = out <span class="hljs-keyword">and</span> (b -a)==(a-b) <span class="hljs-keyword">and</span> (a-a)==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> ((a-b)+ (b-c) &gt;= (a-c)) <span class="hljs-keyword">end</span> 
  ok(out,<span class="hljs-string">&quot;dist&quot;</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.sort</span><span class="hljs-params">(    egs,rows,n)</span></span>
  egs  = <span class="hljs-built_in">sort</span>(EGS():<span class="hljs-built_in">load</span>(the.file))
  rows= <span class="hljs-built_in">sort</span>(egs.rows)
  n = <span class="hljs-number">.05</span>*#rows//<span class="hljs-number">1</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;what&quot;</span>, o(map(egs.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span> <span class="hljs-keyword">return</span> c.txt <span class="hljs-keyword">end</span>)))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;all&quot;</span>,  o(rnds(egs:mid())))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best&quot;</span>, o(rnds(egs:clone(slice(rows, <span class="hljs-number">1</span>, n)):mid())))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rest&quot;</span>, o(rnds(egs:clone(slice(rows, n+<span class="hljs-number">1</span> )):mid())))
  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.far</span><span class="hljs-params">(  egs,row2)</span></span>
  egs = EGS():<span class="hljs-built_in">load</span>(the.file)
  row2=egs:far(egs.rows[<span class="hljs-number">1</span>]) 
  <span class="hljs-built_in">print</span>(row2 - egs.rows[<span class="hljs-number">1</span>])<span class="hljs-keyword">end</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.sway</span><span class="hljs-params">(  egs,best,rest)</span></span>
  egs = EGS():<span class="hljs-built_in">load</span>(the.file)
  best,rest = egs:sway() 
  egs:ranks()
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(egs.rows) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> row.evaluated <span class="hljs-keyword">then</span> oo(row.cells) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;all&quot;</span>,  o(rnds(egs:mid())))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rest&quot;</span>, o(rnds(egs:clone(rest):mid()))) 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best&quot;</span>, o(rnds(egs:clone(best):mid())))
  oo(<span class="hljs-built_in">sort</span>(map(best,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.symbins</span><span class="hljs-params">( egs)</span></span>
  egs = EGS():<span class="hljs-built_in">load</span>(the.file)
  <span class="hljs-keyword">for</span> i,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(egs.rows)) <span class="hljs-keyword">do</span> row.klass = i&lt;=#egs.rows//<span class="hljs-number">2</span> <span class="hljs-keyword">end</span>
  map(egs.cols.x[<span class="hljs-number">4</span>]:bins(egs.rows),oo) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.bins</span><span class="hljs-params">( egs)</span></span>
  egs = EGS():<span class="hljs-built_in">load</span>(the.file)
  <span class="hljs-keyword">for</span> i,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(egs.rows)) <span class="hljs-keyword">do</span> row.klass = i&lt;=<span class="hljs-number">.05</span>*#egs.rows <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(egs.cols.x) <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;\n%s&quot;</span>,col.txt))
    map(col:bins(egs.rows),<span class="hljs-built_in">print</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.shuffle</span><span class="hljs-params">(   t)</span></span>
  t= {<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>,<span class="hljs-number">60</span>,<span class="hljs-number">70</span>,<span class="hljs-number">80</span>,<span class="hljs-number">90</span>}
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-number">20</span> <span class="hljs-keyword">do</span> oo(shuffle(t)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.per</span><span class="hljs-params">()</span></span>
  <span class="hljs-built_in">print</span>(per({<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>},<span class="hljs-number">0.00</span>)) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.rbins1</span><span class="hljs-params">()</span></span> GO.rbins(<span class="hljs-number">1</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.rbins</span><span class="hljs-params">( max)</span></span>
  <span class="hljs-built_in">max</span> = <span class="hljs-built_in">max</span> <span class="hljs-keyword">or</span> <span class="hljs-number">20</span>
 
  <span class="hljs-keyword">local</span> randoms1={[<span class="hljs-number">0</span>]=NUM(), [<span class="hljs-number">.25</span>]=NUM(), [<span class="hljs-number">.50</span>]=NUM(), [<span class="hljs-number">.75</span>]=NUM()}
  <span class="hljs-keyword">local</span> randoms2={[<span class="hljs-number">0</span>]=NUM(), [<span class="hljs-number">.25</span>]=NUM(), [<span class="hljs-number">.50</span>]=NUM(), [<span class="hljs-number">.75</span>]=NUM()}
  <span class="hljs-keyword">local</span> sways1={[<span class="hljs-number">0</span>]=NUM(), [<span class="hljs-number">.25</span>]=NUM(), [<span class="hljs-number">.50</span>]=NUM(), [<span class="hljs-number">.75</span>]=NUM()}
  <span class="hljs-keyword">local</span> sways2={[<span class="hljs-number">0</span>]=NUM(), [<span class="hljs-number">.25</span>]=NUM(), [<span class="hljs-number">.50</span>]=NUM(), [<span class="hljs-number">.75</span>]=NUM()}
  <span class="hljs-keyword">local</span> guesses={[<span class="hljs-number">0</span>]=NUM(), [<span class="hljs-number">.25</span>]=NUM(), [<span class="hljs-number">.50</span>]=NUM(), [<span class="hljs-number">.75</span>]=NUM()}
  <span class="hljs-keyword">local</span> nguesses=NUM()
  <span class="hljs-keyword">local</span> depths=NUM()
  <span class="hljs-keyword">local</span> nsways1=NUM()
  <span class="hljs-keyword">local</span> nsways2=NUM()
  <span class="hljs-keyword">local</span> nbests1=NUM()
  <span class="hljs-keyword">local</span> nbests2=NUM()
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,<span class="hljs-built_in">max</span> <span class="hljs-keyword">do</span> 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n===========================&quot;</span>)
    <span class="hljs-keyword">local</span> egs = EGS():<span class="hljs-built_in">load</span>(the.file)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;what&quot;</span>, o(map(egs.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span> <span class="hljs-keyword">return</span> c.txt <span class="hljs-keyword">end</span>)))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mid&quot;</span>, o(egs:mid()))
    <span class="hljs-keyword">local</span> best1,rest1,top = egs:sway()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best1s&quot;</span>, o(egs:clone(best1):mid()))
    nsways1:add(egs:evaluated())
    nbests1:add(#best1)
    <span class="hljs-keyword">local</span> best2,rest2,top = egs:sway(best1,top,<span class="hljs-number">10</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best2s&quot;</span>, o(egs:clone(best2):mid()))
    nsways2:add(egs:evaluated())
    nbests2:add(#best2)
    <span class="hljs-keyword">local</span> anys1=many(egs.rows,<span class="hljs-number">1</span>*#best2)
    <span class="hljs-keyword">local</span> anys2=many(egs.rows,<span class="hljs-number">2</span>*#best2)
    <span class="hljs-keyword">local</span> klasses={}
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(best2)                            <span class="hljs-keyword">do</span> push(klasses,row).klass=<span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(slice(shuffle(rest1),<span class="hljs-number">1</span>,<span class="hljs-number">4</span>*#best2)) <span class="hljs-keyword">do</span> push(klasses,row).klass=<span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
    shuffle(klasses)
    <span class="hljs-keyword">local</span> guess,how = egs:rbins(shuffle(klasses),#best2,<span class="hljs-number">4</span>*#best2)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;guesses&quot;</span>, o(egs:clone(guess):mid()))
    nguesses:add(#guess)
    depths:add(#how)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>); map(how,<span class="hljs-built_in">print</span>)
    egs:ranks()
    <span class="hljs-keyword">local</span> anys1  = <span class="hljs-built_in">sort</span>(map(anys1,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))
    <span class="hljs-keyword">local</span> anys2  = <span class="hljs-built_in">sort</span>(map(anys2,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))
    <span class="hljs-keyword">local</span> best1 = <span class="hljs-built_in">sort</span>(map(best1,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))
    <span class="hljs-keyword">local</span> best2 = <span class="hljs-built_in">sort</span>(map(best2,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))
    <span class="hljs-keyword">local</span> guess = <span class="hljs-built_in">sort</span>(map(guess,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> row.rank <span class="hljs-keyword">end</span>))
    <span class="hljs-keyword">for</span> i,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(randoms1)  <span class="hljs-keyword">do</span> num:add(per(anys1,i))  <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(randoms2)  <span class="hljs-keyword">do</span> num:add(per(anys2,i))  <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sways1)  <span class="hljs-keyword">do</span> num:add(per(best1,i))  <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sways2)  <span class="hljs-keyword">do</span> num:add(per(best2,i))  <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">for</span> i,num <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(guesses)  <span class="hljs-keyword">do</span> num:add(per(guess,i))  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span> 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;&quot;</span>)
  <span class="hljs-keyword">for</span> _,kv <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>({{rands1=randoms1},{rands2=randoms2},{sway1=sways1},{ sway2=sways2},{guess=guesses}}) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(kv) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> t=map({<span class="hljs-number">0</span>, <span class="hljs-number">.25</span>, <span class="hljs-number">.5</span>, <span class="hljs-number">.75</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;,%5.1f&quot;</span>,v[p]:mid()) <span class="hljs-keyword">end</span> ) 
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,&quot;</span>,k,<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(t)) <span class="hljs-keyword">end</span>  <span class="hljs-keyword">end</span> 

  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;&quot;</span>)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,nsways1,&quot;</span>,nsways1:mid())
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,nsways2,&quot;</span>,nsways2:mid())
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,nbests1,&quot;</span>,nbests1:mid())
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,nbests2,&quot;</span>,nbests2:mid())
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,nguesses,&quot;</span>,nguesses:mid(),<span class="hljs-string">&quot;,&quot;</span>,nguesses:div())
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;;,&quot;</span>,the.file,<span class="hljs-string">&quot;,depths,&quot;</span>,depths:mid(),<span class="hljs-string">&quot;,&quot;</span>,depths:div())
  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.ranks</span><span class="hljs-params">( egs)</span></span>
  egs = EGS():<span class="hljs-built_in">load</span>(the.file)
  egs:ranks() 
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(egs.rows) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> row.rank&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(row.rank,o(row.cells)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>


<span class="hljs-keyword">if</span>   <span class="hljs-built_in">pcall</span>(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>) 
<span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> {the=the,any=any,any=csv,fmt=fmt,many=many,map=map,
             oo=oo,o=o,obj=obj,per=per,push=push,R=R,
             rnd=rnd,rnds=rnds,<span class="hljs-built_in">sort</span>=<span class="hljs-built_in">sort</span>,slice=slice,
             string2thing=string2thing,
             NUM=NUM, SYM=SYM}
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> the.help <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(help) <span class="hljs-keyword">else</span> GO(the.go) <span class="hljs-keyword">end</span>
     GO.rogue()
     <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(fails)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
