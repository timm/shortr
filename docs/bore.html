<!DOCTYPE html>

<html>
<head>
  <title>bore.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
<a href="tricks.html">tricks</a>
::   <a href="think.html">think</a> 
:: &copy;2022, <a href="mailto:timm@ieee.org">Tim Menzies</a>
<hr><img 
align=right width=250 src=heads2.png>
<a 
href="https://zenodo.org/badge/latestdoi/206205826"> <img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> <img 
src="https://img.shields.io/badge/platform-osx,linux-informational?logo=linux&logoColor=white&color=red"> <img 
src="https://img.shields.io/badge/purpose-se,ai-informational?logo=hyper&logoColor=white&color=orange"> <img 
src="https://img.shields.io/badge/language-lua-informational?logo=lua&logoColor=white&color=yellow"> <a
href="https://github.com/timm/l5/actions/workflows/tests.yml"><img src="https://github.com/timm/l5/actions/workflows/tests.yml/badge.svg"></a><br><a
href="https://github.com/timm/l5/blob/master/LICENSE.md#top"><img src="https://img.shields.io/badge/license-BSD2-informational?logo=adblock&logoColor=white&color=blueviolet"></a>
<br>

                  <h1>bore.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> help = <span class="hljs-string">[[  
SAW2: best or rest multi-objective optimization.
(c) 2022 Tim Menzies, timm@ieee.org
&quot;I think the highest and lowest points are the important ones. 
 Anything else is just...in between.&quot; ~ Jim Morrison

USAGE: lua saw2.lua [OPTIONS]

OPTIONS:
  -b  --bins  max bins                 = 16
  -s  --seed  random number seed       = 10019
  -S  --some  number of nums to keep   = 256

OPTIONS (other):
  -f  --file  where to find data       = ../etc/data/auto93.csv
  -d  --dump  dump stack+exit on error = false
  -h  --help  show help                = false
  -g  --go    start up action          = nothing

Usage of the works is permitted provided that this instrument is
retained with the works, so that any entity that uses the works is
notified of this instrument. DISCLAIMER:THE WORKS ARE WITHOUT WARRANTY. ]]</span> 

<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">string2thing</span><span class="hljs-params">(x)</span></span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> the={}
help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n  ([-][^%s]+)[%s]+([-][-]([^%s]+))[^\n]*%s([^%s]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f1,f2,k,x)</span></span>
  <span class="hljs-keyword">for</span> n,flag <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> flag==f1 <span class="hljs-keyword">or</span> flag==f2 <span class="hljs-keyword">then</span>
    x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  the[k] = string2thing(x) <span class="hljs-keyword">end</span>) 
<span class="hljs-keyword">local</span> any,atom,csv,has,many,map,merge,o,oo,obj,ok
<span class="hljs-keyword">local</span> part,patch,per,push,rows,same,slice,<span class="hljs-built_in">sort</span>
<span class="hljs-keyword">local</span> _,GO,RANGE,SOME,NUM,SYM,COLS,ROW,EGS
<span class="hljs-keyword">local</span> R,big,fmt

big = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
R   = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">same</span><span class="hljs-params">(x)</span></span>      <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span>    t[<span class="hljs-number">1</span>+#t]=x;       <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span>    <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(#t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> map(t,same), f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f, u)</span></span>  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(v) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">slice</span><span class="hljs-params">(t,i,j,k,     u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> n=(i <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>), (j <span class="hljs-keyword">or</span> #t),(k <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = t[n] <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span><span class="hljs-params">(i, defaults, also)</span></span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(defaults) <span class="hljs-keyword">do</span> i[k] = v <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(also <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> <span class="hljs-built_in">assert</span>(i[k]~=<span class="hljs-literal">nil</span>,<span class="hljs-string">&quot;unknown:&quot;</span>..k);i[k]=v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(src)</span></span>
  src = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(src)
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line, row)</span></span> 
    line=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line <span class="hljs-keyword">then</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(src) <span class="hljs-keyword">else</span>
      row={}; <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> line:<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span> row[<span class="hljs-number">1</span>+#row]=string2thing(x) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oo</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">print</span>(o(t)) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,    u)</span></span>
  <span class="hljs-keyword">if</span> #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(map(t,<span class="hljs-built_in">tostring</span>),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">else</span>
    u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = fmt(<span class="hljs-string">&quot;:%s %s&quot;</span>,k,v) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> (t.is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(<span class="hljs-built_in">sort</span>(u),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(name,    t,new)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(kl,...)</span></span> 
    <span class="hljs-keyword">local</span> x=<span class="hljs-built_in">setmetatable</span>({},kl); kl.new(x,...); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> 
  t = {<span class="hljs-built_in">__tostring</span>=o, is=name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>}; t.<span class="hljs-built_in">__index</span>=t
  _ = t
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(t, {<span class="hljs-built_in">__call</span>=new}) <span class="hljs-keyword">end</span>
RANGE=obj<span class="hljs-string">&quot;RANGE&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,t)</span></span>  has(i,{at=<span class="hljs-number">0</span>, txt=<span class="hljs-string">&quot;&quot;</span>, lo=big, hi= -big, ys=SYM()},t) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.of</span><span class="hljs-params">(i,x)</span></span>   <span class="hljs-keyword">return</span> i.ys.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__lt</span><span class="hljs-params">(i,j)</span></span>   <span class="hljs-keyword">return</span> i.lo &lt; j.lo <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x,y)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x&gt;i.hi <span class="hljs-keyword">then</span> i.hi=x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x&lt;i.lo <span class="hljs-keyword">then</span> i.lo=x <span class="hljs-keyword">end</span> 
  i.ys:add(y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.select</span><span class="hljs-params">(i,t,     x)</span></span>
  t = t.cells <span class="hljs-keyword">and</span> t.cells <span class="hljs-keyword">or</span> t
  x = t[i.pos]
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> i.lo == i.hi <span class="hljs-keyword">and</span> i.lo == x <span class="hljs-keyword">or</span> i.lo &lt;= x <span class="hljs-keyword">and</span> x &lt; i.hi <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__tostring</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x, lo, hi = i.txt, i.lo, i.hi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt;= %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s &lt; %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.merged</span><span class="hljs-params">(i,j,n0,    k)</span></span>
  <span class="hljs-keyword">if</span> i.at == j.at <span class="hljs-keyword">then</span>
    k = i.ys:merged(j.ys,n0)
    <span class="hljs-keyword">if</span> k <span class="hljs-keyword">then</span> 
      <span class="hljs-keyword">return</span> RANGE{at=i.at, txt=i.txt, lo=i.lo, hi=j.hi, ys=k} <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
SOME=obj<span class="hljs-string">&quot;SOME&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i)</span></span> i.all, i.ok, i.n = {}, <span class="hljs-literal">false</span>,<span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.nums</span><span class="hljs-params">(i)</span></span> i.all=i.ok <span class="hljs-keyword">and</span> i.all <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(i.all);i.ok=<span class="hljs-literal">true</span>;<span class="hljs-keyword">return</span> i.all <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.n = <span class="hljs-number">1</span> + i.n
  <span class="hljs-keyword">if</span>     #i.all  &lt; the.some  <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; push(i.all,x) 
  <span class="hljs-keyword">elseif</span> R() &lt; the.some/i.n  <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; i.all[R(#i.all)]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.per</span><span class="hljs-params">(i,p, a)</span></span>
  a = i:nums()
  <span class="hljs-keyword">return</span> a[<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(#a, (p <span class="hljs-keyword">or</span> <span class="hljs-number">.5</span>)*#a//<span class="hljs-number">1</span>))] <span class="hljs-keyword">end</span>
SYM=obj<span class="hljs-string">&quot;SYM&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,t)</span></span>    has(i,{at=<span class="hljs-number">0</span>, txt=<span class="hljs-string">&quot;&quot;</span>, n=<span class="hljs-number">0</span>, all={}},t) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x,n)</span></span>  
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> n=n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>; i.n=i.n+n; i.all[x]=n+(i.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i,   m,x)</span></span>
  m=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> y,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> n&gt;m <span class="hljs-keyword">then</span> m,x=n,y <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.div</span><span class="hljs-params">(i,   n,e)</span></span>
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> k,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> e=e-n/i.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/i.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> ;<span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.merge</span><span class="hljs-params">(i,j,n0,    k)</span></span>
  k = SYM{at=i.at, txt=i.txt}
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.all) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> f <span class="hljs-keyword">end</span>

 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.merged</span><span class="hljs-params">(i,j,n0,    k)</span></span>
  n0, k = (n0 <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>), i:merge(j)
  <span class="hljs-keyword">if</span> i.n&lt;n0 <span class="hljs-keyword">or</span> j.n&lt;n0 <span class="hljs-keyword">or</span> 
    (i:div()*i.n+j:div()*j.n)/k.n &gt; k:div() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.discretize</span><span class="hljs-params">(i,x,bins)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
NUM=obj<span class="hljs-string">&quot;NUM&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,t)</span></span> 
  has(i,{at=<span class="hljs-number">0</span>,txt=<span class="hljs-string">&quot;&quot;</span>,lo= big,hi= -big, all=SOME()},t) 
  i.w = i.txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i)</span></span>    <span class="hljs-keyword">return</span>  i.all:per(<span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.div</span><span class="hljs-params">(i)</span></span>    <span class="hljs-keyword">return</span> (i.all:per(<span class="hljs-number">.9</span>) - i.all:per(<span class="hljs-number">.1</span>)) / <span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.norm</span><span class="hljs-params">(i,x)</span></span> <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span> (x-i.lo)/(i.hi - i.lo) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x&gt;i.hi <span class="hljs-keyword">then</span> i.hi=x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x&lt;i.lo <span class="hljs-keyword">then</span> i.lo=x <span class="hljs-keyword">end</span> 
  i.all:add(x) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.discretize</span><span class="hljs-params">(i,x,bins,   base)</span></span> 
  base = (i.hi - i.lo)/bins; <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/base + <span class="hljs-number">0.5</span>)*base <span class="hljs-keyword">end</span>
ROW=obj<span class="hljs-string">&quot;ROW&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,t)</span></span> has(i,{cells={},backdrop={}},t) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.__lt</span><span class="hljs-params">(i,j,     s1,s2,e,y,a,b)</span></span>
  y = i.backdrop.cols.y
  s1, s2, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(y) <span class="hljs-keyword">do</span>
     a = col:norm(i.cells[col.at])
     b = col:norm(j.cells[col.at])
     s1= s1 - e^(col.w * (a - b) / #y)
     s2= s2 - e^(col.w * (b - a) / #y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#y &lt; s2/#y  <span class="hljs-keyword">end</span>
COLS=obj<span class="hljs-string">&quot;COLS&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,t,     col)</span></span>
  has(i, {all={}, x={}, y={}, names={}},t)
  <span class="hljs-keyword">for</span> at,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.names) <span class="hljs-keyword">do</span>
    col = push(i.all, (txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM){at=at, txt=txt})
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span>
      push(txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[-+!]$&quot;</span> <span class="hljs-keyword">and</span> i.y <span class="hljs-keyword">or</span> i.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
EGS=obj<span class="hljs-string">&quot;EGS&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i)</span></span>       i.rows,i.cols= {},<span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.file</span><span class="hljs-params">(i,file)</span></span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(file) <span class="hljs-keyword">do</span>  i:add(row) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.add</span><span class="hljs-params">(i,row)</span></span>
  <span class="hljs-keyword">if</span>   i.cols 
  <span class="hljs-keyword">then</span> row = push(i.rows, row.cells <span class="hljs-keyword">and</span> row <span class="hljs-keyword">or</span> ROW{backdrop=i, cells=row}).cells
       <span class="hljs-keyword">for</span> k,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.all) <span class="hljs-keyword">do</span> col:add(row[col.at]) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span> i.cols = COLS{names=row} <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.mid</span><span class="hljs-params">(i,cs)</span></span> <span class="hljs-keyword">return</span> map(cs <span class="hljs-keyword">or</span> i.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span><span class="hljs-keyword">return</span> c:mid() <span class="hljs-keyword">end</span>)<span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.div</span><span class="hljs-params">(i,cs)</span></span> <span class="hljs-keyword">return</span> map(cs <span class="hljs-keyword">or</span> i.cols.y,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span><span class="hljs-keyword">return</span> c:div() <span class="hljs-keyword">end</span>)<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.copy</span><span class="hljs-params">(i,rows,   out)</span></span>
  out=EGS():add(i.cols.names)
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> out:add(row) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> _merge, _xpand, _ranges
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.ranges</span><span class="hljs-params">(i,one,two,   t)</span></span>
  t={}; <span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.x) <span class="hljs-keyword">do</span> t[c.at]=_ranges(c,one,two) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_ranges</span><span class="hljs-params">(col,yes,no,    out,x,d)</span></span>
  out = {}
  <span class="hljs-keyword">for</span> _,what <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{{rows=yes, klass=<span class="hljs-literal">true</span>}, {rows=no, klass=<span class="hljs-literal">false</span>}} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(what.rows) <span class="hljs-keyword">do</span> x = row.cells[col.at]; <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      d = col:discretize(x,the.bins)
      out[d] = out[d] <span class="hljs-keyword">or</span> RANGE{at=col.at,txt=col.txt,lo=x,hi=x}
      out[d]:add(x, what.klass) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> _xpand(_merge(<span class="hljs-built_in">sort</span>(out)))  <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_merge</span><span class="hljs-params">(b4,        a,b,c,j,n,tmp)</span></span>
  j,n,tmp = <span class="hljs-number">1</span>,#b4,{}
  <span class="hljs-keyword">while</span> j&lt;=n <span class="hljs-keyword">do</span> a, b = b4[j], b4[j+<span class="hljs-number">1</span>]
                <span class="hljs-keyword">if</span> b <span class="hljs-keyword">then</span> c = a:merged(b); <span class="hljs-keyword">if</span> c <span class="hljs-keyword">then</span> a,j = c,j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
                tmp[#tmp+<span class="hljs-number">1</span>] = a
                j = j+<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> #tmp==#b4 <span class="hljs-keyword">and</span> tmp <span class="hljs-keyword">or</span> _merge(tmp) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpand</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#t <span class="hljs-keyword">do</span> t[j].lo=t[j<span class="hljs-number">-1</span>].hi <span class="hljs-keyword">end</span>; t[<span class="hljs-number">1</span>].lo, t[#t].hi= -big,big; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span> 
GO=obj<span class="hljs-string">&quot;GO&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ok</span><span class="hljs-params">(test,msg)</span></span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>, test <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;PASS &quot;</span><span class="hljs-keyword">or</span> <span class="hljs-string">&quot;FAIL &quot;</span>, msg <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> test <span class="hljs-keyword">then</span>
    GO.fails= GO.fails+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> the.<span class="hljs-built_in">dump</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">assert</span>(test,msg) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_.new</span><span class="hljs-params">(i,todo,    defaults,go)</span></span>
  defaults={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(the) <span class="hljs-keyword">do</span> defaults[k]=v <span class="hljs-keyword">end</span>
  go={}; <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(GO) <span class="hljs-keyword">do</span>
           <span class="hljs-keyword">if</span> k~=<span class="hljs-string">&quot;new&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(GO[k])==<span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> go[<span class="hljs-number">1</span>+#go]=k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  GO.fails = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(todo==<span class="hljs-string">&quot;all&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">sort</span>(go) <span class="hljs-keyword">or</span> {todo}) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(defaults) <span class="hljs-keyword">do</span> the[k]=v <span class="hljs-keyword">end</span> 
    <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed)
    <span class="hljs-keyword">if</span> GO[x] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(x); GO[x]() <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  GO.rogue()
  <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(GO.fails) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.rogue</span><span class="hljs-params">( t)</span></span>
  t={}; <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{ <span class="hljs-string">&quot;_G&quot;</span>, <span class="hljs-string">&quot;_VERSION&quot;</span>, <span class="hljs-string">&quot;arg&quot;</span>, <span class="hljs-string">&quot;assert&quot;</span>, <span class="hljs-string">&quot;collectgarbage&quot;</span>,
  <span class="hljs-string">&quot;coroutine&quot;</span>, <span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-string">&quot;dofile&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;getmetatable&quot;</span>, <span class="hljs-string">&quot;io&quot;</span>, <span class="hljs-string">&quot;ipairs&quot;</span>,
  <span class="hljs-string">&quot;load&quot;</span>, <span class="hljs-string">&quot;loadfile&quot;</span>, <span class="hljs-string">&quot;math&quot;</span>, <span class="hljs-string">&quot;next&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;package&quot;</span>, <span class="hljs-string">&quot;pairs&quot;</span>, <span class="hljs-string">&quot;pcall&quot;</span>,
  <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;rawequal&quot;</span>, <span class="hljs-string">&quot;rawget&quot;</span>, <span class="hljs-string">&quot;rawlen&quot;</span>, <span class="hljs-string">&quot;rawset&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;select&quot;</span>,
  <span class="hljs-string">&quot;setmetatable&quot;</span>, <span class="hljs-string">&quot;string&quot;</span>, <span class="hljs-string">&quot;table&quot;</span>, <span class="hljs-string">&quot;tonumber&quot;</span>, <span class="hljs-string">&quot;tostring&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;utf8&quot;</span>,
  <span class="hljs-string">&quot;warn&quot;</span>, <span class="hljs-string">&quot;xpcall&quot;</span>} <span class="hljs-keyword">do</span> t[k]=k <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k, <span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.cols</span><span class="hljs-params">()</span></span>
  oo(COLS{names={<span class="hljs-string">&quot;Cyldrs&quot;</span>, <span class="hljs-string">&quot;Acc+&quot;</span>}}) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.egs</span><span class="hljs-params">(  egs,n)</span></span>
  egs = EGS():file(the.file)
  <span class="hljs-built_in">sort</span>(egs.rows)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;all&quot;</span>, o(egs:mid()))
  n = (#egs.rows)^<span class="hljs-number">.5</span> // <span class="hljs-number">1</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best&quot;</span>,o(egs:copy(slice(egs.rows,<span class="hljs-number">1</span>,n)):mid()))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rest&quot;</span>,o(egs:copy(slice(egs.rows,n+<span class="hljs-number">1</span>)):mid())) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GO.egs1</span><span class="hljs-params">(  egs,best,rest,n)</span></span>
  egs = EGS():file(the.file)
  <span class="hljs-built_in">sort</span>(egs.rows)
  n    = (#egs.rows)^<span class="hljs-number">.5</span> // <span class="hljs-number">1</span>
  best = slice(egs.rows, <span class="hljs-number">1</span>, n)
  rest = slice(egs.rows, n+<span class="hljs-number">1</span>, #egs.rows, (#egs.rows - n)//(<span class="hljs-number">3</span>*n))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;all&quot;</span>, o(egs:mid()))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;best&quot;</span>,o(egs:copy(best):mid()))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rest&quot;</span>,o(egs:copy(rest):mid())) 
  egs:ranges(best,rest) 
  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>xxx replace part with a slice wit one extra art</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">part</span><span class="hljs-params">(t,n,lo,hi,  u)</span></span> 
  lo, hi = <span class="hljs-number">1</span>, hi <span class="hljs-keyword">or</span> #t
  u={};<span class="hljs-keyword">for</span> j = lo, hi, (hi-lo)//n <span class="hljs-keyword">do</span> push(u,t[j]) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> u  <span class="hljs-keyword">end</span>


<span class="hljs-keyword">if</span>   the.help 
<span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;%u%u+&quot;</span>, <span class="hljs-string">&quot;\27[31m%1\27[0m&quot;</span>)
               :<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;(%s)([-][-]?[^%s]+)(%s)&quot;</span>,<span class="hljs-string">&quot;%1\27[33m%2\27[0m%3&quot;</span>),<span class="hljs-string">&quot;&quot;</span>)
<span class="hljs-keyword">else</span> GO(the.go) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <pre><code>        |         |
      -= _________ =-
         ___   ___
        |   )=(   |
            ###
          #  =  #            <span class="hljs-string">&quot;This ain&#x27;t chemistry. 
          #######             This is art.&quot;</span>
</code></pre>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
