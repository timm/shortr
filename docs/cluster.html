<!DOCTYPE html>

<html>
<head>
  <title>cluster.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
<a href="tricks.html">tricks</a>
::   <a href="think.html">think</a> 
:: &copy;2022, <a href="mailto:timm@ieee.org">Tim Menzies</a>
<hr><img 
align=right width=250 src=heads2.png>
<a 
href="https://zenodo.org/badge/latestdoi/206205826"> <img src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> <img 
src="https://img.shields.io/badge/platform-osx,linux-informational?logo=linux&logoColor=white&color=red"> <img 
src="https://img.shields.io/badge/purpose-se,ai-informational?logo=hyper&logoColor=white&color=orange"> <img 
src="https://img.shields.io/badge/language-lua-informational?logo=lua&logoColor=white&color=yellow"> <a
href="https://github.com/timm/l5/actions/workflows/tests.yml"><img src="https://github.com/timm/l5/actions/workflows/tests.yml/badge.svg"></a><br><a
href="https://github.com/timm/l5/blob/master/LICENSE.md#top"><img src="https://img.shields.io/badge/license-BSD2-informational?logo=adblock&logoColor=white&color=blueviolet"></a>
<br>

                  <h1>cluster.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>768
| 384
| | 192
| | | 96
| | | | 48          {positive}
| | | | 48          {positive}
| | | 96
| | | | 48          {positive}
| | | | 48          {negative}
| | 192
| | | 96
| | | | 48          {positive}
| | | | 48          {negative}
| | | 96
| | | | 48          {positive}
| | | | 48          {positive}
| 384
| | 192
| | | 96
| | | | 48          {negative}
| | | | 48          {negative}
| | | 96
| | | | 48          {negative}
| | | | 48          {negative}
| | 192
| | | 96
| | | | 48          {negative}
| | | | 48          {negative}
| | | 96
| | | | 48          {negative}
| | | | 48          {negative}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">local</span> R = <span class="hljs-built_in">require</span>
<span class="hljs-keyword">local</span> the,egs,lib = R<span class="hljs-string">&quot;the&quot;</span>, R<span class="hljs-string">&quot;egs&quot;</span>, R<span class="hljs-string">&quot;lib&quot;</span>
<span class="hljs-keyword">local</span> per,<span class="hljs-built_in">cos</span>,norm,o,fmt,rnds=lib.per,lib.cosine,lib.norm,lib.o,lib.fmt,lib.rnds
<span class="hljs-keyword">local</span> map,any,many,<span class="hljs-built_in">sort</span>,up1 = lib.map,lib.any, lib.many,lib.<span class="hljs-built_in">sort</span>,lib.up1

<span class="hljs-keyword">local</span> cluster={}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.new</span><span class="hljs-params">(top,egs1,      i,lefts,rights)</span></span>
  egs1 = egs1 <span class="hljs-keyword">or</span> top
  i   = {egs=egs1, top=top, rank=<span class="hljs-number">0</span>}
  lefts, rights, i.left, i.right, i.border, i.c = cluster.half(top, egs1.rows)
  <span class="hljs-keyword">if</span> #egs1.rows &gt;= <span class="hljs-number">2</span>*(#top.rows)^the.leaves <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> #lefts.rows &lt; #egs1.rows <span class="hljs-keyword">then</span>
      i.lefts = cluster.new(top, lefts)
      i.rights= cluster.new(top, rights) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.show</span><span class="hljs-params">(i,   pre, front)</span></span>
  pre = pre <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-keyword">local</span> front = fmt(<span class="hljs-string">&quot;%s%s&quot;</span>, pre, #i.egs.rows)
  <span class="hljs-keyword">if</span>   cluster.leaf(i) 
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(fmt(<span class="hljs-string">&quot;%-20s%s&quot;</span>,front, o(rnds(egs.mid(i.egs,i.egs.cols.y)))))
  <span class="hljs-keyword">else</span> <span class="hljs-built_in">print</span>(front)
       <span class="hljs-keyword">if</span> i.lefts  <span class="hljs-keyword">then</span> cluster.show(i.lefts,  <span class="hljs-string">&quot;| &quot;</span>..pre)
       <span class="hljs-keyword">if</span> i.rights <span class="hljs-keyword">then</span> cluster.show(i.rights, <span class="hljs-string">&quot;| &quot;</span>..pre) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.leaf</span><span class="hljs-params">(i)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> (i.lefts <span class="hljs-keyword">or</span> i.rights) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.dist</span><span class="hljs-params">(eg1,row1,row2)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym</span><span class="hljs-params">(c,x,y)</span></span> <span class="hljs-keyword">return</span> x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num</span><span class="hljs-params">(c,x,y)</span></span>
    <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> y = norm(c.lo, c.hi, y); x=y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> 
    <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> x = norm(c.lo, c.hi, x); y=x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">else</span>             x,y = norm(c.lo, c.hi, x), norm(c.lo, c.hi, y) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist</span><span class="hljs-params">(c,x,y)</span></span>
    <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> (c.nump <span class="hljs-keyword">and</span> num <span class="hljs-keyword">or</span> sym)(c,x,y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> d, n = <span class="hljs-number">0</span>, #eg1.cols.x
  <span class="hljs-keyword">for</span> key,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(eg1.cols.x) <span class="hljs-keyword">do</span> d=d+dist(c, row1[c.at], row2[c.at])^the.p <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> (d/n)^(<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.neighbors</span><span class="hljs-params">(eg1, r1, rows)</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(map(rows <span class="hljs-keyword">or</span> eg1.rows,
              <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r2)</span></span> <span class="hljs-keyword">return</span> {cluster.dist(eg1,r1,r2),r2} <span class="hljs-keyword">end</span>), up1) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cluster.half</span><span class="hljs-params">(eg1, rows)</span></span>
  <span class="hljs-keyword">local</span> project,far,some,left,right,c,lefts,rights,border
  rows    = rows <span class="hljs-keyword">or</span> eg1.rows
  far     = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r,t)</span></span> <span class="hljs-keyword">return</span> per(cluster.neighbors(eg1,r,t), the.far)[<span class="hljs-number">2</span>] <span class="hljs-keyword">end</span>
  project = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>   
              <span class="hljs-keyword">return</span> {<span class="hljs-built_in">cos</span>(cluster.dist(eg1,left,r), 
                          cluster.dist(eg1,right,r),
                          c),
                      r} <span class="hljs-keyword">end</span>
  some    = many(rows,     the.some)
  left    = far(any(some), some)
  right   = far(left,      some)
  c       = cluster.dist(eg1,left,right)
  lefts,rights = egs.clone(eg1), egs.clone(eg1)
  <span class="hljs-keyword">for</span> n, projection <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(map(rows,project), up1)) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> n==#rows//<span class="hljs-number">2</span> <span class="hljs-keyword">then</span> border = projection[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span>
    egs.add(n &lt;= #rows//<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> lefts <span class="hljs-keyword">or</span> rights, projection[<span class="hljs-number">2</span>]) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> lefts, rights, left, right, border, c  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> cluster</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
