<!DOCTYPE html>

<html>
<head>
  <title>spy.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>spy.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>vim: ts=2 sw=2 et:
<img src=spy.jpg align=left width=250><hr>   </p>
<p><b>SEMI-SUPERVISED LANDSCAPE ANALYSIS</b>  </p>
<p><a href="#copyright">&copy; 2022</a> Tim Menzies<br clear=all></p>
<table>
<thead>
<tr>
<th align="right"><strong>classes:</strong></th>
<th><a href="#range">RANGE</a> :: <a href="#sym">SYM</a> :: <a href="#some">SOME</a> :: <a href="#num">NUM</a> :: <a href="#row">ROW</a> :: <a href="#rows">ROWS</a></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>functions:</strong></td>
<td><a href="#lib">Lib</a> :: <a href="#demos">Demos</a> :: <a href="#return">Return</a> :: <a href="#start">Start</a></td>
</tr>
<tr>
<td align="right"><strong>notes:</strong></td>
<td><a href="#contribute">Contribute</a> :: <a href="#copyright">Copyright</a></td>
</tr>
</tbody></table>
<p>&nbsp;   </p>
<p>This code is an experiment in writing the <em>most</em> learners in the <em>least</em> code.
Here, each learner is just a few lines of code (since they are share the same
underlying code base). </p>
<p>Given examples ((<em>x1,y1</em>), (<em>x2,y2</em>), … etc, this
code explores things that make the most difference in the data.i</p>
<ul>
<li>Given <em>N</em> examples,
we grabs, say,  <strong>some=512</strong> at random (to speed up the process) then find two extreme distant points
(to
avoid spurious outlier’s, we pick a point that is only <strong>far=95</strong>%
most distant). </li>
<li>Distance is calculated using Minkowski (and at  <strong>p=2</strong>, this is 
a Euclidean measure) where numbers are normalized 0..1 (min..max) and symbols are at distance 0,1 
(for same,different). 
For missing values, we assume values that maximizes the distance.</li>
<li>Using the <em>x</em> values, 
we can position any other example <em>C &in; N</em> somewhere between the two extremes.
If the extremes  <em>A,B</em> are separated by
distance <em>c</em>,then <em>C</em> has a distance <em>x=(a*a + c*c - b*b)/(2c)</em> from <em>A</em>. 
The data is divided
in two using the median <em>x</em> value and we recurse (on all of <em>N</em>). </li>
<li>Optionally, we  might prune the half of the data nearest to
the worse extreme (where “worse” is defined by a multi-objective domination predicate 
(see <a href="#rowlt"><code>ROW.__lt</code></a>. Note that this needs only two extreme points per pruning.</li>
</ul>
<p>When recursing, if one extreme point is taken from an extreme in the parent, then
(e.g.) 10,000 options can be pruned back to around 20
“good”  ones
in less than two  dozen evaluations. </p>
<p>The above heuristcs can be sometimes inaccurate,  so we loop a few times, each
time starting with some subset of “good” examples found in the last loop.
So of loop1 finds N<sup><strong>min1=.5</strong></sup> “good” examples, subsequent loops
look for <strong>min2==10</strong> best examples within  some of the “good” seen in prior
rounds.</p>
<p>Once we have “good” and not “good” examples, the difference between them can summarise
what was found.  </p>
<ul>
<li>Those summaries are built from ranges that remember what <code>x</code> values
are seen in “good” and not “good”. </li>
<li>For numbers, these ranges are built by dividing
lo to hi into 16 sized ranges (using (hi-lo)/<strong>bins=16</strong>). i</li>
<li>This code combines ranges
if they have too few examples or if their “good”/not “good” distributions are uninformative
(see the  <code>div</code> in <a href="#numbin">NUM.bin</a>). The resulting ranges are then ranked by
whatever is goal of the process (e.g. find choices that <strong>goal=helps</strong> us get to “good”).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4={}; <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=k <span class="hljs-keyword">end</span> 
<span class="hljs-keyword">local</span> help=<span class="hljs-string">[[  
SPY: semi-supervised landscape analysis    
(c) 2022 Tim Menzies, timm@ieee.org, BSD2 license    
&quot;I think the highest and lowest points are the important    
 ones. Anything else is just... in between.&quot; ~Jim Morrison   
        
INSTALL: requires: lua 5.4+   
         download: spy.lua   
         test    : lua spy.lua -h   
         
USAGE: lua spy.lua [OPTIONS]   
                                              defaults   
                                              ~~~~~~~~   
  -F  --Far   normalized distance to extreme = 95
  -S  --Seed  random number seed              = 10019   
  -G  --Goal  optimize for (helps,hurts,tabu) = more   
  -b  --bins  number of bins                  = 16   
  -m  --min   min size pass1                  = .5   
  -p  --p     distance coefficient           = 2   
  -s  --some  sample size                    = 512   
          
OPTIONS (other):   
  -f  --file  csv file with data              = ../../etc/data/auto93.csv   
  -g  --go    start up action                 = nothing   
  -h  --help  show help                       = false]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="build-the-settings-from-comment-string">Build <code>the</code> settings from comment string</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>At start-up, the first tasks is to create the settings object from the
top-of-file <code>help</code> string. </p>
<ul>
<li>In that string, find lines starting with <code>--xx</code>.</li>
<li>Add a slot to <code>the</code> with key <code>xx</code> and a value<br>valie built from the last word on the line. </li>
<li>Check for updates (from command-line flags
<code>--xx</code> or <code>-x</code>).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> the={}
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toatom</span><span class="hljs-params">(x)</span></span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cli</span><span class="hljs-params">(key,x)</span></span>
  x = <span class="hljs-built_in">tostring</span>(x)
  <span class="hljs-keyword">for</span> n,flag <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">if</span> flag==(<span class="hljs-string">&quot;-&quot;</span>..key:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">or</span> flag==(<span class="hljs-string">&quot;--&quot;</span>..key) <span class="hljs-keyword">then</span> 
      x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span><span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> toatom(x) <span class="hljs-keyword">end</span>  
        
help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot; [-][-]([^%s]+)[^\n]*%s([^%s]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,x)</span></span> the[k] = cli(k,x) <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <h2 id="define-the-local-names">Define the local names</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Define all local names at top of file (so code can be defined in any order).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> atom,big,bins,csv,fmt,goes,going,gt,is,lt,main,map
<span class="hljs-keyword">local</span> o,oo,per,push,rand,rnd,<span class="hljs-built_in">sort</span>,splice,tothing</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Make polymorphic classes.   </p>
<ul>
<li>Define a <code>new</code> method that will add a link from a 
new table, back to a metatables.</li>
<li>Also, define a second link from that metatable
to a variable storing the methods. 
Further, add a print name and a print name for this class.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is</span><span class="hljs-params">(name,    t,new)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(kl,...)</span></span> <span class="hljs-keyword">local</span> x=<span class="hljs-built_in">setmetatable</span>({},kl); kl.new(x,...); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> 
  t = {<span class="hljs-built_in">__tostring</span>=o, is=name}; t.<span class="hljs-built_in">__index</span>=t 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(t, {<span class="hljs-built_in">__call</span>=new}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <h3 id="define-the-objects-">Define the objects <a name=range></a></h3>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <ul>
<li>ROWS use ROWs (to store data) and NUMs or SYMs  to summarize the cells.</li>
<li>ROWs  use ROWS to handle distance calculations and rankings.</li>
<li>RANGEs remember the <code>ys</code> values seen between <code>xlo</code> and <code>xhi</code>.<ul>
<li>RANGEs use SYMs (to hold the <code>ys</code> counts)</li>
</ul>
</li>
</ul>
<p>NUMs use SOMEs which holds, at most <code>the.some</code> numbers
(and if it sees more than that, the SOMes just replaces 
  an existing item, picked at random).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> NUM,  RANGE, ROW = is<span class="hljs-string">&quot;NUM&quot;</span>, is<span class="hljs-string">&quot;RANGE&quot;</span>, is<span class="hljs-string">&quot;ROW&quot;</span> 
<span class="hljs-keyword">local</span> ROWS, SOME,  SYM = is<span class="hljs-string">&quot;ROWS&quot;</span>, is<span class="hljs-string">&quot;SOME&quot;</span>, is<span class="hljs-string">&quot;SYM&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h2 id="range-">RANGE <a name=range></a></h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <ul>
<li>Remember the <code>ys</code> values seen between <code>xlo</code> and <code>xhi</code>.    </li>
<li>Use SYMs (to remember the <code>ys</code> values).</li>
<li>Score a range by (e.g.) how much it helps to 
select for a  `want’ed class (see <strong>score</strong>)
and for other goals, see <strong>score.goal</strong>).</li>
<li>Report if a range is relevant to some row (see <strong>selects</strong>)</li>
</ul>
<p>Implementation detail: ranges of SYMbolic columns have the
invariant <code>xlo==ylo</code> (while NUMeric ranges have xlo &le; xhi`).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.new</span><span class="hljs-params">(i,at,txt,lo,hi,ys)</span></span> 
  i.at,i.txt,i.xlo,i.xhi,i.ys=at,txt,lo,hi <span class="hljs-keyword">or</span> lo,ys <span class="hljs-keyword">or</span> SYM() <span class="hljs-keyword">end</span>
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.add</span><span class="hljs-params">(i,x,y)</span></span>
  <span class="hljs-keyword">if</span> x&lt;i.xlo <span class="hljs-keyword">then</span> i.xlo = x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x&gt;i.xhi <span class="hljs-keyword">then</span> i.xhi = x <span class="hljs-keyword">end</span>
  i.ys:add(y) <span class="hljs-keyword">end</span>
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.__tostring</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x, lo, hi = i.txt, i.xlo, i.xhi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt;= %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s &lt; %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.score</span><span class="hljs-params">(i,want,B,R)</span></span>
  <span class="hljs-keyword">local</span> goal, b, r, z = {}, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>/big
  goal.helps= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> ((b&lt;r <span class="hljs-keyword">or</span> b+r &lt; <span class="hljs-number">.05</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> b^<span class="hljs-number">2</span>/(b+r) <span class="hljs-keyword">end</span>
  goal.hurts= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> ((r&lt;b <span class="hljs-keyword">or</span> b+r &lt; <span class="hljs-number">.05</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> r^<span class="hljs-number">2</span>/(b+r) <span class="hljs-keyword">end</span>
  goal.tabu= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b,r)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>/(b+r) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">for</span> v,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.ys.all) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> v==want <span class="hljs-keyword">then</span> b = b+n <span class="hljs-keyword">else</span> r=r+n <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> goal[the.Goal](b/(B+z), r/(R+z)) <span class="hljs-keyword">end</span>
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.selects</span><span class="hljs-params">(i,row,     v)</span></span>
  v = row.cells[i.at]
  <span class="hljs-keyword">return</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> (i.xlo==i.xhi <span class="hljs-keyword">and</span> i.xlo==v) <span class="hljs-keyword">or</span> (i.xlo&lt;=v <span class="hljs-keyword">and</span> v&lt;i.xhi) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h2 id="sym-">SYM <a name=sym></a></h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Update a summary of a  stream of symbols.</p>
<p>Report their mode (a.k.a. <strong>mid()</strong>) and – entropy (a.k.a. <strong>div()</strong>).   </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.new</span><span class="hljs-params">(i,at,txt)</span></span> 
  i.at,i.txt = at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>; i.n,i.all=<span class="hljs-number">0</span>,{}; i.most,i.mode=<span class="hljs-number">0</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Subtracting data is just the inverse of adding data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.sub</span><span class="hljs-params">(i,x,inc)</span></span> SYM.add(i,x,-(inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Add by adjusting internal symbol counts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.add</span><span class="hljs-params">(i,x,inc)</span></span> 
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    inc = inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    i.n = i.n+inc
    i.all[x] = inc + (i.all[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
    <span class="hljs-keyword">if</span> i.all[x] &gt; i.most <span class="hljs-keyword">then</span> i.most,i.mode=i.all[x], x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Though NUMerics are discretized into (at most <strong>the.bins</strong>) ranges,
SYMs just get discretized to themelves.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.bin</span><span class="hljs-params">(i,x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>While NUMeric ranges need some post-processing (after binning),
SYMbolic ranges are just ready to go.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.bins</span><span class="hljs-params">(i,bins,...)</span></span> <span class="hljs-keyword">return</span> bins <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.div</span><span class="hljs-params">(i,   e)</span></span>
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> k,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.all) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> n&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> e=e-n/i.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/i.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.mid</span><span class="hljs-params">(i,...)</span></span> <span class="hljs-keyword">return</span> i.mode <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <h2 id="some-">SOME <a name=some></a></h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p> NUMs hold their summary
in a <code>SOME</code> object that, once it fills up, replaces old values with the new ones.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.new</span><span class="hljs-params">(i)</span></span> i.all, i.ok, i.n = {}, <span class="hljs-literal">false</span>,<span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.add</span><span class="hljs-params">(i,x,     a)</span></span> 
  i.n, a = <span class="hljs-number">1</span> + i.n, i.all
  <span class="hljs-keyword">if</span>     #a     &lt; the.some     <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; push(a,x)  
  <span class="hljs-keyword">elseif</span> rand() &lt; the.some/i.n <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; a[rand(#a)]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.has</span><span class="hljs-params">(i)</span></span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.ok <span class="hljs-keyword">then</span> <span class="hljs-built_in">sort</span>(i.all) <span class="hljs-keyword">end</span>;i.ok=<span class="hljs-literal">true</span>; <span class="hljs-keyword">return</span> i.all <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <h2 id="num-">NUM <a name=num></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.new</span><span class="hljs-params">(i,at,txt)</span></span> 
  i.at,i.txt=at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>; i.hi= -big;i.lo= big; i.n,i.mu=<span class="hljs-number">0</span>,<span class="hljs-number">0</span> 
  i.w = i.txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> 
  i.all = SOME() <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.add</span><span class="hljs-params">(i,x)</span></span> 
  <span class="hljs-keyword">if</span> x ~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    i.all:add(x) 
    i.n     = i.n + <span class="hljs-number">1</span>
    <span class="hljs-keyword">local</span> d = x - i.mu
    i.mu    = i.mu + d/i.n
    i.hi=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(x, i.hi); i.lo=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(x, i.lo) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.bin</span><span class="hljs-params">(i,v,  b)</span></span> b=(i.hi-i.lo)/the.bins;<span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(v/b+<span class="hljs-number">0.5</span>)*b <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p><a name=numbin></a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.bins</span><span class="hljs-params">(i,bins,enough)</span></span>
  <span class="hljs-keyword">local</span> out={}
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cuts</span><span class="hljs-params">(lo,hi,       cut,lhs,rhs,all,tmp,n,best)</span></span>
    lhs, rhs, all = SYM(), SYM(), SYM()
    <span class="hljs-keyword">for</span> j=lo,hi <span class="hljs-keyword">do</span> 
      <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bins[j].ys.all) <span class="hljs-keyword">do</span> all:add(x,n);rhs:add(x,n)<span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    n,best,cut = rhs.n, rhs:div()
    <span class="hljs-keyword">for</span> j=lo,hi <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bins[j].ys.all) <span class="hljs-keyword">do</span> lhs:add(x,n); rhs:<span class="hljs-built_in">sub</span>(x,n) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">if</span> rhs.n &gt;= enough <span class="hljs-keyword">and</span> lhs.n &gt;= enough <span class="hljs-keyword">then</span>
        tmp= rhs:div()*rhs.n/n + lhs:div()*lhs.n/n 
        <span class="hljs-keyword">if</span> tmp &lt; best*<span class="hljs-number">1.01</span> <span class="hljs-keyword">then</span> cut,best =j,tmp <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span>   cut 
    <span class="hljs-keyword">then</span> cuts(lo, cut)
         cuts(cut+<span class="hljs-number">1</span>, hi)
    <span class="hljs-keyword">else</span> push(out, RANGE(i.at, i.txt,bins[lo].xlo, bins[hi].xhi, all)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span> <span class="hljs-comment">--------------------</span>
  cuts(<span class="hljs-number">1</span>,#bins)
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#out <span class="hljs-keyword">do</span> out[j].xlo = out[j<span class="hljs-number">-1</span>].xhi <span class="hljs-keyword">end</span>
  out[<span class="hljs-number">1</span>].xlo, out[#out].xhi = -big, big
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.clone</span><span class="hljs-params">(i)</span></span>     <span class="hljs-keyword">return</span> NUM(i.at,i.txt) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.div</span><span class="hljs-params">(i,  a)</span></span>   a=i.all:has(); <span class="hljs-keyword">return</span> (per(a,<span class="hljs-number">.9</span>) - per(a,<span class="hljs-number">.1</span>))/<span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.mid</span><span class="hljs-params">(i,p)</span></span>     <span class="hljs-keyword">return</span> rnd(i.mu,p <span class="hljs-keyword">or</span> <span class="hljs-number">3</span>) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.norm</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span> i.hi-i.lo&lt;<span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x - i.lo)/(i.hi - i.lo) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <h2 id="row-">ROW <a name=rowlt></a><a name=row></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.new</span><span class="hljs-params">(i,of,cells)</span></span> i.of,i.cells,i.evaluated = of,cells,<span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.__lt</span><span class="hljs-params">(i,j,        n,s1,s2,v1,v2)</span></span>
  i.evaluated = <span class="hljs-literal">true</span>
  j.evaluated = <span class="hljs-literal">true</span>
  s1, s2, n = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, #i.of.ys
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.of.ys) <span class="hljs-keyword">do</span>
    v1,v2 = col:norm(i.cells[col.at]), col:norm(j.cells[col.at])
    s1    = s1 - <span class="hljs-number">2.7183</span>^(col.w * (v1 - v2) / n)
    s2    = s2 - <span class="hljs-number">2.7183</span>^(col.w * (v2 - v1) / n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/n &lt; s2/n <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <h2 id="rows-">ROWS <a name=rows></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.new</span><span class="hljs-params">(i,src)</span></span>
  i.all={}; i.cols={}; i.xs={}; i.ys={}; i.names={}
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span>   row <span class="hljs-keyword">in</span> csv(  src) <span class="hljs-keyword">do</span> i:add(row) <span class="hljs-keyword">end</span> 
                         <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> i:add(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.clone</span><span class="hljs-params">(i,inits,   j)</span></span>
  j=ROWS{i.names}; <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> j:add(row)<span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.add</span><span class="hljs-params">(i,row)</span></span> 
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">header</span><span class="hljs-params">(   col)</span></span>
    i.names = row
    <span class="hljs-keyword">for</span> at,s <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(row) <span class="hljs-keyword">do</span>
      col = push(i.cols, (s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(at,s))
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span> <span class="hljs-keyword">then</span> i.klass = col <span class="hljs-keyword">end</span>
        push(s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">and</span> i.ys <span class="hljs-keyword">or</span> i.xs, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------------------------</span>
  <span class="hljs-keyword">if</span> #i.cols==<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> header(row) <span class="hljs-keyword">else</span>
    row = push(i.all, row.cells <span class="hljs-keyword">and</span> row <span class="hljs-keyword">or</span> ROW(i,row))
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols) <span class="hljs-keyword">do</span> col:add(row.cells[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.bestRest</span><span class="hljs-params">(i,  n,m)</span></span>
  <span class="hljs-built_in">sort</span>(i.all)
  n = #i.all
  m = n^the.<span class="hljs-built_in">min</span>  
  <span class="hljs-keyword">return</span> splice(i.all, <span class="hljs-number">1</span>,  m), splice(i.all, n - m) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.mid</span><span class="hljs-params">(i,    p,t)</span></span> 
  t={}; <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.ys) <span class="hljs-keyword">do</span> t[col.txt]=col:mid(p) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.bins</span><span class="hljs-params">(i,bests,rests)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bins1</span><span class="hljs-params">(col,data,         tmp,bins,x,bin, out)</span></span>
    tmp, bins = {}, {}
    <span class="hljs-keyword">for</span> klass,rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{bests,rests} <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">for</span> n,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
        x = row.cells[col.at]
        <span class="hljs-keyword">if</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
          bin  = col:bin(x)
          tmp[bin] = tmp[bin] <span class="hljs-keyword">or</span> push(bins, RANGE(col.at,col.txt,x))
          tmp[bin]:add(x,klass) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    out = col:bins(<span class="hljs-built_in">sort</span>(bins,lt<span class="hljs-string">&quot;xlo&quot;</span>),  (#bests+#rests)^the.<span class="hljs-built_in">min</span>)  
    <span class="hljs-keyword">if</span> col.is==<span class="hljs-string">&quot;NUM&quot;</span> <span class="hljs-keyword">then</span> out[<span class="hljs-number">1</span>].xlo , out[#out].xhi = -big, big <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> #out &gt;<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> out <span class="hljs-keyword">or</span> {}
  <span class="hljs-keyword">end</span> <span class="hljs-comment">--------</span>
  <span class="hljs-keyword">local</span> out={}
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.xs) <span class="hljs-keyword">do</span> <span class="hljs-keyword">for</span> _,b <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bins1(col)) <span class="hljs-keyword">do</span> push(out,b) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(out) <span class="hljs-keyword">do</span> <span class="hljs-built_in">print</span>(k,v,v:score(<span class="hljs-number">1</span>,#bests, #rests)) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> out <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h2 id="lib-">LIB <a name=lib></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
big = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>
rand= <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
fmt = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
     
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(csvfile)</span></span> 
  csvfile = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(csvfile)
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s, t)</span></span> 
    s=<span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> s <span class="hljs-keyword">then</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(csvfile) <span class="hljs-keyword">else</span>
      t={}; <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> s:<span class="hljs-built_in">gmatch</span>(<span class="hljs-string">&quot;([^,]+)&quot;</span>) <span class="hljs-keyword">do</span> t[<span class="hljs-number">1</span>+#t] = toatom(x) <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gt</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &gt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lt</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &lt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> fails=<span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span><span class="hljs-params">(settings,funs,     defaults,todo)</span></span>
  defaults = {}
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main1</span><span class="hljs-params">(fun,      status)</span></span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(defaults) <span class="hljs-keyword">do</span> settings[k]=v <span class="hljs-keyword">end</span> 
    <span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(settings.seed <span class="hljs-keyword">or</span> <span class="hljs-number">10019</span>)
    <span class="hljs-built_in">io</span>.<span class="hljs-built_in">stderr</span>:<span class="hljs-built_in">write</span>(<span class="hljs-string">&quot;.&quot;</span>)
    <span class="hljs-built_in">status</span> = fun() 
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">status</span> ~= <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-- Error&quot;</span>,one,<span class="hljs-built_in">status</span>)
    fails = fails + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------------       </span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(settings) <span class="hljs-keyword">do</span> defaults[k]=v <span class="hljs-keyword">end</span> 
  todo = funs[settings.go] <span class="hljs-keyword">and</span> {settings.go} <span class="hljs-keyword">or</span> map(funs,
                 <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(funs[x])==<span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">for</span> _,one <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(todo)) <span class="hljs-keyword">do</span> main1(funs[one]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f,  u)</span></span> u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(v) <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">oo</span><span class="hljs-params">(x)</span></span>        <span class="hljs-built_in">print</span>(o(x)); <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span><span class="hljs-params">(t,    u)</span></span>
  <span class="hljs-keyword">if</span> #t&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(map(t,<span class="hljs-built_in">tostring</span>),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span>
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u] = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;:%s %s&quot;</span>,k,v) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (t.is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(<span class="hljs-built_in">sort</span>(u),<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span> 
  
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">per</span><span class="hljs-params">(t,p)</span></span>    p=p*#t//<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> t[<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(#t,p))] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span>   t[<span class="hljs-number">1</span>+#t]=x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rnd</span><span class="hljs-params">(n, p)</span></span>   <span class="hljs-keyword">local</span> m=<span class="hljs-number">10</span>^(p <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>); <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(n*m+<span class="hljs-number">0.5</span>)/m  <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span>   <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splice</span><span class="hljs-params">( t, i, j, k,    u)</span></span> 
  u={}; <span class="hljs-keyword">for</span> n=(i <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)//<span class="hljs-number">1</span>, (j <span class="hljs-keyword">or</span> #t)//<span class="hljs-number">1</span>, (k <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)//<span class="hljs-number">1</span> <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=t[n] <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <h2 id="demos-">Demos <a name=demos></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">local</span> no,go = {},{}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span> oo(the); <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.ranges</span><span class="hljs-params">(       rows,bests,rests)</span></span>
  rows = ROWS(the.file)
  bests,rests=rows:bestRest()
  rows:bins(bests,rests) 
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <h2 id="return-">RETURN <a name=return></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">pcall</span>(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> {
           o=o,oo=oo,the=the,EGS=EGS,NUM=NUM,RANGE=RANGE,
           ROW=ROW,ROWS=ROWS,SOME=SOME,SYM=SYM} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <h2 id="main-start-up-">MAIN START UP <a name=start></a></h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">if</span> the.help <span class="hljs-keyword">then</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(<span class="hljs-built_in">print</span>(
  help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;[%u][%u%d]+&quot;</span>, <span class="hljs-string">&quot;\27[31m%1\27[0m&quot;</span>)           <span class="hljs-comment">-- highlight capitals</span>
      :<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\&quot;[^\&quot;]+\&quot;&quot;</span>, <span class="hljs-string">&quot;\27[32m%1\27[0m&quot;</span>)            <span class="hljs-comment">-- highlight strings  </span>
      :<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;(%s)([-][-]?[^%s]+)(%s)&quot;</span>,<span class="hljs-string">&quot;%1\27[33m%2\27[0m%3&quot;</span>),<span class="hljs-comment">--highlight flags</span>
  <span class="hljs-string">&quot;&quot;</span>)) <span class="hljs-keyword">end</span>

main(the,go)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>Last two lines. Do not change. Check for rogues and report any failures.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span><span class="hljs-comment">--[5]</span>
<span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(fails)</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <h2 id="notes">Notes</h2>
<h3 id="contribute-">Contribute <a name=contribute></a></h3>
<p>If you offer updates to this code, please follow the following conventions.</p>
<ul>
<li>Settings generated from “help” string
Settings can be updated from the strings seed in flags
Settings stored in the global “the”</li>
<li>Layout lines 80 chars side (max,ish). Use 2 spaces for “tab”.
Do functions as one-liners (if possible). Multi-line functions need a trailing
blank line. </li>
<li>Use <code>i</code> for self</li>
<li>Use <code>col</code> for a col object.</li>
<li>Use <code>r</code> for rows</li>
<li>Use <code>v</code> for row cells values</li>
<li>Define all local names at top of file (so code can be defined in any order).
Otherwise, don’t make much of use the “local” keyword (too ugly)</li>
<li>Object names are short and UPPER CASE
Constructors need not return constructed instance.
No inheritance (hard to debug)</li>
<li>Tests  in the “go” table at end. Reset settings to defaults after each
(see <code>goes</code>).
Tests pass if they return <code>true</code>, otherwose, add one to a <code>fails</code> counter.</li>
<li>Command line “-go x” calls test “go.x()”.
Command line “-h” shows help  </li>
<li>2nd last line: look for “rogue” globals (there should be none)
Last line: exit to operating system with number of failures seen in tests</li>
</ul>
<h3 id="copyright-">Copyright <a name=copyright></a></h3>
<p>BSD 2-Clause License</p>
<p>Copyright (c) [year], [fullname]</p>
<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>
<ol>
<li>Redistributions of source code must retain the above copyright notice,
this list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.</li>
</ol>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS”
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
