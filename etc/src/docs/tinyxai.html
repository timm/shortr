<!DOCTYPE html>

<html>
<head>
  <title>tinyxai</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tinyxai</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>SHORTr : less (but better) XAI</p>
<p>AI and XAI (explainable artificial intelligence) need not be
hard.  E.g. here’s a few hundred lines of LUA
to search N items to  find and explain the best ones, using just
log(N) evals.  </p>
<p><a href=".."><img src="https://img.shields.io/badge/Lua-%232C2D72.svg?logo=lua&logoColor=white"></a><br>
<a href="https://github.com/timm/shortr/actions/workflows/tests.yml"><img src="https://github.com/timm/shortr/actions/workflows/tests.yml/badge.svg"></a><br>
<a href=".."><img src="https://img.shields.io/badge/checked--by-syntastic-yellow?logo=Checkmarx&logoColor=white"></a><br>
<a href="https://opensource.org/licenses/BSD-2-Clause"><img  src="https://img.shields.io/badge/License-BSD%202--Clause-orange.svg?logo=opensourceinitiative&logoColor=white"></a><br>
<a href="https://zenodo.org/badge/latestdoi/206205826"> <img  src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> 
<br clear=all></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> help=<span class="hljs-string">[[

TINYXAI.lua: dont fuse on non-numerics

USAGE:
  lua tinyxai.lua [OPTIONS]

OPTIONS:
 -b bins     max number of bins    = 16
 -c cohen    difference in nums    = .35
 -f file     source                = ../../data/auto93.csv
 -F far      how far is far        = .95
 -g go       action                = help
 -h help     show help             = false
 -m min      size of small         = .5
 -p p        distance coefficient  = 2
 -S samples  samples               = 64
 -s seed     random number seed    = 10019]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="names">Names</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h4 id="locals">Locals</h4>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Store old names (so, on last line, we can check for rogue locals)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> b4={}; <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> b4[k]=k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Define new names from library code (so we can mention them before defining them).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> any,big,cat,chat,coerce,csv,data,fmt,lt
<span class="hljs-keyword">local</span> map,<span class="hljs-built_in">max</span>,<span class="hljs-built_in">min</span>,per,push,rand,shuffle,<span class="hljs-built_in">sort</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Place to store test suites (to disable a test, move it <code>go</code> to <code>no</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> go,no = {},{}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Place to store the settings (and this variable is parsed from help text; e.g. <code>the.bins=16</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> the = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h4 id="objects">Objects</h4>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p><strong>obj(str,fun): class</strong><br><code>Fun</code> is a constructor for instances of class <code>str</code>.
BTW, polymorphism, encapsulation, classes, instance, constructors, all  in 3 lines. :-)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj</span><span class="hljs-params">(txt,fun,  t,i)</span></span> 
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(k,...)</span></span> i=<span class="hljs-built_in">setmetatable</span>({},k); fun(i,...); <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>
  t={<span class="hljs-built_in">__tostring</span> = cat}; t.<span class="hljs-built_in">__index</span> = t;<span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(t,{<span class="hljs-built_in">__call</span>=new}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p><strong>ROW(tab)</strong><br>Stores one record. ROWs are stored in a contained called ROWS.
Implementation note: ROWs are created when data is read from CSV files.
After that, if a ROW is added to more than one ROWS object then the same
ROW will be held in different ROWSs. This makes certain labelling and
record keep tasks easier (e.g. tracking how many rows we have evaluated).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> ROW=obj(<span class="hljs-string">&quot;ROW&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,cells)</span></span> 
  <span class="hljs-built_in">self</span>.cells = {}           <span class="hljs-comment">-- place to hold one record</span>
  <span class="hljs-built_in">self</span>.label  = <span class="hljs-literal">false</span>       <span class="hljs-comment">-- true if we have decided  this ROW is &quot;best&quot;?</span>
  <span class="hljs-built_in">self</span>.evaled = <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- have we accessed this row&#x27;s y-values?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p><strong>SYM(?num=0, ?str=””)</strong><br>Summarizes streams of symbols in ROWs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> SYM=obj(<span class="hljs-string">&quot;SYM&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,at,txt)</span></span> 
  <span class="hljs-built_in">self</span>.n   = <span class="hljs-number">0</span>          <span class="hljs-comment">-- number of items seen</span>
  <span class="hljs-built_in">self</span>.at  = at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>    <span class="hljs-comment">-- column number</span>
  <span class="hljs-built_in">self</span>.txt = txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment">-- column name</span>
  <span class="hljs-built_in">self</span>.kept= {}   <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- counters for symbols</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><strong>NUM(?num=0, ?str=””)</strong><br>Summarize streams of numbers in ROWs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> NUM=obj(<span class="hljs-string">&quot;NUM&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,at,txt)</span></span> 
  <span class="hljs-built_in">self</span>.n   = <span class="hljs-number">0</span>                        <span class="hljs-comment">-- number of items seen</span>
  <span class="hljs-built_in">self</span>.at  = at   <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>                <span class="hljs-comment">-- column number</span>
  txt=txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-built_in">self</span>.txt = txt                      <span class="hljs-comment">-- column name</span>
  <span class="hljs-built_in">self</span>.w   = txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- If minimizing, then -1. Else 1</span>
  <span class="hljs-built_in">self</span>.kept= {}                       <span class="hljs-comment">-- some sample of the seen items</span>
  <span class="hljs-built_in">self</span>.ok  = <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>)               <span class="hljs-comment">-- true if sorted, set to false by each add</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p><strong>COLS([str]+)</strong><br>Factory for making NUMs or SYMs from list of col names.
Column names starting with upper case are NUMs (others are SYMs).
Anything adding with “!+-“ is a dependent goal column.
Column names ending with “<code>:</code>“ are “skipped”; i.e. 
not added to the list of independent or dependent columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> COLS=obj(<span class="hljs-string">&quot;COLS&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,  names)</span></span>
  <span class="hljs-built_in">self</span>.names= names <span class="hljs-comment">-- list of column names</span>
  <span class="hljs-built_in">self</span>.all  = {}    <span class="hljs-comment">-- [NUM|SYM] all names, converted to NUMs or SYMs</span>
  <span class="hljs-built_in">self</span>.x    = {}    <span class="hljs-comment">-- [NUM|SYM] just the independent columns</span>
  <span class="hljs-built_in">self</span>.y    = {}    <span class="hljs-comment">-- [NUM|SYM] just the dependent columns</span>
  <span class="hljs-built_in">self</span>.klass= <span class="hljs-literal">nil</span>   <span class="hljs-comment">-- SYM       the klass column (if it exists)</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(names) <span class="hljs-keyword">do</span>
    col= push(<span class="hljs-built_in">self</span>.all, (v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(at,txt))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.klass = col <span class="hljs-keyword">end</span>
      push(v:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.y <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p><strong>ROWS()</strong><br>Stores <code>rows</code> and their summaries in <code>cols</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> ROWS=obj(<span class="hljs-string">&quot;ROWS&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self)</span></span> 
  <span class="hljs-built_in">self</span>.rows = {}        <span class="hljs-comment">-- [ROW] records, stored as ROW</span>
  <span class="hljs-built_in">self</span>.cols = <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- a COLS instance (if nil, no data read yet)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p><strong>BIN( NUM|SYM, num, ?num=lo, ?SYM)</strong><br>Values from same rows in 2 columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> BIN=obj(<span class="hljs-string">&quot;BIN&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,col, lo, hi, has)</span></span> 
  <span class="hljs-built_in">self</span>.col = col               <span class="hljs-comment">-- What column does this bin handle?</span>
  <span class="hljs-built_in">self</span>.lo  = lo                <span class="hljs-comment">-- Lowest value of column1.</span>
  <span class="hljs-built_in">self</span>.hi  = hi <span class="hljs-keyword">or</span> lo          <span class="hljs-comment">-- Highest value of column1</span>
  <span class="hljs-built_in">self</span>.has = has <span class="hljs-keyword">or</span> SYM() <span class="hljs-keyword">end</span>) <span class="hljs-comment">-- Symbol counts of column2 values.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <h2 id="columns">Columns</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Columns summarize sets of rows.</p>
<h3 id="sym">Sym</h3>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <h4 id="create">Create</h4>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  merge(SYM): SYM</strong><br>Create a new SYM by merging two others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:merge</span><span class="hljs-params">(other,    k)</span></span>
  k= SYM(<span class="hljs-built_in">self</span>.at, <span class="hljs-built_in">self</span>.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.kept)  <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(other.kept) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  add(any,?num=1)</strong><br>Add a symbols <code>x</code>. Do it <code>n</code> times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:add</span><span class="hljs-params">(x,n)</span></span> 
  n = n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.n=<span class="hljs-built_in">self</span>.n+n; <span class="hljs-built_in">self</span>.kept[x]=n + (<span class="hljs-built_in">self</span>.kept[x]+<span class="hljs-number">0</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <h4 id="query">Query</h4>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  div():num</strong><br>Diversity. Return entropy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:div</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> sum(<span class="hljs-built_in">self</span>.kept, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span> <span class="hljs-keyword">return</span> -n/i.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/i.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  dist(atom,atom):num</strong><br>Identical symbols have distance 0. Otherwise, 1.
If any unknowns, assume max distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:dist</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> (x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span>  y==<span class="hljs-string">&quot;?&quot;</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <h4 id="discretization">Discretization</h4>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  bin(any):any -0 Discretize a symbol (do nothing)</strong><br></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:bin</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  merges(t,…):SYM</strong><br>Merge adjacent bins (do nothing: SYM ranges dont’t merge)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:merges</span><span class="hljs-params">(t,...)</span></span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <h3 id="num">Num</h3>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  add(num)</strong><br>Add <code>x</code>. If no space, at prob <code>some/n</code>, replace any old number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:add</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
    <span class="hljs-keyword">local</span> pos
    <span class="hljs-keyword">if</span> #<span class="hljs-built_in">self</span>.kept &lt; the.some        <span class="hljs-keyword">then</span> pos= #i.kept+<span class="hljs-number">1</span> 
    <span class="hljs-keyword">elseif</span> rand() &lt; the.some/<span class="hljs-built_in">self</span>.n <span class="hljs-keyword">then</span> pos= rand(#i.kept) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">then</span> 
      <span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">false</span>  <span class="hljs-comment">-- the `kept` list is no longer in sorted order</span>
      <span class="hljs-built_in">self</span>.kept[pos]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <h4 id="query">Query</h4>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  has()</strong><br>Return <code>kept</code>, ensuring it is sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:has</span><span class="hljs-params">()</span></span>
  <span class="hljs-built_in">self</span>.kept = <span class="hljs-built_in">self</span>.ok <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.kept <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.kept)
  <span class="hljs-built_in">self</span>.ok = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.kept <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  norm(x):num</strong><br>Normalize x,y to 0..1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:norm</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">local</span> a =  <span class="hljs-built_in">self</span>:has()
  <span class="hljs-keyword">local</span> lo,hi = a[<span class="hljs-number">1</span>], a[#a]
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(hi-lo)&lt;<span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x-lo)/(hi-lo+<span class="hljs-number">1</span>/big) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  dist(x,y):num</strong><br>Normalize x,y to 0..1, report their difference.
If any unknowns, assume max distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:dist</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> y=<span class="hljs-built_in">self</span>:norm(y); x=y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> x=<span class="hljs-built_in">self</span>:norm(x); y=x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span>   x,y = <span class="hljs-built_in">self</span>:norm(x), <span class="hljs-built_in">self</span>:norm(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <h4 id="discretization">Discretization</h4>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  bin(any):any</strong><br>Discretize a num to one of <code>the.bins</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:bin</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">local</span> a = <span class="hljs-built_in">self</span>:has()
  <span class="hljs-keyword">local</span> lo,hi = a[<span class="hljs-number">1</span>], a[#a]
  <span class="hljs-keyword">local</span> b = (hi - lo)/the.bins
  <span class="hljs-keyword">return</span> hi==lo <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">.5</span>)*b <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  merges([BIN],…) :[BIN]</strong><br>Prune superflous bins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:merges</span><span class="hljs-params">(b4, min)</span></span> 
  <span class="hljs-keyword">local</span> n,now = <span class="hljs-number">1</span>,{}
  <span class="hljs-keyword">while</span> n &lt;= #b4 <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> merged = n&lt;#b4 <span class="hljs-keyword">and</span> b4[n]:merged(b4[n+<span class="hljs-number">1</span>],<span class="hljs-built_in">min</span>) <span class="hljs-comment">-- defined in BIN</span>
    now[#now+<span class="hljs-number">1</span>]  = merged <span class="hljs-keyword">or</span> b4[n]
    n            = n + (merged <span class="hljs-keyword">and</span> <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">-- if merged, skip over merged bin</span>
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-- end while</span>
  <span class="hljs-keyword">if</span> #now &lt; #b4 <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:merges(now,<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span>     <span class="hljs-comment">-- seek others to merge</span>
  bins[<span class="hljs-number">1</span>].lo,bins[#bins].hi = -big,big            <span class="hljs-comment">-- grow to plus/minus infinity</span>
  <span class="hljs-keyword">return</span> bins <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <h2 id="data">Data</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h3 id="meta">Meta</h3>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  add(ROW)</strong><br>update the non-skipped columns with values from ROW</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:add</span><span class="hljs-params">(row)</span></span>
  <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{<span class="hljs-built_in">self</span>.x, <span class="hljs-built_in">self</span>.y} <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> col:add(row.cells[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  dist(ROW,ROW) :num</strong><br>Using <code>x</code> columns, compute distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:dist</span><span class="hljs-params">(r1,r2)</span></span>
  <span class="hljs-keyword">local</span> d,x1,x2 = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.x) <span class="hljs-keyword">do</span> 
    x1 = r1.cells[col.at]
    x2 = r2.cells[col.at]
    d  = d+(col:dist(x1,x2))^the.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/#<span class="hljs-built_in">self</span>.x)^(<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>function COLS:half(rows,b4)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">local</span> tmp, abc, i, xCs = {}
  abc = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(A,B)</span></span> <span class="hljs-keyword">return</span> {A=A, B=B, As={}, Bs={}, c=<span class="hljs-built_in">self</span>:dist(A,B)} <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> n=<span class="hljs-number">1</span>,the.samples <span class="hljs-keyword">do</span> push(tmp, abc(b4 <span class="hljs-keyword">or</span> any(rows), any(rows))) <span class="hljs-keyword">end</span>
  i   = per(<span class="hljs-built_in">sort</span>(tmp,lt<span class="hljs-string">&quot;c&quot;</span>), the.far)
  xCs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(C)</span></span>     
          <span class="hljs-keyword">return</span> {x = (<span class="hljs-built_in">self</span>:dist(C,i.A)^<span class="hljs-number">2</span>+i.c^<span class="hljs-number">2</span>-<span class="hljs-built_in">self</span>:dist(C,i.B)^<span class="hljs-number">2</span>)/(<span class="hljs-number">2</span>*i.c),
                  C = C} <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> j,xC <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(map(rows,xCs),lt<span class="hljs-string">&quot;x&quot;</span>)) <span class="hljs-keyword">do</span>
    push(j&lt;#rows/<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> i.As <span class="hljs-keyword">or</span> i.Bs, xC.C) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <h4 id="optimization">Optimization</h4>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p>-&gt; COLS:best(ROW,ROW) :bool -&gt; Multi-objective comparisons. True if moving to self losses least than moving to other.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:best</span><span class="hljs-params">(r1,r2)</span></span>
  r1.evaled,r2.evaled = <span class="hljs-literal">true</span>,<span class="hljs-literal">true</span>
  <span class="hljs-keyword">local</span> s1, s2, ys, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>.y, <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ys) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> x = col:norm(r1.cells[col.at])
    <span class="hljs-keyword">local</span> y = col:norm(r2.cells[col.at])
    s1      = s1 - e^(col.w * (x-y)/#ys)
    s2      = s2 - e^(col.w * (y-x)/#ys) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#ys &lt; s2/#ys  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p>-&gt; COLS:bests([ROW]):bests=[ROW],rests=[ROW] -&gt; Recursively apply <code>best</code>. Return most preferred rows, and the rest.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:bests</span><span class="hljs-params">(rows,    b4,stop,rests)</span></span>
  rests = rests <span class="hljs-keyword">or</span> {}
  stop  = stop <span class="hljs-keyword">or</span> (#rows)^the.<span class="hljs-built_in">min</span>
  <span class="hljs-keyword">if</span> #rows &lt; stop <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows,rests <span class="hljs-keyword">end</span> <span class="hljs-comment">-- return best=[ROW],rests=[ROW] </span>
  <span class="hljs-keyword">local</span> two = <span class="hljs-built_in">self</span>:half(rows,b4) <span class="hljs-comment">-- if b4 supplied, then half will use it as one pole.</span>
  <span class="hljs-keyword">local</span> best, bests, rests1
  <span class="hljs-keyword">if</span>   <span class="hljs-built_in">self</span>:best(two.A, two.B) 
  <span class="hljs-keyword">then</span> best, bests, rests1 = two.A, two.As, two.Bs
       <span class="hljs-keyword">for</span> i=#rests1,<span class="hljs-number">1</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> push(rests, rests1[i]) <span class="hljs-keyword">end</span> <span class="hljs-comment">-- rests sorted, L to R, worst to better</span>
  <span class="hljs-keyword">else</span> best, bests, rests1 = two.B, two.Bs, two.As
       <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>,#rests1, <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> push(rests, rests1[i]) <span class="hljs-keyword">end</span> <span class="hljs-comment">-- rests sorted, L to R, worst to better</span>
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:best(bests, best, stop,rests) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:add</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-built_in">self</span>.lo = <span class="hljs-built_in">min</span>(x,<span class="hljs-built_in">self</span>.lo)
  <span class="hljs-built_in">self</span>.hi = <span class="hljs-built_in">max</span>(x,<span class="hljs-built_in">self</span>.hi)
  <span class="hljs-built_in">self</span>:has(y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:merged</span><span class="hljs-params">(j, min)</span></span>
  <span class="hljs-keyword">local</span> a, b, c = <span class="hljs-built_in">self</span>.has, j.has, <span class="hljs-built_in">self</span>.has:merge(j.has)
  <span class="hljs-keyword">local</span> should = a.n &lt; <span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> b.n &lt; <span class="hljs-built_in">min</span>  
  <span class="hljs-keyword">local</span> can    = c:div() &lt;= (a.n*a:div() + b.n*b:div())/c.n 
  <span class="hljs-keyword">if</span> should <span class="hljs-keyword">or</span> can <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> BIN(a.col,<span class="hljs-built_in">self</span>.lo, j.hi, c) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:selects</span><span class="hljs-params">(rows,    select,tmp)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select</span><span class="hljs-params">(row,  v)</span></span>
    v= row.cells[<span class="hljs-built_in">self</span>.col.at]
    <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.lo==<span class="hljs-built_in">self</span>.hi <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.lo&lt;v <span class="hljs-keyword">and</span> v &lt;=<span class="hljs-built_in">self</span>.hu <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  tmp= map(rows,<span class="hljs-built_in">select</span>) 
  <span class="hljs-keyword">if</span> #tmp &lt; #rows <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p>XXX start here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:tree</span><span class="hljs-params">(gaurd,stop)</span></span>
  <span class="hljs-built_in">self</span>.gaurd = gaurd.
  stop = stop <span class="hljs-keyword">or</span> (#<span class="hljs-built_in">self</span>.rows)^the.<span class="hljs-built_in">min</span>
  bests,rests= cols:bests(rows)
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">3</span>*#bests+<span class="hljs-number">1</span>,#rests <span class="hljs-keyword">do</span> rests[i]= <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">local</span> binsDiv = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(col)</span></span> <span class="hljs-keyword">return</span> constrast(col,bests,rests) <span class="hljs-keyword">end</span>
  cols.kids= map(<span class="hljs-built_in">sort</span>(map(cols.x,binsDiv),lt<span class="hljs-string">&quot;div&quot;</span>)[<span class="hljs-number">1</span>].bins,
                 <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bin)</span></span> 
                   <span class="hljs-keyword">local</span> tmp= bin:selects(row),bin)
                   <span class="hljs-keyword">if</span> tmp <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:clone(tmp):tree(bin,stop) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> ) <span class="hljs-keyword">end</span>
      
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">constrast</span><span class="hljs-params">(col,rows)</span></span>
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> v = row[col.at]
    <span class="hljs-keyword">if</span> v ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      n=n+<span class="hljs-number">1</span>
      <span class="hljs-keyword">local</span> pos = col:bin(v)
      dict[pos] = dict[pos] <span class="hljs-keyword">or</span> push(list, BIN(col,v))
      dict[pos]:add(v,row.label) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  list = col:merges(<span class="hljs-built_in">sort</span>(list,lt<span class="hljs-string">&quot;lo&quot;</span>), n^the.<span class="hljs-built_in">min</span>)
  <span class="hljs-keyword">return</span> { bins=list,
           div=sum(list,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> z.has:div()*z.ys.n/n <span class="hljs-keyword">end</span>)} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:file</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> csv(x) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(t) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:adds</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">for</span> _,t1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(t1) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:add</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-keyword">if</span>   <span class="hljs-built_in">self</span>.cols 
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.cols:add(push(i.rows, t.cells <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> ROW(t))) 
  <span class="hljs-keyword">else</span> <span class="hljs-built_in">self</span>.cols=COLS(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <h2 id="lib">Lib</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>big=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span> 
<span class="hljs-built_in">min</span>=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>
<span class="hljs-built_in">max</span>=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>
fmt=<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>
rand=<span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">any</span><span class="hljs-params">(a)</span></span>  <span class="hljs-keyword">return</span> a[rand(#a)] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">per</span><span class="hljs-params">(t,p)</span></span> p=p*#t//<span class="hljs-number">1</span>; <span class="hljs-keyword">return</span> t[<span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(#t,p))] <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span><span class="hljs-params">(t,x)</span></span> t[<span class="hljs-number">1</span>+#t]=x; <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span><span class="hljs-params">(t,f,     u)</span></span> u={};<span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=f(x)<span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sum</span><span class="hljs-params">(t,f,     u)</span></span> u=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u=u+f(x)    <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> u <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sort</span><span class="hljs-params">(t,f)</span></span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(t,f); <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lt</span><span class="hljs-params">(x)</span></span>     <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span> <span class="hljs-keyword">return</span> a[x] &lt; b[x] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shuffle</span><span class="hljs-params">(t,   j)</span></span>
  <span class="hljs-keyword">for</span> i=#t,<span class="hljs-number">2</span>,<span class="hljs-number">-1</span> <span class="hljs-keyword">do</span> j=rand(i); t[i],t[j]=t[j],t[i] <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">coerce</span><span class="hljs-params">(x)</span></span>
  x = x:<span class="hljs-built_in">match</span><span class="hljs-string">&quot;^%s*(.-)%s*$&quot;</span> 
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> 
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.tointeger(x) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tonumber</span>(x) <span class="hljs-keyword">or</span> x <span class="hljs-keyword">end</span>  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chat</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">print</span>(cat(t)) <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cat</span><span class="hljs-params">(t,   show,u)</span></span>  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">(k,v)</span></span> <span class="hljs-keyword">return</span> #t==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (<span class="hljs-string">&quot;:%s %s&quot;</span>):<span class="hljs-built_in">format</span>(k,v) <span class="hljs-keyword">or</span> <span class="hljs-built_in">tostring</span>(v) <span class="hljs-keyword">end</span>
  u={}; <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=show(k,v) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (t._is <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)..<span class="hljs-string">&quot;{&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(#t==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">sort</span>(u) <span class="hljs-keyword">or</span> u,<span class="hljs-string">&quot; &quot;</span>)..<span class="hljs-string">&quot;}&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csv</span><span class="hljs-params">(file,fun)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lines</span><span class="hljs-params">(file, fun)</span></span>
    <span class="hljs-keyword">local</span> file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">input</span>(file)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> line = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">close</span>(file) <span class="hljs-keyword">else</span> fun(line) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-----------------------------</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">words</span><span class="hljs-params">(s,sep,fun,      t)</span></span>
     fun = fun <span class="hljs-keyword">or</span> same
     t={};<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> s:<span class="hljs-built_in">gmatch</span>(fmt(<span class="hljs-string">&quot;([^%s]+)&quot;</span>,sep)) <span class="hljs-keyword">do</span> t[<span class="hljs-number">1</span>+#t]=fun(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------------------------------------------------------------</span>
  <span class="hljs-built_in">lines</span>(file, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span></span> fun(words(line, <span class="hljs-string">&quot;,&quot;</span>, coerce)) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <h2 id="start-up">Start-up</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span> chat(the) <span class="hljs-keyword">end</span>

help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n ([-]%S)[%s]+([%S]+)[^\n]+= ([%S]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f,key,x)</span></span> 
  <span class="hljs-keyword">for</span> n,y <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(<span class="hljs-built_in">arg</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> y==f <span class="hljs-keyword">then</span> 
    x = x==<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> x==<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">arg</span>[n+<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  the[key] = coerce(x) <span class="hljs-keyword">end</span>) 

<span class="hljs-keyword">if</span> the.help <span class="hljs-keyword">then</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">exit</span>(<span class="hljs-built_in">print</span>(help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;[%u][%u%d]+&quot;</span>,<span class="hljs-string">&quot;\27[1;32m%1\27[0m&quot;</span>),<span class="hljs-string">&quot;&quot;</span>)) <span class="hljs-keyword">end</span> 
<span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed)
<span class="hljs-keyword">if</span> go[the.go] <span class="hljs-keyword">then</span> go[the.go]() <span class="hljs-keyword">end</span>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">_ENV</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> b4[k] <span class="hljs-keyword">then</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;?&quot;</span>,k,<span class="hljs-built_in">type</span>(v)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
