<!DOCTYPE html>

<html>
<head>
  <title>nb.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>nb.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>It is vain to do with more what can be done with less.<br>– William Of Occam<p>
The more you have, the more you are occupied.<br>The less you have, the more free you are.<br>– Mother Teresa<p>
Simplicity is the ultimate sophistication.<br>– Leonardo da Vinci<p>
Simplicity is prerequisite for reliability.<br> — Edsger W. Dijkstra<p>
Less is more.<br>– Dieter Rams<p>
less, plz<br>– timm<br><img width=100 align=right  src="flower.png"><br>   </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> help= <span class="hljs-string">[[
NB:  
(c)2022 Tim Menzies, timm@ieee.org
   
OPTIONS:
  -b  --Bins   max number of bins      = 16
  -k  --k      handle rare classes     =  1  
  -m  --m      handle rare attributes  =  2
  -p  --p      distance coefficient    =  2
  -S  --small  small leaf size         = .5
  -w  --wait   wait before classifying =  5

OPTIONS (other):
  -f  --file   file           = ../../data/auto93.csv
  -g  --go     start-up goal  = nothing
  -h  --help   show help      = false
  -s  --seed   seed           = 10019]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h2 id="names">Names</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> _ = <span class="hljs-built_in">require</span><span class="hljs-string">&quot;lib&quot;</span>
<span class="hljs-keyword">local</span> argmax,big               = _.argmax, _.big
<span class="hljs-keyword">local</span> cli,csv,demos,is,normpdf = _.cli, _.csv, _.demos, _.is, _.normpdf
<span class="hljs-keyword">local</span> oo,push,<span class="hljs-built_in">read</span>,rnd,same,str= _.oo, _.push, _.<span class="hljs-built_in">read</span>, _.rnd,_same,_.str

<span class="hljs-keyword">local</span> THE={}
help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot; [-][-]([^%s]+)[^\n]*%s([^%s]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key,x)</span></span> THE[key] = <span class="hljs-built_in">read</span>(x) <span class="hljs-keyword">end</span>)

<span class="hljs-keyword">local</span> NB,NUM,SYM,COLS,ROW,ROWS= is<span class="hljs-string">&quot;NB&quot;</span>,is<span class="hljs-string">&quot;NUM&quot;</span>,is<span class="hljs-string">&quot;SYM&quot;</span>,is<span class="hljs-string">&quot;COLS&quot;</span>,is<span class="hljs-string">&quot;ROW&quot;</span>,is<span class="hljs-string">&quot;ROWS&quot;</span>
<span class="hljs-keyword">local</span> FEW,RANGE, TREE = is<span class="hljs-string">&quot;FEW&quot;</span>, is<span class="hljs-string">&quot;RANGE&quot;</span>, is<span class="hljs-string">&quot;TREE&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h2 id="class-range">class RANGE</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.new</span><span class="hljs-params">(i, xlo, xhi, ys)</span></span> i.xlo, i.xhi, i.ys = xlo, xhi, ys <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.add</span><span class="hljs-params">(i,x,y)</span></span>
  <span class="hljs-keyword">if</span> x &lt; i.xlo <span class="hljs-keyword">then</span> i.xlo = x <span class="hljs-keyword">end</span> <span class="hljs-comment">-- works for string or num</span>
  <span class="hljs-keyword">if</span> x &gt; i.xhi <span class="hljs-keyword">then</span> i.xhi = x <span class="hljs-keyword">end</span> <span class="hljs-comment">-- works for string or num</span>
  i.ys:add(y) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RANGE.__tostring</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x, lo, hi = i.ys.txt, i.xlo, i.xhi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt; %s&quot;</span>,x, lo)  
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s&quot;</span>, x, hi)  
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt; %s &lt;= %s&quot;</span>,lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <h2 id="class-some">class SOME</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.new</span><span class="hljs-params">(i)</span></span> i.n,i.t,i.ok=<span class="hljs-number">0</span>,{},<span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.has</span><span class="hljs-params">(i)</span></span> i.t=i.ok <span class="hljs-keyword">and</span> i.t <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(i.t); i.ok=<span class="hljs-literal">true</span>; <span class="hljs-keyword">return</span> i.t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SOME.add</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  i.n=i.n+<span class="hljs-number">1</span> 
  <span class="hljs-keyword">if</span>     #i.t   &lt; THE.some     <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; push(i.t,x)  
  <span class="hljs-keyword">elseif</span> rand() &lt; THE.some/i.n <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; i.t[rand(#i.t)]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h2 id="class-num">class NUM</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.new</span><span class="hljs-params">(i)</span></span> i.n,i.mu,i.m2,i.mu,i.lo,i.hi,i.some=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,big,-big,SOME() <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.mid</span><span class="hljs-params">(i,p)</span></span>      <span class="hljs-keyword">return</span> rnd(i.mu,p) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.like</span><span class="hljs-params">(i,x,...)</span></span> <span class="hljs-keyword">return</span> normpdf(x, i.mu, i.sd) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.bin</span><span class="hljs-params">(x)</span></span> 
  b=(i.hi - i.lo)/THE.bins; <span class="hljs-keyword">return</span> i.lo==i.hi <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">.5</span>)*b <span class="hljs-keyword">end</span>
    
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.add</span><span class="hljs-params">(i_NUM, v_number)</span></span>
  <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> v <span class="hljs-keyword">end</span>
  i.some:add(v)
  i.n  = i.n + <span class="hljs-number">1</span>
  <span class="hljs-keyword">local</span> d    = v - i.mu
  i.mu = i.mu + d/i.n
  i.m2 = i.m2 + d*(v - i.mu)
  i.sd = i.n&lt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (i.m2/(i.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span> 
  i.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(v, i.lo) 
  i.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(v, i.hi) <span class="hljs-keyword">end</span> 
   
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM.merge</span><span class="hljs-params">(i,j,      k)</span></span>
  <span class="hljs-keyword">local</span> k = NUM(i.at, i.txt)
  <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.some.t) <span class="hljs-keyword">do</span> k:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.some.t) <span class="hljs-keyword">do</span> k:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h2 id="iclass-sym">iclass SYM</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.new</span><span class="hljs-params">(i)</span></span>          i.n,i.syms,i.most,i.mode = <span class="hljs-number">0</span>,{},<span class="hljs-number">0</span>,<span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.mid</span><span class="hljs-params">(i,...)</span></span>      <span class="hljs-keyword">return</span> i.mode <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.like</span><span class="hljs-params">(i,x,prior)</span></span> <span class="hljs-keyword">return</span> ((i.syms[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)+THE.m*prior)/(i.n+THE.m) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.bin</span><span class="hljs-params">(x)</span></span>          <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.add</span><span class="hljs-params">(i,v,inc)</span></span>
  <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> v <span class="hljs-keyword">end</span>
  inc=inc <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  i.n = i.n + inc
  i.syms[v] = inc + (i.syms[v] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
  <span class="hljs-keyword">if</span> i.syms[v] &gt; i.most <span class="hljs-keyword">then</span> i.most,i.mode = i.syms[v],v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM.merge</span><span class="hljs-params">(i,j,      k)</span></span>
  <span class="hljs-keyword">local</span> k = SYM(i.at, i.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.has) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h2 id="cols">COLS</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> is={}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.use</span><span class="hljs-params">(x)</span></span>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.num</span><span class="hljs-params">(x)</span></span>    <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.goal</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.klass</span><span class="hljs-params">(x)</span></span>  <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span>     <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is.weight</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span><span class="hljs-params">(at,txt,          i)</span></span>
  txt = txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  i = (is.nump(txt) <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)()
  i.txt, i.usep, i.at, i.w = txt, is.use(txt), at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, is.weight(txt)
  <span class="hljs-keyword">return</span> i  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS.new</span><span class="hljs-params">(i,t,     col)</span></span>
  i.all, i.xs, i.ys, i.names = {},{},{},t
  <span class="hljs-keyword">for</span> at,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span>
    col = push(i.all, new(at,x))
    <span class="hljs-keyword">if</span> col.usep  <span class="hljs-keyword">then</span> 
      <span class="hljs-keyword">if</span> is.klass(col.txt) <span class="hljs-keyword">then</span> i.klass=col <span class="hljs-keyword">end</span>
      push(is.goal(col.txt) <span class="hljs-keyword">and</span> i.ys <span class="hljs-keyword">or</span> i.xs, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS.add</span><span class="hljs-params">(i,t)</span></span>
  <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{i.xs,i.ys} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> col:add(t[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h2 id="row">ROW</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.new</span><span class="hljs-params">(i,of,cells)</span></span> i.of,i.cells,i.evaled=of,cells,<span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.klass</span><span class="hljs-params">(i)</span></span> <span class="hljs-keyword">return</span> i.cells[i.of.cols.klass.at] <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROW.within</span><span class="hljs-params">(i,range,         lo,hi,at,v)</span></span>
   lo, hi, at = range.xlo, range.xhi, range.ys.at
   v = i.cells[at]
   <span class="hljs-keyword">return</span>  v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> (lo==hi <span class="hljs-keyword">and</span> v==lo) <span class="hljs-keyword">or</span> (lo&lt;v <span class="hljs-keyword">and</span> v&lt;=hi) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <h2 id="rows">ROWS</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doRows</span><span class="hljs-params">(src, fun)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)~=<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> fun(t) <span class="hljs-keyword">end</span>
                         <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span>   t <span class="hljs-keyword">in</span> csv(src)   <span class="hljs-keyword">do</span> fun(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.new</span><span class="hljs-params">(i,t)</span></span> i.cols=COLS(t); i.rows={} <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.add</span><span class="hljs-params">(i,t)</span></span> 
  t=t.cells <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> ROW(i,t)
  i.cols:add(t.cells)
  <span class="hljs-keyword">return</span> push(i.rows, t) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.mid</span><span class="hljs-params">(i, cols, p,     t)</span></span>
  t={};<span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols <span class="hljs-keyword">or</span> i.cols.ys) <span class="hljs-keyword">do</span> t[col.txt]=col:mid(p) <span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.clone</span><span class="hljs-params">(i,t,  j)</span></span> 
  j= ROWS(i.cols.names);<span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> j:add(row) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS.like</span><span class="hljs-params">(i,t, nklasses, nrows,    prior,like,inc,x)</span></span>
  prior = (#i.rows + THE.k) / (nrows + THE.k * nklasses)
  like  = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(prior)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.cols.xs) <span class="hljs-keyword">do</span>
    x = t.cells[col.at] 
    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">and</span> x ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      inc  = col:like(x,prior)
      like = like + <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(inc) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> like <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <h2 id="nb">NB</h2>
<p>(0) Use row1 to initial our <code>overall</code> knowledge of all rows.<br>After that (1) add row to <code>overall</code> and (2) ROWS about this row’s klass.<br>(3) After <code>wait</code> rows, classify row BEFORE updating training knowledge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.new</span><span class="hljs-params">(i,src,report,             row)</span></span>
  report = report <span class="hljs-keyword">or</span> <span class="hljs-built_in">print</span>
  i.overall, i.dict, i.list  = <span class="hljs-literal">nil</span>, {}, {}
  doRows(src, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row,   k)</span></span> 
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.overall <span class="hljs-keyword">then</span> i.overall = ROWS(row) <span class="hljs-keyword">else</span>  <span class="hljs-comment">-- (0) eat row1</span>
      row = i.overall:add(row)                  <span class="hljs-comment">-- add to overall </span>
      <span class="hljs-keyword">if</span> #i.overall.rows &gt; THE.wait <span class="hljs-keyword">then</span> report(row:klass(), i:guess(row)) <span class="hljs-keyword">end</span>
      i:train(row) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span>                 <span class="hljs-comment">-- add tp rows&#x27;s klass</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.train</span><span class="hljs-params">(i,row)</span></span> i:_known(row:klass()):add(row) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB._known</span><span class="hljs-params">(i,k)</span></span>
  i.dict[k] = i.dict[k] <span class="hljs-keyword">or</span> push(i.list,  i.overall:clone()) <span class="hljs-comment">-- klass is known</span>
  i.dict[k].txt = k                            <span class="hljs-comment">-- each klass knows its name</span>
  <span class="hljs-keyword">return</span> i.dict[k] <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NB.guess</span><span class="hljs-params">(i,row)</span></span> 
    <span class="hljs-keyword">return</span> argmax(i.dict, 
      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(klass)</span></span> <span class="hljs-keyword">return</span> klass:like(row,#i.list,#i.overall.rows) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>function TREE.new(i,listOfRows,gaurd)
  i.gaurd, i.kids = gaurd, {}
  of   = listOfRows[1][1].of
  best = sort(map(of.cols.x, 
                 function(col) i:bins(col,listOfRows) end),lt”div”)[1] 
  i.kids = map(best.ranges, function(range) 
            listOfRows1 = {}
local function within(row)       return row:within(best) end 
local function withins(rows)     return map(rows, within) end
map(listOrRanges, function(rows) return withins(rows) end) end
  tmp= map(rows,withins) 
  if #tmp &gt; stop then 
   end)</p>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <h2 id="tree">TREE</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TREE.new</span><span class="hljs-params">(i,setsOfRows,gaurd)</span></span>
  i.gaurd, i.kids, labels = gaurd, {},{}
  xcols,all = <span class="hljs-literal">nil</span>,{}
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">labeller</span><span class="hljs-params">(row)</span></span> <span class="hljs-keyword">return</span> labels[row.id] <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xcolRanges</span><span class="hljs-params">(xcol)</span></span>  <span class="hljs-keyword">return</span> i:bins(all, xcol, SYM, labeller) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> label,rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(setsOfRows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span> 
      labels[row.id] = label 
      push(all,row)
      xcols = row.of.cols.xs <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  ranges= <span class="hljs-built_in">sort</span>(map(xcols, xcolRanges),lt<span class="hljs-string">&quot;div&quot;</span>)[<span class="hljs-number">1</span>].ranges <span class="hljs-keyword">end</span>
  
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TREE.bins</span><span class="hljs-params">(i,rows,xcol,yklass,y)</span></span>
  <span class="hljs-keyword">local</span> n,list, dict = <span class="hljs-number">0</span>,{}, {}
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> v = row.cells[xcol.at]
    <span class="hljs-keyword">if</span> v ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
      n = n + <span class="hljs-number">1</span>
      <span class="hljs-keyword">local</span> pos = xcol:bin(v)
      dict[pos] = dict[pos] <span class="hljs-keyword">or</span> push(list, RANGE(v,v, yklass(xcol.at, xcol.txt)))
      dict[pos]:add(v, y(row)) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  list = <span class="hljs-built_in">sort</span>(list, lt<span class="hljs-string">&quot;xlo&quot;</span>)
  list = xcol.is==<span class="hljs-string">&quot;NUM&quot;</span> <span class="hljs-keyword">and</span> i:_merge(list, n^THE.<span class="hljs-built_in">min</span>) <span class="hljs-keyword">or</span> list
  <span class="hljs-keyword">return</span> {ranges=list,
          div   = sum(list,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> z.ys:div()*z.ys.n/n <span class="hljs-keyword">end</span>)} <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TREE._merge</span><span class="hljs-params">(i,b4,min)</span></span>
  <span class="hljs-keyword">local</span> j,t a,b,c,ay,by,cy = <span class="hljs-number">1</span>,{}
  <span class="hljs-keyword">while</span> j &lt;= #b4 <span class="hljs-keyword">do</span> 
    a, b = b4[j], b4[j+<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> b <span class="hljs-keyword">then</span> 
      ay,by,cy = a.ys, b.ys, a.ys:merge(b.ys)
      <span class="hljs-keyword">if</span> ay.n&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> by.n&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> cy:div() &lt;= (ay.n*ay:div()+by.n*by:div())/cy.n 
      <span class="hljs-keyword">then</span> a = raNGE(a.xlo, b.xhi, cy) 
           j = j + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-comment">-- skip one, since it has just been merged</span>
    t[#t+<span class="hljs-number">1</span>] = a
    j = j + <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> #t &lt; #b4 <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> i:_merge(t,<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#t <span class="hljs-keyword">do</span> t[j].xlo = t[j<span class="hljs-number">-1</span>].xhi <span class="hljs-keyword">end</span>
  t[<span class="hljs-number">1</span>].xlo, t[#t].xhi = -big, big
  <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h2 id="tests">TESTS</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> no,go = {},{}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span>  <span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>); <span class="hljs-built_in">print</span>(THE); <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(THE.p)==<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-keyword">and</span> THE.p==<span class="hljs-number">2</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.argmax</span><span class="hljs-params">(  t,fun)</span></span>
  fun=<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> -x <span class="hljs-keyword">end</span>
  t={<span class="hljs-number">50</span>,<span class="hljs-number">40</span>,<span class="hljs-number">0</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>}
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span> == argmax(t,fun) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.num</span><span class="hljs-params">(n)</span></span> n=NUM(); <span class="hljs-keyword">for</span> x=<span class="hljs-number">1</span>,<span class="hljs-number">100</span> <span class="hljs-keyword">do</span> n:add(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> n.mu==<span class="hljs-number">50.5</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.sym</span><span class="hljs-params">(s)</span></span> 
  s=SYM(); <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>} <span class="hljs-keyword">do</span> s:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s.mode==<span class="hljs-string">&quot;a&quot;</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.csv</span><span class="hljs-params">(    n,s)</span></span> 
  n,s=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> csv(THE.file)  <span class="hljs-keyword">do</span> n=n+<span class="hljs-number">1</span>; <span class="hljs-keyword">if</span> n&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> s=s+row[<span class="hljs-number">1</span>] <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> rnd(s/n,<span class="hljs-number">3</span>) == <span class="hljs-number">5.441</span>  <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.rows</span><span class="hljs-params">(    rows)</span></span>
  doRows(THE.file,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">if</span> rows <span class="hljs-keyword">then</span> rows:add(t)  <span class="hljs-keyword">else</span> rows=ROWS(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>) 
  <span class="hljs-keyword">return</span> rnd(rows.cols.ys[<span class="hljs-number">1</span>].sd,<span class="hljs-number">0</span>)==<span class="hljs-number">847</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.nb</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-number">268</span> == #NB(<span class="hljs-string">&quot;../../data/diabetes.csv&quot;</span>).dict[<span class="hljs-string">&quot;positive&quot;</span>].rows  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_classify</span><span class="hljs-params">(file)</span></span> 
  <span class="hljs-keyword">local</span> Abcd=<span class="hljs-built_in">require</span><span class="hljs-string">&quot;abcd&quot;</span>
  <span class="hljs-keyword">local</span> abcd=Abcd()
  NB(file, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(got,want)</span></span> abcd:add(got,want) <span class="hljs-keyword">end</span>)
  abcd:pretty(abcd:report())
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.soybean</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> _classify(<span class="hljs-string">&quot;../../data/soybean.csv&quot;</span>) <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.diabetes</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> _classify(<span class="hljs-string">&quot;../../data/diabetes.csv&quot;</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <h2 id="start">START</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>    <span class="hljs-built_in">pcall</span>(<span class="hljs-built_in">debug</span>.<span class="hljs-built_in">getlocal</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">then</span>  <span class="hljs-keyword">return</span> {ROW=ROW, ROWS=ROWS, NUM=NUM, SYM=SYM, THE=THE,lib=lib} 
<span class="hljs-keyword">else</span>  THE = cli(THE,help)
      demos(THE,go) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <pre><code>   .<span class="hljs-comment">---------.</span>
   |         |
 -= _________ =-
    ___   ___
   |   )=(   |
    <span class="hljs-comment">---   --- </span>
       ###
     #  =  #    <span class="hljs-string">&quot;This ain&#x27;t chemistry. 
     #######     This is art.&quot;</span>
</code></pre>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
