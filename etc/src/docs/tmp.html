<!DOCTYPE html>

<html>
<head>
  <title>tmp.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tmp.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p><span id="forkongithub"><a href="https://github.com/timm/shortr">Fork me on GitHub</a></span></p>
<p><em>“If you cannot - in the long run - (explain to)
    everyone what you have been doing,
    your doing  has been worthless.”</em><br>- Erwin Schrodinger</p>
<p><em>And I say, hey-ey-ey-a-ey, hey-ey-ey-ey
    I said “Hey, a-what’s going on?”</em> <br>- 4 Non Blondes</p>
<p>AI and XAI (explainable artificial intelligence) need not be
hard.  E.g. here’s a few hundred lines of LUA
to search N items to  find and explain the best ones, using just
log(N) evals.  </p>
<p>This code makes extensive use of a ROWS object.  Data from disk
becomes a ROWS. ROWS are recursive bi-clustered by partitioning on
the distance to two distant points (found after a few dozen random
projections).  Each cluster is new ROWS object, containing a subset
of the data. A decision tree is built that reports the difference
between the “best” and “worst” clusters (defined using a multi-objective
domination predicate) and that tree is just a  ser
of ROWS with <code>kids</code> pointer to sub-RWS).  This process
only needs log2(N) queries to y-values (while clustering,
just on the pairs of
distance objects).</p>
<p>This code starts with a help string (from which we extract our global settings)
and ends with a library of demos (see the <code>go</code> functions at end of file).<br>Each setting can be (optionally) updated by a command-line flag.
Demos can be run separately or  all at once (using <code>-g all</code>).
  For regression tests, we report the failures seen when the demos run.</p>
<p><a href="https://github.com/timm/shortr/actions/workflows/tests.yml"><img src="https://github.com/timm/shortr/actions/workflows/tests.yml/badge.svg"></a>
&lt;<a href="a">a</a> href=”<a href="https://opensource.org/licenses/BSD-2-Clause&quot;&gt;">https://opensource.org/licenses/BSD-2-Clause&quot;&gt;</a><img  src="https://img.shields.io/badge/License-BSD%202--Clause-orange.svg?logo=opensourceinitiative&logoColor=white"></a>
<a href=".."><img src="https://img.shields.io/badge/Lua-%232C2D72.svg?logo=lua&logoColor=white"></a><br>
<a href="https://zenodo.org/badge/latestdoi/206205826"> <img  src="https://zenodo.org/badge/206205826.svg" alt="DOI"></a> 
<br clear=all></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> help=<span class="hljs-string">[[

XPLAN.lua: semi-supervised multi-objective explanation 
Finds sqrt(N) best things using log2(N) evaluations.
(c)2022, Tim Menzies &lt;timm@ieee.org&gt;, BSD-2 license

SYNOPSIS:
  Data, with multiple dependent goals, is recursive
  bi-clustered on independent variables by partitioning
  on the distance to two distant points (found via
  random projections).  The delta between best and worst
  clustered (defined via a multi-objective comparison)
  is then reported as a decision tree after discretizing
  numerics to best distinguish best and worst.
  This process only makes log2(N) queries to y-values
  (while clustering, just on the pairs of distance objects).

USAGE:
  lua xplan.lua [OPTIONS]

OPTIONS:
 -b bins         max number of bins    = 16
 -c cohen        difference in nums    = .35
 -f file         source                = ../../data/auto93.csv
 -F Far          how far is far        = .95
 -g go           action                = nothing
 -h help         show help             = false
 -m min          size of small         = .5
 -p p            distance coefficient  = 2
 -r rests        number of rests to use= 4
 -s seed         random number seed    = 10019
 -S Some         how many nums to keep = 256]]</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="names">Names</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h4 id="locals">Locals</h4>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Place for names from library</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> l=<span class="hljs-built_in">require</span><span class="hljs-string">&quot;lib&quot;</span>
<span class="hljs-keyword">local</span> any,big,cat,chat,coerce,csv   = l.any,l.big,l.cat,l.chat,l.coerce,l.csv
<span class="hljs-keyword">local</span> fmt,kap,lt,many,map,<span class="hljs-built_in">max</span>,<span class="hljs-built_in">min</span>   = l.fmt,l.kap,l.lt, l.many,l.map,l.<span class="hljs-built_in">max</span>,l.<span class="hljs-built_in">min</span>
<span class="hljs-keyword">local</span> obj,per,push,rand,rev,rnd,rnds= l.obj,l.per,l.push,l.rand,l.rev,l.rnd,l.rnds
<span class="hljs-keyword">local</span> shuffle,<span class="hljs-built_in">sort</span>,sum              = l.shuffle,l.<span class="hljs-built_in">sort</span>,l.sum</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Place for settings (parsed from help text; e.g. <code>the.bins=16</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> the = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h4 id="objects">Objects</h4>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>ROW(tab)</strong><br>Stores one record. ROWs are stored in a contained called ROWS.
Implementation note: ROWs are created when data is read from CSV files.
After that, if a ROW is added to more than one ROWS object then the same
ROW will be held in different ROWSs. This makes certain labelling and
record keep tasks easier (e.g. tracking how many rows we have evaluated).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> ROW=obj(<span class="hljs-string">&quot;ROW&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,cells)</span></span> 
  <span class="hljs-built_in">self</span>.cells = cells        <span class="hljs-comment">-- place to hold one record</span>
  <span class="hljs-built_in">self</span>.label  = <span class="hljs-literal">false</span>       <span class="hljs-comment">-- true if we have decided  this ROW is &quot;best&quot;?</span>
  <span class="hljs-built_in">self</span>.evaled = <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- have we accessed this row&#x27;s y-values?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p><strong>SYM(?num=0, ?str=””)</strong><br>Summarizes streams of symbols in ROWs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> SYM=obj(<span class="hljs-string">&quot;SYM&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,at,txt)</span></span> 
  <span class="hljs-built_in">self</span>.n   = <span class="hljs-number">0</span>          <span class="hljs-comment">-- number of items seen</span>
  <span class="hljs-built_in">self</span>.at  = at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>    <span class="hljs-comment">-- column number</span>
  <span class="hljs-built_in">self</span>.txt = txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment">-- column name</span>
  <span class="hljs-built_in">self</span>.kept= {}   <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- counters for symbols</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p><strong>NUM(?num=0, ?str=””)</strong><br>Summarize streams of numbers in ROWs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> NUM=obj(<span class="hljs-string">&quot;NUM&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,at,txt)</span></span> 
  <span class="hljs-built_in">self</span>.n   = <span class="hljs-number">0</span>                        <span class="hljs-comment">-- number of items seen</span>
  <span class="hljs-built_in">self</span>.at  = at   <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>                <span class="hljs-comment">-- column number</span>
  txt=txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-built_in">self</span>.txt = txt                      <span class="hljs-comment">-- column name</span>
  <span class="hljs-built_in">self</span>.w   = txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- If minimizing, then -1. Else 1</span>
  <span class="hljs-built_in">self</span>.kept= {}                       <span class="hljs-comment">-- some sample of the seen items</span>
  <span class="hljs-built_in">self</span>.ok  = <span class="hljs-literal">false</span> <span class="hljs-keyword">end</span>)               <span class="hljs-comment">-- true if sorted, set to false by each add</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p><strong>COLS([str]+)</strong><br>Factory for making NUMs or SYMs from list of col names.
Column names starting with upper case are NUMs (others are SYMs).
Anything adding with “!+-“ is a dependent goal column.
Column names ending with “<code>:</code>“ are “skipped”; i.e. 
not added to the list of independent or dependent columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> COLS=obj(<span class="hljs-string">&quot;COLS&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,  names)</span></span>
  <span class="hljs-built_in">self</span>.names= names <span class="hljs-comment">-- list of column names</span>
  <span class="hljs-built_in">self</span>.all  = {}    <span class="hljs-comment">-- [NUM|SYM] all names, converted to NUMs or SYMs</span>
  <span class="hljs-built_in">self</span>.x    = {}    <span class="hljs-comment">-- [NUM|SYM] just the independent columns</span>
  <span class="hljs-built_in">self</span>.y    = {}    <span class="hljs-comment">-- [NUM|SYM] just the dependent columns</span>
  <span class="hljs-built_in">self</span>.klass= <span class="hljs-literal">nil</span>   <span class="hljs-comment">-- SYM       the klass column (if it exists)</span>
  <span class="hljs-keyword">for</span> at,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(names) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> col= push(<span class="hljs-built_in">self</span>.all, (txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> NUM <span class="hljs-keyword">or</span> SYM)(at,txt))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span>
      <span class="hljs-keyword">if</span> txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.klass = col <span class="hljs-keyword">end</span>
      push(txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.y <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.x, col) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p><strong>ROWS()</strong><br>Stores <code>rows</code> and their summaries in <code>cols</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> ROWS=obj(<span class="hljs-string">&quot;ROWS&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self)</span></span> 
  <span class="hljs-built_in">self</span>.rows = {}        <span class="hljs-comment">-- [ROW] records, stored as ROW</span>
  <span class="hljs-built_in">self</span>.cols = <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>)  <span class="hljs-comment">-- a COLS instance (if nil, no data read yet)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p><strong>BIN( NUM|SYM, num, ?num=lo, ?SYM)</strong><br>Values from same rows in 2 columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> BIN=obj(<span class="hljs-string">&quot;BIN&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self,col, lo, hi, has)</span></span> 
  <span class="hljs-built_in">self</span>.col = col               <span class="hljs-comment">-- What column does this bin handle?</span>
  <span class="hljs-built_in">self</span>.lo  = lo                <span class="hljs-comment">-- Lowest value of column1.</span>
  <span class="hljs-built_in">self</span>.hi  = hi <span class="hljs-keyword">or</span> lo          <span class="hljs-comment">-- Highest value of column1</span>
  <span class="hljs-built_in">self</span>.has = has <span class="hljs-keyword">or</span> SYM() <span class="hljs-keyword">end</span>) <span class="hljs-comment">-- Symbol counts of column2 values.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h2 id="columns">Columns</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h3 id="sym">Sym</h3>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h4 id="create">Create</h4>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  merge(SYM): SYM</strong><br>Create a new SYM by merging two others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:merge</span><span class="hljs-params">(other,    k)</span></span>
  k= SYM(<span class="hljs-built_in">self</span>.at, <span class="hljs-built_in">self</span>.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.kept)  <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(other.kept) <span class="hljs-keyword">do</span> k:add(x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> k <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  add(any,?num=1)</strong><br>Add a symbols <code>x</code>. Do it <code>n</code> times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:add</span><span class="hljs-params">(x,n)</span></span> 
  n = n <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.n=<span class="hljs-built_in">self</span>.n+n; <span class="hljs-built_in">self</span>.kept[x]=n + (<span class="hljs-built_in">self</span>.kept[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <h4 id="query">Query</h4>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  div():num</strong><br>Diversity. Return entropy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:div</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> sum(<span class="hljs-built_in">self</span>.kept, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span> <span class="hljs-keyword">return</span> -n/<span class="hljs-built_in">self</span>.n*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(n/<span class="hljs-built_in">self</span>.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  mid():num</strong><br>Return <code>mid</code>dle (mode) symbol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:mid</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">local</span> most,mode = <span class="hljs-number">-1</span>,<span class="hljs-literal">nil</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.kept) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> n&gt;most <span class="hljs-keyword">then</span> most,mode=n,x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> mode <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  dist(atom,atom):num</strong><br>Identical symbols have distance 0. Otherwise, 1.
If any unknowns, assume max distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:dist</span><span class="hljs-params">(x,y)</span></span> <span class="hljs-keyword">return</span> (x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span>  y==<span class="hljs-string">&quot;?&quot;</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> x==y <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <h4 id="discretization">Discretization</h4>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  bin(any):any</strong><br>Discretize a symbol (do nothing)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:bin</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p><strong><code>SYM</code>:  merges(t,…):SYM</strong><br>Merge adjacent bins (do nothing: SYMs don’t merge)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SYM:merges</span><span class="hljs-params">(t,...)</span></span> <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <h3 id="num">Num</h3>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  add(num)</strong><br>Add <code>x</code>. If no space, at prob <code>some/n</code>, replace any old number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:add</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> 
    <span class="hljs-built_in">self</span>.n = <span class="hljs-built_in">self</span>.n + <span class="hljs-number">1</span>
    <span class="hljs-keyword">local</span> pos
    <span class="hljs-keyword">if</span> #<span class="hljs-built_in">self</span>.kept &lt; the.Some        <span class="hljs-keyword">then</span> pos= (#<span class="hljs-built_in">self</span>.kept)+<span class="hljs-number">1</span> 
    <span class="hljs-keyword">elseif</span> rand() &lt; the.Some/<span class="hljs-built_in">self</span>.n <span class="hljs-keyword">then</span> pos= rand(#<span class="hljs-built_in">self</span>.kept) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">then</span> 
      <span class="hljs-built_in">self</span>.ok=<span class="hljs-literal">false</span>  <span class="hljs-comment">-- the `kept` list is no longer in sorted order</span>
      <span class="hljs-built_in">self</span>.kept[pos]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <h4 id="query">Query</h4>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  has()</strong><br>Return <code>kept</code>, ensuring it is sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:has</span><span class="hljs-params">()</span></span>
  <span class="hljs-built_in">self</span>.kept = <span class="hljs-built_in">self</span>.ok <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.kept <span class="hljs-keyword">or</span> <span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.kept)
  <span class="hljs-built_in">self</span>.ok = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.kept <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  mid():num</strong><br>Return <code>mid</code>dle (median) number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> per(<span class="hljs-built_in">self</span>:has(),<span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  div():num</strong><br>Return <code>div</code>ersity of numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:div</span><span class="hljs-params">(  a)</span></span> a=<span class="hljs-built_in">self</span>:has(); <span class="hljs-keyword">return</span> (per(a,<span class="hljs-number">.9</span>)-per(a,<span class="hljs-number">.1</span>))/<span class="hljs-number">2.56</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  norm(x):num</strong><br>Normalize x,y to 0..1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:norm</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">local</span> a =  <span class="hljs-built_in">self</span>:has()
  <span class="hljs-keyword">local</span> lo,hi = a[<span class="hljs-number">1</span>], a[#a]
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(hi-lo)&lt;<span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x-lo)/(hi-lo+<span class="hljs-number">1</span>/big) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  dist(x,y):num</strong><br>Normalize x,y to 0..1, report their difference.
If any unknowns, assume max distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:dist</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-keyword">if</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">elseif</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> y=<span class="hljs-built_in">self</span>:norm(y); x=y&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> x=<span class="hljs-built_in">self</span>:norm(x); y=x&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span>   x,y = <span class="hljs-built_in">self</span>:norm(x), <span class="hljs-built_in">self</span>:norm(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <h4 id="discretization">Discretization</h4>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  bin(any):any</strong><br>Discretize a num to one of <code>the.bins</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:bin</span><span class="hljs-params">(x)</span></span>
  <span class="hljs-keyword">local</span> a = <span class="hljs-built_in">self</span>:has()
  <span class="hljs-keyword">local</span> lo,hi = a[<span class="hljs-number">1</span>], a[#a]
  <span class="hljs-keyword">local</span> b = (hi - lo)/the.bins
  <span class="hljs-keyword">return</span> hi==lo <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">.5</span>)*b <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><strong><code>NUM</code>:  merges([BIN],…) :[BIN]</strong><br>Prune superflous bins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NUM:merges</span><span class="hljs-params">(b4, min)</span></span> 
  <span class="hljs-keyword">local</span> n,now = <span class="hljs-number">1</span>,{}
  <span class="hljs-keyword">while</span> n &lt;= #b4 <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> merged = n&lt;#b4 <span class="hljs-keyword">and</span> b4[n]:merged(b4[n+<span class="hljs-number">1</span>],<span class="hljs-built_in">min</span>) <span class="hljs-comment">-- defined in BIN</span>
    now[#now+<span class="hljs-number">1</span>]  = merged <span class="hljs-keyword">or</span> b4[n]
    n            = n + (merged <span class="hljs-keyword">and</span> <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">-- if merged, skip over merged bin</span>
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-- end while</span>
  <span class="hljs-keyword">if</span> #now &lt; #b4 <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:merges(now,<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span>     <span class="hljs-comment">-- seek others to merge</span>
  bins[<span class="hljs-number">1</span>].lo,bins[#bins].hi = -big,big            <span class="hljs-comment">-- grow to plus/minus infinity</span>
  <span class="hljs-keyword">return</span> bins <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <h2 id="data">Data</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h3 id="cols">COLS</h3>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  add(ROW)</strong><br>update the non-skipped columns with values from ROW</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:add</span><span class="hljs-params">(row)</span></span>
  <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{<span class="hljs-built_in">self</span>.x, <span class="hljs-built_in">self</span>.y} <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> col:add(row.cells[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <h4 id="distance">Distance</h4>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  dist(ROW,ROW) :num</strong><br>Using <code>x</code> columns, compute distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:dist</span><span class="hljs-params">(r1,r2)</span></span>
  <span class="hljs-keyword">local</span> d,x1,x2 = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.x) <span class="hljs-keyword">do</span> 
    x1 = r1.cells[col.at]
    x2 = r2.cells[col.at]
    d  = d+(col:dist(x1,x2))^the.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/#<span class="hljs-built_in">self</span>.x)^(<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>To avoid outliers only look so <code>Far</code> down the list of neighbors
(sorted by distance to <code>r1</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:far</span><span class="hljs-params">(r1, rows)</span></span>
  <span class="hljs-keyword">local</span> tmp = map(rows, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r2)</span></span> <span class="hljs-keyword">return</span> {r=r2, d=<span class="hljs-built_in">self</span>:dist(r1,r2)} <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">return</span> per(<span class="hljs-built_in">sort</span>(tmp, lt<span class="hljs-string">&quot;d&quot;</span>), the.Far).r <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  half([ROW])</strong><br>Divide <code>rows</code> by their distance to two distant points.
Find two distant points A,B using a random projections. The half of the
the rows nearest <code>A</code> are returned as <code>As</code> (ditto with <code>B</code> and <code>Bs</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:half</span><span class="hljs-params">(rows,   b4)</span></span>
  <span class="hljs-keyword">local</span> As,Bs= {},{}
  <span class="hljs-keyword">local</span> some = many(rows, the.Some)
  <span class="hljs-keyword">local</span> A    = b4 <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>:far(any(some), some)
  <span class="hljs-keyword">local</span> B    = <span class="hljs-built_in">self</span>:far(A, some)
  <span class="hljs-keyword">local</span> c    = <span class="hljs-built_in">self</span>:dist(A,B) 
  rows       = map(rows, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row,     a,b)</span></span> 
                           a,b = <span class="hljs-built_in">self</span>:dist(row,A), <span class="hljs-built_in">self</span>:dist(row,B) 
                           <span class="hljs-keyword">return</span> {r= row, x= (a^<span class="hljs-number">2</span> + c^<span class="hljs-number">2</span> - b^<span class="hljs-number">2</span>)/(<span class="hljs-number">2</span>*c)} <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">for</span> j,rx <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">sort</span>(rows,lt<span class="hljs-string">&quot;x&quot;</span>)) <span class="hljs-keyword">do</span> push(j&lt;#rows/<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> As <span class="hljs-keyword">or</span> Bs, rx.r) <span class="hljs-keyword">end</span>  
  <span class="hljs-keyword">return</span> {A=A, B=B, As=As, Bs=Bs, c=c}  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <h4 id="optimize">Optimize</h4>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  best(ROW,ROW) :bool</strong><br>True if better on multi-objectives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:best</span><span class="hljs-params">(r1,r2)</span></span>
  r1.evaled, r2.evaled = <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>
  <span class="hljs-keyword">local</span> s1, s2, ys, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>.y, <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ys) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> x = col:norm(r1.cells[col.at])
    <span class="hljs-keyword">local</span> y = col:norm(r2.cells[col.at])
    s1      = s1 - e^(col.w * (x-y)/#ys)
    s2      = s2 - e^(col.w * (y-x)/#ys) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> s1/#ys &lt; s2/#ys <span class="hljs-keyword">end</span> <span class="hljs-comment">-- i.e. we lose less going to r2-&gt;r1 than r2-&gt;r1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p><strong><code>COLS</code>:  bests([ROW]):bests=[ROW],rests=[ROW]</strong><br>Recursively apply <code>best</code>.
Returns <code>bests</code> and everything else as <code>rest</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COLS:bests</span><span class="hljs-params">(rows,    b4,stop,rests)</span></span>
  rests = rests <span class="hljs-keyword">or</span> {}
  stop  = stop <span class="hljs-keyword">or</span> (#rows)^the.<span class="hljs-built_in">min</span>
  <span class="hljs-keyword">if</span> #rows &lt; stop <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows,rests <span class="hljs-keyword">end</span> <span class="hljs-comment">-- return best=[ROW],rests=[ROW] </span>
  <span class="hljs-keyword">local</span> two = <span class="hljs-built_in">self</span>:half(rows,b4) <span class="hljs-comment">-- if b4 supplied, then half will use it as one pole.</span>
  <span class="hljs-keyword">local</span> best, bests, rests1
  <span class="hljs-keyword">if</span>   <span class="hljs-built_in">self</span>:best(two.A, two.B) 
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">write</span>(<span class="hljs-string">&quot;.&quot;</span>)
       best, bests, rests1 = two.A, two.As, two.Bs
       <span class="hljs-keyword">for</span> _,rest1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rev(rests1)) <span class="hljs-keyword">do</span> push(rests,rest1) <span class="hljs-keyword">end</span> <span class="hljs-comment">--sort L to R, worst to better</span>
  <span class="hljs-keyword">else</span> <span class="hljs-built_in">io</span>.<span class="hljs-built_in">write</span>(<span class="hljs-string">&quot;-&quot;</span>)
       best, bests, rests1 = two.B, two.Bs, two.As
       <span class="hljs-keyword">for</span> _,rest1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rests1) <span class="hljs-keyword">do</span> push(rests,rest1) <span class="hljs-keyword">end</span> <span class="hljs-comment">--sort L to R, worst to better</span>
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:bests(bests, best, stop, rests) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <h2 id="cols">COLS</h2>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <h3 id="bins">BINS</h3>

            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <h4 id="create">Create</h4>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <p><strong><code>BIN</code>:  merged(BIN, num)</strong><br>Combine two bins if we should or can do so.
“Should” is true if either is too small.<br>“Can” is true of the whole is simpler than the parts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:merged</span><span class="hljs-params">(j, min)</span></span>
  <span class="hljs-keyword">local</span> a, b, c = <span class="hljs-built_in">self</span>.has, j.has, <span class="hljs-built_in">self</span>.has:merge(j.has)
  <span class="hljs-keyword">local</span> should = a.n &lt; <span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> b.n &lt; <span class="hljs-built_in">min</span>                 
  <span class="hljs-keyword">local</span> can    = c:div() &lt;= (a.n*a:div() + b.n*b:div())/c.n 
  <span class="hljs-keyword">if</span> should <span class="hljs-keyword">or</span> can <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> BIN(a.col,<span class="hljs-built_in">self</span>.lo, j.hi, c) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <h4 id="update">Update</h4>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <p><strong><code>BIN</code>:  add(num,sym)</strong><br>extend <code>lo,hi</code> to cover <code>x</code>; remember we saw `y.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:add</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-built_in">self</span>.lo = <span class="hljs-built_in">min</span>(x,<span class="hljs-built_in">self</span>.lo)
  <span class="hljs-built_in">self</span>.hi = <span class="hljs-built_in">max</span>(x,<span class="hljs-built_in">self</span>.hi)
  <span class="hljs-built_in">self</span>:has(y) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <h4 id="query">Query</h4>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <p><strong><code>BIN</code>:  show()</strong><br>pretty print the range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:show</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">local</span> x,lo,hi = <span class="hljs-built_in">self</span>.ys.txt, <span class="hljs-built_in">self</span>.lo, <span class="hljs-built_in">self</span>.hi
  <span class="hljs-keyword">if</span>     lo ==  hi  <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s == %s&quot;</span>, x, lo)
  <span class="hljs-keyword">elseif</span> hi ==  big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &gt;  %s&quot;</span>, x, lo)
  <span class="hljs-keyword">elseif</span> lo == -big <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;= %s&quot;</span>, x, hi)
  <span class="hljs-keyword">else</span>                   <span class="hljs-keyword">return</span> fmt(<span class="hljs-string">&quot;%s &lt;  %s &lt;= %s&quot;</span>, lo,x,hi) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p><strong><code>BIN</code>:  selects([ROW]):[ROW]</strong><br>Returns rows that fall within this BIN.
Returns nil if the subset is same size as original sets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BIN:selects</span><span class="hljs-params">(rows,    select,tmp)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">select</span><span class="hljs-params">(row,  v)</span></span>
    v= row.cells[<span class="hljs-built_in">self</span>.col.at]
    <span class="hljs-keyword">if</span> v==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.lo==<span class="hljs-built_in">self</span>.hi <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.lo&lt;v <span class="hljs-keyword">and</span> v &lt;=<span class="hljs-built_in">self</span>.hu <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> row <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  tmp= map(rows,<span class="hljs-built_in">select</span>) 
  <span class="hljs-keyword">if</span> #tmp &lt; #rows <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> rows <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <h4 id="rows">ROWS</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:clone</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> ROWS():add(<span class="hljs-built_in">self</span>.cols.names):adds(t <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:file</span><span class="hljs-params">(x)</span></span>  csv(x,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span></span> <span class="hljs-built_in">self</span>:add(t) <span class="hljs-keyword">end</span>); <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:adds</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">for</span> _,t1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(t1) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:add</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-keyword">if</span>   <span class="hljs-built_in">self</span>.cols 
  <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.cols:add(push(<span class="hljs-built_in">self</span>.rows, t.cells <span class="hljs-keyword">and</span> t <span class="hljs-keyword">or</span> ROW(t))) 
  <span class="hljs-keyword">else</span> <span class="hljs-built_in">self</span>.cols=COLS(t) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              <p>ROWS:mids(?int=2,?[COL]=self.cols.y):[key=num] – Return <code>mid</code> of columns
rounded to <code>p</code> places.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:mid</span><span class="hljs-params">(p,cols)</span></span> 
  <span class="hljs-keyword">local</span> t={n=#<span class="hljs-built_in">self</span>.rows}
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.cols.y) <span class="hljs-keyword">do</span> t[col.txt]=col:mid(p) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> rnds(t,p <span class="hljs-keyword">or</span> <span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:splitter</span><span class="hljs-params">(rows)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">split</span><span class="hljs-params">(col)</span></span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> v = row.cells[col.at]
      <span class="hljs-keyword">if</span> v ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
        n=n+<span class="hljs-number">1</span>
        <span class="hljs-keyword">local</span> pos = col:bin(v)
        dict[pos] = dict[pos] <span class="hljs-keyword">or</span> push(list, BIN(col,v))
        dict[pos]:add(v,row.label) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    list = col:merges(<span class="hljs-built_in">sort</span>(list,lt<span class="hljs-string">&quot;lo&quot;</span>), n^the.<span class="hljs-built_in">min</span>)
    <span class="hljs-keyword">return</span> {bins = list,
            div  = sum(list,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> z.has:div()*z.ys.n/n <span class="hljs-keyword">end</span>)} 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">---------------------------------------------------</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(map(<span class="hljs-built_in">self</span>.cols.x, split),lt<span class="hljs-string">&quot;div&quot;</span>)[<span class="hljs-number">1</span>].bin <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:tree</span><span class="hljs-params">()</span></span>
  <span class="hljs-keyword">local</span> bests,rests= <span class="hljs-built_in">self</span>.cols:bests(<span class="hljs-built_in">self</span>.rows)
  <span class="hljs-keyword">local</span> rows={}
  <span class="hljs-keyword">for</span> _,best <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(bests) <span class="hljs-keyword">do</span> push(rows,    best).label=<span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>,the.rests*#bests <span class="hljs-keyword">do</span> push(rows,rests[i]).label=<span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">self</span>:grow(rows, (#rows)^the.<span class="hljs-built_in">min</span>) 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ROWS:grow</span><span class="hljs-params">(rows,stop,when)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">kid</span><span class="hljs-params">(bin)</span></span>
    <span class="hljs-keyword">local</span> t = bin:selects(rows)
    <span class="hljs-keyword">if</span> t <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:clone(t):grow(t,stop,bin) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-built_in">self</span>.when=when
  <span class="hljs-keyword">if</span> #rows &lt; stop <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">self</span>.kids = map(<span class="hljs-built_in">self</span>:splitter(rows), kid) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <h2 id="start-up">Start-up</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>


help:<span class="hljs-built_in">gsub</span>(<span class="hljs-string">&quot;\n [-]%S[%s]+([%S]+)[^\n]+= ([%S]+)&quot;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,x)</span></span> the[k]=coerce(x)<span class="hljs-keyword">end</span>) 

<span class="hljs-keyword">return</span> {the=the, help=help, 
        ROWS=ROWS, ROW=ROW, COLS=COLS, NUM=NUM, SYM=SYM, BIN=BIN}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
