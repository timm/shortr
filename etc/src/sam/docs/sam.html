<!DOCTYPE html>

<html>
<head>
  <title>sam.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>sam.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">require</span><span class="hljs-string">&quot;lib&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>the={ <span class="hljs-built_in">min</span>  = <span class="hljs-number">.5</span>,
      bins = <span class="hljs-number">16</span>,
      some = <span class="hljs-number">256</span>, 
      seed = <span class="hljs-number">10019</span>,
      file = <span class="hljs-string">&quot;../../../data/auto93.csv&quot;</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>data model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goalp</span><span class="hljs-params">(x)</span></span>  <span class="hljs-keyword">return</span> (x <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]$&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nump</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> (x <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">klassp</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> (x <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span>  <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skip</span><span class="hljs-params">(x)</span></span>   <span class="hljs-keyword">return</span> (x <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span>  <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">weight</span><span class="hljs-params">(x)</span></span> <span class="hljs-keyword">return</span> (x <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>col create</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">col</span><span class="hljs-params">(at,txt)</span></span>
  <span class="hljs-keyword">return</span> {n   = <span class="hljs-number">0</span>, 
          at  = at  <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,
          txt = txt <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, 
          w   = weight(txt), 
          ok  = <span class="hljs-literal">false</span>,
          <span class="hljs-built_in">log</span> = {},
          div = <span class="hljs-number">0</span>, 
          mid = <span class="hljs-number">0</span>
          } <span class="hljs-keyword">end</span> 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num</span><span class="hljs-params">(at,txt)</span></span>
   <span class="hljs-keyword">local</span> i = col(at,txt)
   i.nump  = <span class="hljs-literal">true</span>
   i.w     = i.txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
   i.lo    =  big
   i.hi    = -big 
   <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>col update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cell</span><span class="hljs-params">(i,v,r)</span></span>
 r = r <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
 <span class="hljs-keyword">if</span>   v ~= <span class="hljs-string">&quot;?&quot;</span>
 <span class="hljs-keyword">then</span> i.n = i.n + r
      <span class="hljs-keyword">if</span> i.nump 
      <span class="hljs-keyword">then</span> i.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(v, i.lo)
           i.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(v, i.hi)
           <span class="hljs-keyword">if</span>     #i.<span class="hljs-built_in">log</span> &lt; the.some     <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; push(i.<span class="hljs-built_in">log</span>,v) 
           <span class="hljs-keyword">elseif</span> R()    &lt; the.some/i.n <span class="hljs-keyword">then</span> i.ok=<span class="hljs-literal">false</span>; i.<span class="hljs-built_in">log</span>[ R(#i.<span class="hljs-built_in">log</span>) ]=v <span class="hljs-keyword">end</span> 
      <span class="hljs-keyword">else</span> r = r <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
           i.ok = <span class="hljs-literal">false</span>
           i.<span class="hljs-built_in">log</span>[v] = r + (i.<span class="hljs-built_in">log</span>[v] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ok</span><span class="hljs-params">(i)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.ok <span class="hljs-keyword">then</span> 
    i.div, i.mid = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span>   i.nump 
    <span class="hljs-keyword">then</span> i.<span class="hljs-built_in">log</span> = <span class="hljs-built_in">sort</span>(i.<span class="hljs-built_in">log</span>)
         i.mid = per(i.<span class="hljs-built_in">log</span>, <span class="hljs-number">.5</span>)
         i.div = (per(i.<span class="hljs-built_in">log</span>, <span class="hljs-number">.9</span>) - per(i.<span class="hljs-built_in">log</span>, <span class="hljs-number">.1</span>)) / <span class="hljs-number">2.56</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">local</span> most = <span class="hljs-number">-1</span>
         <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.<span class="hljs-built_in">log</span>) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> v&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> 
           <span class="hljs-keyword">if</span> n &gt; most <span class="hljs-keyword">then</span> most, i.mid = n, x <span class="hljs-keyword">end</span>
           i.div = i.div - n/i.n * <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>( n/i.n, <span class="hljs-number">2</span>) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  i.ok = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>col query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">norm</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">return</span> i.hi - i.lo &lt; <span class="hljs-number">1E-9</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (x-i.lo)/(i.hi-i.lo) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>data create</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">data</span><span class="hljs-params">(names)</span></span>
  <span class="hljs-keyword">local</span> i={x={}, y={}, xy={}, names=names,klass=<span class="hljs-literal">nil</span>}
  <span class="hljs-keyword">for</span> at,txt <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(names) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">local</span> new = txt:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]&quot;</span> <span class="hljs-keyword">and</span> num(at,txt) <span class="hljs-keyword">or</span> col(at,txt)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> skip(txt) <span class="hljs-keyword">then</span>
      push(goalp(txt) <span class="hljs-keyword">and</span> i.y <span class="hljs-keyword">or</span> i.x, new)
      <span class="hljs-keyword">if</span> klassp(txt) <span class="hljs-keyword">then</span> i.klass=new <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rows</span><span class="hljs-params">(src)</span></span>
  <span class="hljs-keyword">local</span> i
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">for</span>  _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src) <span class="hljs-keyword">do</span> i=row(t,i) <span class="hljs-keyword">end</span>
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span>    t <span class="hljs-keyword">in</span> csv(src)   <span class="hljs-keyword">do</span> i=row(t,i) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> i <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone</span><span class="hljs-params">(i,inits,   j)</span></span>
  j=row(i.names); <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(inits <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span>  j=row(t,j) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> j <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">row</span><span class="hljs-params">(t,i)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> data(t) <span class="hljs-keyword">end</span>
  push(i.xy, t)
  <span class="hljs-keyword">for</span> _,cols <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{i.x, i.y} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(cols) <span class="hljs-keyword">do</span> cell(c, t[c.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>data query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">div</span><span class="hljs-params">(i)</span></span>     <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.ok <span class="hljs-keyword">then</span> ok(i) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> i.div <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mid</span><span class="hljs-params">(i)</span></span>     <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> i.ok <span class="hljs-keyword">then</span> ok(i) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> i.mid <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mids</span><span class="hljs-params">(i, t)</span></span> t={};<span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.y) <span class="hljs-keyword">do</span> t[c.txt]=mid(c)<span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">divs</span><span class="hljs-params">(i, t)</span></span> t={};<span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.y) <span class="hljs-keyword">do</span> t[c.txt]=div(c)<span class="hljs-keyword">end</span>;<span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bin</span><span class="hljs-params">(i,x)</span></span>
  <span class="hljs-keyword">if</span>   i.nump 
  <span class="hljs-keyword">then</span> b=(i.hi - i.lo)/the.bins; <span class="hljs-keyword">return</span> i.lo==i.hi <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(x/b+<span class="hljs-number">.5</span>)*b 
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>row sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">orders</span><span class="hljs-params">(i,t)</span></span> 
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">first</span><span class="hljs-params">(t1,t2)</span></span> 
    <span class="hljs-keyword">local</span> s1, s2, n, e = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, #i.y, <span class="hljs-built_in">math</span>.<span class="hljs-built_in">exp</span>(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> _,c <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.y) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> x,y = norm(c, t1[c.at]), norm(c, t2[c.at])
      s1 = s1 - e^(c.w * (x-y)/n)
      s2 = s2 - e^(c.w * (y-x)/n) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> s1/n &lt; s2/n 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">----------------</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">sort</span>(t, first) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>discretization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ranges</span><span class="hljs-params">(listOfRows,xcol,yklass,y)</span></span>
  <span class="hljs-keyword">local</span> n,list, dict = <span class="hljs-number">0</span>,{}, {}
  <span class="hljs-keyword">for</span> label,rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(listOfRows) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> v = row[xcol.at]
      <span class="hljs-keyword">if</span> v ~= <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
        n = n + <span class="hljs-number">1</span>
        <span class="hljs-keyword">local</span> pos = bin(v)
        dict[pos] = dict[pos] <span class="hljs-keyword">or</span> push(list, {lo=v,hi=v,ys=col(xcol.at, xcol.txt)})
        dict[pos].lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(v, dict[pos].lo)
        dict[pos].hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(v, dict[pos].hi)
        cell(dict[pos].ys, label)  <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>  <span class="hljs-keyword">end</span>
    list = <span class="hljs-built_in">sort</span>(list, lt<span class="hljs-string">&quot;lo&quot;</span>)
    list = xcol.nump <span class="hljs-keyword">and</span> _xpand(_merges(list, n^the.<span class="hljs-built_in">min</span>)) <span class="hljs-keyword">or</span> list
    <span class="hljs-keyword">return</span> {ranges= list,
            div   = sum(list,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(z)</span></span> <span class="hljs-keyword">return</span> div(z.ys)*z.ys.n/n <span class="hljs-keyword">end</span>)} <span class="hljs-keyword">end</span>
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(i,j, min)</span></span>
  <span class="hljs-keyword">local</span> k = col(i.at, i.txt)
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(i.ys.<span class="hljs-built_in">log</span>) <span class="hljs-keyword">do</span> cell(k,x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> x,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(j.ys.<span class="hljs-built_in">log</span>) <span class="hljs-keyword">do</span> cell(k,x,n) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> i.n&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> j.n&lt;<span class="hljs-built_in">min</span> <span class="hljs-keyword">or</span> div(k) &lt;= (i.n*div(i) + j.n*div(j)) / k.n <span class="hljs-keyword">then</span> 
    <span class="hljs-keyword">return</span> {lo=i.lo, hi=j.hi, ys=k} <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_merges</span><span class="hljs-params">(b4, min)</span></span>
  <span class="hljs-keyword">local</span> j,now = <span class="hljs-number">1</span>,{}
  <span class="hljs-keyword">while</span> j &lt;= #b4 <span class="hljs-keyword">do</span> 
    <span class="hljs-keyword">local</span> merged
    <span class="hljs-keyword">if</span> j&lt;#b4 <span class="hljs-keyword">then</span> merged = merge(b4[j], b4[j+<span class="hljs-number">1</span>], <span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span>
    now[#now+<span class="hljs-number">1</span>] = merged <span class="hljs-keyword">and</span> merged <span class="hljs-keyword">or</span> b4[j] 
    j           = j + (merged <span class="hljs-keyword">and</span> <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">end</span><span class="hljs-comment">-- skip to next and next if we found a merge</span>
  <span class="hljs-keyword">return</span> #now == #b4 <span class="hljs-keyword">and</span> now <span class="hljs-keyword">or</span> _merges(now,<span class="hljs-built_in">min</span>) <span class="hljs-keyword">end</span> <span class="hljs-comment">-- hunt for more merges</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_xpand</span><span class="hljs-params">(ranges)</span></span>
  <span class="hljs-keyword">for</span> j=<span class="hljs-number">2</span>,#ranges <span class="hljs-keyword">do</span> ranges[j].lo = ranges[j<span class="hljs-number">-1</span>].hi <span class="hljs-keyword">end</span>
  ranges[<span class="hljs-number">1</span>].lo, ranges[#t].hi = -big, big
  <span class="hljs-keyword">return</span> ranges <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>test suite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>go,no = {},{}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.the</span><span class="hljs-params">()</span></span> oo(the) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.rows</span><span class="hljs-params">(  i)</span></span>
  i=rows(the.file) 
  oo(i.x[<span class="hljs-number">1</span>]) <span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.stats</span><span class="hljs-params">()</span></span> 
  oo(summarize(rows(the.file) )) 
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go.order</span><span class="hljs-params">(  i,t)</span></span> 
  i= rows(the.file)
  t= orders(i, i.xy)
  left = clone(i,splice(i.xy,<span class="hljs-number">1</span>,<span class="hljs-number">30</span>))
  right= clone(i,splice(i.xy,<span class="hljs-number">360</span>))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;first&quot;</span>,o(mids(left)))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;last&quot;</span>, o(mids(right)))
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;all&quot;</span>,  o(mids(i)))
  <span class="hljs-keyword">end</span> 

<span class="hljs-built_in">math</span>.<span class="hljs-built_in">randomseed</span>(the.seed)
<span class="hljs-keyword">if</span> <span class="hljs-built_in">arg</span>[<span class="hljs-number">1</span>]==<span class="hljs-string">&quot;-g&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(go[<span class="hljs-built_in">arg</span>[<span class="hljs-number">2</span>]])==<span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span> go[<span class="hljs-built_in">arg</span>[<span class="hljs-number">2</span>]]() <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
